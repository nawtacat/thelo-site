<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dashboardTitle">Thelo Student Dashboard</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --thelo-blue: #2563EB;
            --thelo-bg: #F8F9FA; /* This is the base background for the grid itself */
            --thelo-text: #111827;
            --grid-color: #E5E7EB;
            --card-hover-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Stronger hover shadow */
        }

        html {
            scroll-behavior: smooth;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        body {
            font-family: 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--thelo-bg);
            color: var(--thelo-text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* The signature grid background directly on the body */
            background-image:
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0; /* Ensure no default body padding */
            margin: 0; /* Ensure no default body margin */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Language-specific font rules */
        html[lang="en"] body {
            font-family: 'Manrope', sans-serif;
        }
        html[lang="hy"] body {
            font-family: "Noto Serif Armenian", serif;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 800; /* Bolder Manrope */
        }
        html[lang="hy"] h1, 
        html[lang="hy"] h2, 
        html[lang="hy"] h3, 
        html[lang="hy"] h4, 
        html[lang="hy"] h5, 
        html[lang="hy"] h6 {
            font-weight: 700; /* Bolder Noto Serif Armenian */
        }

        /* Header (Minimalist and Transparent) */
        header {
            background-color: transparent; /* No white box on navbar */
            backdrop-filter: none; /* No blur */
            border-bottom: none; /* No border */
            padding: 1.5rem 2.5rem; /* Enhanced padding from borders */
            display: flex;
            justify-content: space-between; /* Space out logo and right section */
            align-items: center;
            width: 100%;
            z-index: 10; /* Ensure it stays on top */
            position: relative;
        }
        
        /* Main Content Area */
        main {
            flex-grow: 1;
            padding: 3rem 2.5rem; /* Enhanced overall padding for main content */
            max-width: 1400px; /* Wider content area */
            margin: 0 auto; /* Center content */
            overflow-x: hidden; /* Ensure main content does not cause horizontal scroll */
        }
        section {
            margin-bottom: 4.5rem; /* More space between sections */
        }

        /* Card Style (for Progress, Notebook, Quick Practice) */
        .card {
            background-color: white; /* White background for individual cards */
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 2rem; /* Increased padding within cards */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Add transition for hover */
        }

        .card:hover {
            transform: translateY(-5px); /* Lift card on hover */
            box-shadow: var(--card-hover-shadow); /* Stronger shadow on hover */
        }

        /* Primary Button Style */
        .thelo-btn {
            background-color: var(--thelo-blue);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .thelo-btn:hover {
            background-color: #1a56d2;
            transform: translateY(-2px);
        }

        /* Secondary Button Style */
        .thelo-btn-secondary {
            background-color: transparent;
            color: var(--thelo-blue);
            border: 1px solid var(--thelo-blue);
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .thelo-btn-secondary:hover {
            background-color: var(--thelo-blue);
            color: white;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: var(--grid-color);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 10px;
            background-color: var(--thelo-blue);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
        }

        /* Lesson Card specific styles */
        .lesson-card-item {
            background-color: white; /* Individual white background for lesson cards */
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .lesson-card-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }
        .lesson-card-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--grid-color);
        }
        .lesson-card-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .lesson-card-progress {
            margin-top: 0.75rem;
        }

        /* Horizontal scroll for Continue Learning */
        .horizontal-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 1rem; /* Space for scrollbar if it appears */
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll-content {
            display: flex;
            gap: 1.5rem;
            padding-bottom: 0; /* Already on parent */
        }
        .horizontal-scroll-item {
            flex: 0 0 280px;
            max-width: 80%; /* Ensure it doesn't get too wide on small screens if content is too large */
        }

        /* Profile Photo in Navbar */
        .profile-photo-nav {
            width: 40px; /* Slightly larger than default settings button */
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .profile-photo-nav:hover {
            border-color: var(--thelo-blue);
            transform: scale(1.05);
        }
        
        /* Specific Styles for Achievements/Encouragement Section */
        .achievement-card {
            background-color: white;
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }
        .achievement-icon {
            font-size: 3rem;
            color: var(--thelo-blue);
            margin-bottom: 1rem;
        }
        .achievement-message {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--thelo-text);
        }
        .achievement-description {
            font-size: 1rem;
            color: #6B7280;
            margin-top: 0.5rem;
        }

        /* Join Class Section */
        .join-class-card {
            background-color: white;
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .join-class-card input {
            margin-bottom: 1rem;
        }

        /* REMOVE macOS style window buttons from the Welcome section heading */
        #welcome-overview::before {
            display: none; /* Hide the tricolor dots */
        }
        #welcome-overview {
            position: relative;
            padding-top: 0; /* Remove extra padding since dots are gone */
        }
        #welcome-overview h2 {
            margin-top: 0; 
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            header {
                padding: 1rem 1.5rem; /* Reduced header padding */
                flex-direction: row; /* Keep as row on mobile for profile photo */
                justify-content: space-between; /* Maintain spacing */
                align-items: center;
            }
            header > div:last-child { /* Targets the div containing profile photo */
                width: auto;
                margin-top: 0;
            }
            main {
                padding: 1.5rem; /* Reduced overall main padding */
            }
            section {
                margin-bottom: 3rem; /* Less space between sections on mobile */
            }
            .card {
                padding: 1.25rem;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            .horizontal-scroll-container {
                padding-left: 0; 
                padding-right: 0; 
            }
            .horizontal-scroll-content {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            .horizontal-scroll-item {
                flex: 0 0 calc(100% - 3rem);
            }
            h2 {
                font-size: 2.25rem;
                margin-bottom: 1.5rem; /* Adjust heading margin */
            }
            h3 {
                font-size: 1.125rem;
            }
            /* Remove specific adjustment for mobile header stats as they are no longer there */
            header .flex:last-child > div:first-child { 
                margin-bottom: 0;
            }

            /* REMOVE macOS dots on welcome section for mobile */
            #welcome-overview::before {
                display: none;
            }
            #welcome-overview {
                padding-top: 0; 
            }
        }
    </style>
</head>
<body class="antialiased">

    <header>
        <div class="flex items-center gap-4">
            <img src="https://thelo.space/img/thelo-Photoroom.png" alt="Thelo logo" class="h-10 w-auto" /> </div>
        <div class="flex items-center gap-4">
            <img id="profile-photo-nav" src="https://via.placeholder.com/150/2563EB/FFFFFF?text=P" alt="Profile Photo" class="profile-photo-nav" title="Profile Settings">
        </div>
    </header>

    <main>
        <section id="welcome-overview" class="mb-12">
            <h2 class="text-3xl lg:text-4xl font-extrabold text-[var(--thelo-text)] mb-8" data-i18n="welcomeGreeting">Good afternoon, <span id="student-name">Student</span>!</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 dashboard-grid"> 
                <div class="card flex flex-col items-start">
                    <h3 class="text-xl font-semibold mb-3" data-i18n="progressSnapshotTitle">Your Overall Progress</h3>
                    <div class="w-full mb-4">
                        <p class="text-sm text-slate-600 mb-2" data-i18n="overallCompletion">Overall Completion: <span id="overall-completion">0%</span></p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="w-full text-sm text-slate-600">
                        <p data-i18n="lessonsStartedCompleted"><span id="lessons-started">0</span> started / <span id="lessons-completed-snapshot">0</span> completed</p>
                        <p class="mt-1" data-i18n="averageScoreStars">Avg. Score: <span id="average-score">0%</span> / Stars: <span id="stars-earned">0</span></p>
                        <p class="mt-1" data-i18n="timeSpent">Time this week: <span id="hours-studied">0</span> minutes</p>
                    </div>
                </div>

                <div class="card flex flex-col justify-between items-start">
                    <div>
                        <h3 class="text-xl font-semibold mb-3" data-i18n="notebookTitle">Your Thelobook</h3>
                        <p class="text-sm text-slate-600 mb-4" data-i18n="notebookDesc">Access and create your personalized handwritten notes and drafts.</p>
                    </div>
                    <button id="open-thelobook-btn" class="thelo-btn-secondary w-full mt-4" data-i18n="openNotebookBtn">
                        <i class="fas fa-book-open mr-2"></i> Open Thelobook
                    </button>
                </div>

                <div class="card flex flex-col justify-between items-start">
                    <div>
                        <h3 class="text-xl font-semibold mb-3" data-i18n="quickPracticeTitle">Quick Practice</h3>
                        <p class="text-sm text-slate-600 mb-4" data-i18n="quickPracticeDesc">Sharpen your skills with a quick set of problems!</p>
                    </div>
                    <button id="quick-practice-btn" class="thelo-btn w-full mt-4" data-i18n="startPracticeBtn">
                        <i class="fas fa-pencil-alt mr-2"></i> Start Practice
                    </button>
                </div>
            </div>
        </section>

        <section id="achievements" class="mb-12">
            <h2 class="text-2xl lg:text-3xl font-extrabold text-[var(--thelo-text)] mb-6" data-i18n="achievementsSectionTitle">Your Journey So Far</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="achievement-card">
                    <i class="fas fa-award achievement-icon"></i>
                    <p class="achievement-message" data-i18n="achievement1Message">You finished 5 lessons!</p>
                    <p class="achievement-description" data-i18n="achievement1Desc">Keep up the great work!</p>
                </div>
                <div class="achievement-card">
                    <i class="fas fa-star achievement-icon"></i>
                    <p class="achievement-message" data-i18n="achievement2Message">You're doing great—keep going!</p>
                    <p class="achievement-description" data-i18n="achievement2Desc">Consistency is key!</p>
                </div>
                <div class="achievement-card">
                    <i class="fas fa-trophy achievement-icon"></i>
                    <p class="achievement-message" data-i18n="achievement3Message">First problem set mastered!</p>
                    <p class="achievement-description" data-i18n="achievement3Desc">On your way to mastery!</p>
                </div>
            </div>
        </section>

        <section id="continue-learning" class="mb-12">
            <h2 class="text-2xl lg:text-3xl font-extrabold text-[var(--thelo-text)] mb-6" data-i18n="continueLearningSectionTitle">Continue Your Learning Adventure</h2>
            <div class="horizontal-scroll-container">
                <div class="horizontal-scroll-content">
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-square-root-alt"></i> 
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle1">Algebra I: Basic Equations</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">70%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 70%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-calculator"></i> 
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle2">Geometry: Area Formulas</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">45%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 45%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-chart-line"></i> 
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle3">Data Analysis: Statistics Basics</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">90%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 90%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-atom"></i> 
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle4">Physics: Kinematics</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">20%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 20%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="explore-lessons" class="mb-12">
            <h2 class="text-2xl lg:text-3xl font-extrabold text-[var(--thelo-text)] mb-6" data-i18n="exploreLessonsSectionTitle">Dive Into New Topics</h2>
            
            <div class="flex flex-col md:flex-row items-center gap-4 mb-8">
                <input type="text" placeholder="Search lessons..." class="flex-grow w-full md:w-auto p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--thelo-blue)]/50" data-i18n="searchPlaceholder">
                <div class="flex flex-wrap justify-center gap-3">
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryAll">All</button>
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryMath">Math</button>
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryLogic">Logic</button>
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryLanguage">Language</button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-infinity"></i> 
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson1Title">Calculus: Limits Introduction</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson1Desc">Understand the fundamental concept of limits in calculus.</p>
                            <p class="text-xs text-slate-500 mt-2" data-i18n="estimatedTime">Est. Time: 15-20 min</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="startLessonBtn">Start Lesson</button>
                        </div>
                    </div>
                </div>

                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-brain"></i> 
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson2Title">Logic Puzzles: Deductive Reasoning</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson2Desc">Solve challenging puzzles using logical deduction.</p>
                            <p class="text-xs text-slate-500 mt-2" data-i18n="estimatedTime">Est. Time: 10-15 min</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="startLessonBtn">Start Lesson</button>
                        </div>
                    </div>
                </div>

                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-language"></i> 
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson3Title">Armenian I: Basic Phrases</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson3Desc">Learn essential Armenian phrases for daily conversation.</p>
                            <p class="text-xs text-slate-500 mt-2" data-i18n="estimatedTime">Est. Time: 5-10 min</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="startLessonBtn">Start Lesson</button>
                        </div>
                    </div>
                </div>
                
                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-square-root-alt"></i> 
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson4Title">Algebra II: Quadratic Equations</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson4Desc">Dive deeper into solving quadratic equations with various methods.</p>
                            <p class="text-xs text-slate-500 mt-2" data-i18n="estimatedTime">Est. Time: 20-30 min</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="startLessonBtn">Start Lesson</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="join-class" class="pb-12"> 
            <div class="join-class-card max-w-lg mx-auto">
                <h3 class="text-xl font-semibold mb-4" data-i18n="joinClassTitle">Join a Class?</h3>
                <p class="text-sm text-slate-600 mb-4" data-i18n="joinClassDesc">If you have a teacher's code, enter it below to join a class.</p>
                <div class="flex flex-col sm:flex-row gap-3 w-full">
                    <input type="text" placeholder="Enter Class Code" class="flex-grow p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--thelo-blue)]/50" data-i18n="classCodePlaceholder">
                    <button class="thelo-btn flex-shrink-0 px-4 py-2 text-sm" data-i18n="joinBtn">Join</button>
                </div>
            </div>
        </section>
        
        <div class="text-center text-sm text-slate-500 mt-12 mb-4">
            <p>Your User ID: <span id="user-id-display" class="font-mono text-slate-700">Loading...</span></p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from environment variables
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const headerStudentNameSpan = document.getElementById('header-student-name');
        const mainStudentNameSpan = document.getElementById('student-name');
        const studentPointsSpan = document.getElementById('student-points');
        const lessonsCompletedCountSpan = document.getElementById('lessons-completed-count');
        const streakCountSpan = document.getElementById('streak-count'); 
        const overallCompletionSpan = document.getElementById('overall-completion');
        const overallProgressBar = document.querySelector('#overall-completion + .progress-bar-container .progress-bar');
        const lessonsStartedSpan = document.getElementById('lessons-started'); 
        const lessonsCompletedSnapshotSpan = document.getElementById('lessons-completed-snapshot'); 
        const averageScoreSpan = document.getElementById('average-score'); 
        const starsEarnedSpan = document.getElementById('stars-earned'); 
        const hoursStudiedSpan = document.getElementById('hours-studied'); 
        const openThelobookBtn = document.getElementById('open-thelobook-btn');
        const quickPracticeBtn = document.getElementById('quick-practice-btn');
        // Removed settingsButton as it's now replaced by profile-photo-nav
        // const settingsButton = document.getElementById('settings-button');
        // Removed langToggle as it's no longer in the HTML
        // const langToggle = document.getElementById('langToggle');
        const profilePhotoNav = document.getElementById('profile-photo-nav'); // New: Profile photo element
        const userIdDisplay = document.getElementById('user-id-display');

        let isAuthReady = false; 

        // --- Internationalization Strings ---
        const strings = {
            en: {
                dashboardTitle: 'Thelo Student Dashboard',
                welcomeGreeting: 'Good afternoon, <span id="student-name">Student</span>!',
                progressSnapshotTitle: 'Your Overall Progress',
                overallCompletion: 'Overall Completion: <span id="overall-completion">0%</span>',
                lessonsStartedCompleted: '<span id="lessons-started">0</span> started / <span id="lessons-completed-snapshot">0</span> completed',
                averageScoreStars: 'Avg. Score: <span id="average-score">0%</span> / Stars: <span id="stars-earned">0</span>',
                timeSpent: 'Time this week: <span id="hours-studied">0</span> minutes',
                notebookTitle: 'Your Thelobook',
                notebookDesc: 'Access and create your personalized handwritten notes and drafts.',
                openNotebookBtn: 'Open Thelobook',
                quickPracticeTitle: 'Quick Practice',
                quickPracticeDesc: 'Sharpen your skills with a quick set of problems!',
                startPracticeBtn: 'Start Practice',
                continueLearningSectionTitle: 'Continue Your Learning Adventure', 
                lessonTitle1: 'Algebra I: Basic Equations',
                lessonTitle2: 'Geometry: Area Formulas',
                lessonTitle3: 'Data Analysis: Statistics Basics',
                lessonTitle4: 'Physics: Kinematics',
                lessonProgress: 'Progress: <span class="font-bold">0%</span>',
                resumeLessonBtn: 'Resume Lesson',
                exploreLessonsSectionTitle: 'Dive Into New Topics', 
                searchPlaceholder: 'Search lessons...',
                categoryAll: 'All',
                categoryMath: 'Math',
                categoryLogic: 'Logic',
                categoryLanguage: 'Language',
                exploreLesson1Title: 'Calculus: Limits Introduction',
                exploreLesson1Desc: 'Understand the fundamental concept of limits in calculus.',
                estimatedTime: 'Est. Time: ',
                exploreLesson2Title: 'Logic Puzzles: Deductive Reasoning',
                exploreLesson2Desc: 'Solve challenging puzzles using logical deduction.',
                exploreLesson3Title: 'Armenian I: Basic Phrases',
                exploreLesson3Desc: 'Learn essential Armenian phrases for daily conversation.',
                exploreLesson4Title: 'Algebra II: Quadratic Equations',
                exploreLesson4Desc: 'Dive deeper into solving quadratic equations with various methods.',
                startLessonBtn: 'Start Lesson',
                achievementsSectionTitle: 'Your Journey So Far', 
                achievement1Message: 'You finished 5 lessons!',
                achievement1Desc: 'Keep up the great work!',
                achievement2Message: 'You\'re doing great—keep going!',
                achievement2Desc: 'Consistency is key!',
                achievement3Message: 'First problem set mastered!',
                achievement3Desc: 'On your way to mastery!',
                joinClassTitle: 'Join a Class?',
                joinClassDesc: 'If you have a teacher\'s code, enter it below to join a class.',
                classCodePlaceholder: 'Enter Class Code',
                joinBtn: 'Join',
                // Removed settingsBtn from strings as it's no longer used for a button
                // settingsBtn: 'Settings'
            },
            hy: {
                dashboardTitle: 'Թելո Ուսանողի Վահանակ',
                welcomeGreeting: 'Բարի կեսօր, <span id="student-name">Ուսանող</span>!',
                progressSnapshotTitle: 'Ձեր Ընդհանուր Առաջընթացը',
                overallCompletion: 'Ընդհանուր Ավարտվածություն: <span id="overall-completion">0%</span>',
                lessonsStartedCompleted: '<span id="lessons-started">0</span> սկսված / <span id="lessons-completed-snapshot">0</span> ավարտված',
                averageScoreStars: 'Միջ. գնահատական: <span id="average-score">0%</span> / Աստղեր: <span id="stars-earned">0</span>',
                timeSpent: 'Ժամանակը այս շաբաթ: <span id="hours-studied">0</span> րոպե',
                notebookTitle: 'Ձեր Թելոգիրքը',
                notebookDesc: 'Մուտք գործեք և ստեղծեք ձեր անձնական ձեռագիր նշումներն ու սևագրերը։',
                openNotebookBtn: 'Բացել Թելոգիրքը',
                quickPracticeTitle: 'Արագ Գործնական Աշխատանք',
                quickPracticeDesc: 'Սրեք ձեր հմտությունները խնդիրների արագ հավաքածուով:',
                startPracticeBtn: 'Սկսել Գործնական Աշխատանքը',
                continueLearningSectionTitle: 'Շարունակեք Ձեր Ուսումնական Արկածը', 
                lessonTitle1: 'Հանրահաշիվ I: Հիմնական Հավասարումներ',
                lessonTitle2: 'Երկրաչափություն: Մակերեսի Բանաձևեր',
                lessonTitle3: 'Տվյալների Վերլուծություն: Վիճակագրության Հիմունքներ',
                lessonTitle4: 'Ֆիզիկա: Կինեմատիկա',
                lessonProgress: 'Առաջընթաց: <span class="font-bold">0%</span>',
                resumeLessonBtn: 'Շարունակել դասը',
                exploreLessonsSectionTitle: 'Սուզվեք Նոր Թեմաների Մեջ', 
                searchPlaceholder: 'Որոնել դասեր...',
                categoryAll: 'Բոլորը',
                categoryMath: 'Մաթեմատիկա',
                categoryLogic: 'Տրամաբանություն',
                categoryLanguage: 'Լեզու',
                exploreLesson1Title: 'Մաթեմատիկական Անալիզ: Սահմանների Ներածություն',
                exploreLesson1Desc: 'Հասկանալ սահմանների հիմնարար հասկացությունը մաթեմատիկական անալիզում։',
                estimatedTime: 'Մոտ. ժամանակը: ',
                exploreLesson2Title: 'Տրամաբանական Խնդիրներ: Դեդուկտիվ Մտածողություն',
                exploreLesson2Desc: 'Լուծել դժվարին խնդիրներ՝ օգտագործելով տրամաբանական դեդուկցիա։',
                exploreLesson3Title: 'Հայերեն I: Հիմնական Արտահայտություններ',
                exploreLesson3Desc: 'Սովորել հայերենի հիմնական արտահայտությունները ամենօրյա խոսակցության համար։',
                exploreLesson4Title: 'Հանրահաշիվ II: Քառակուսի Հավասարումներ',
                exploreLesson4Desc: 'Խորանալ քառակուսի հավասարումների լուծման տարբեր մեթոդների մեջ։',
                startLessonBtn: 'Սկսել դասը',
                achievementsSectionTitle: 'Ձեր Ճանապարհորդությունը մինչ օրս', 
                achievement1Message: 'Դուք ավարտել եք 5 դաս։',
                achievement1Desc: 'Շարունակեք հիանալի աշխատանքը։',
                achievement2Message: 'Դուք հիանալի եք անում. շարունակեք։',
                achievement2Desc: 'Հետևողականությունը կարևոր է։',
                achievement3Message: 'Առաջին խնդրի շարքը յուրացված է։',
                achievement3Desc: 'Միացեք վարպետության ճանապարհին։',
                joinClassTitle: 'Միանա՞լ դասարանին',
                joinClassDesc: 'Եթե ունեք ուսուցչի կոդ, մուտքագրեք այն ներքևում՝ դասարանին միանալու համար։',
                classCodePlaceholder: 'Մուտքագրեք դասի կոդը',
                joinBtn: 'Միանալ',
                // Removed settingsBtn from strings
                // settingsBtn: 'Կարգավորումներ'
            }
        };

        let currentLang = 'en'; 

        function applyLang(lang) {
            document.documentElement.lang = lang;
            const t = strings[lang] || strings.en;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.dataset.i18n;
                if (t[k]) {
                    el.innerHTML = t[k]; 
                }
            });
            
            if (headerStudentNameSpan) headerStudentNameSpan.textContent = headerStudentNameSpan.textContent;
            if (mainStudentNameSpan) mainStudentNameSpan.textContent = mainStudentNameSpan.textContent;
            if (studentPointsSpan) studentPointsSpan.textContent = studentPointsSpan.textContent;
            if (lessonsCompletedCountSpan) lessonsCompletedCountSpan.textContent = lessonsCompletedCountSpan.textContent;
            if (streakCountSpan) streakCountSpan.textContent = streakCountSpan.textContent;
            if (overallCompletionSpan) overallCompletionSpan.textContent = overallCompletionSpan.textContent;
            if (lessonsStartedSpan) lessonsStartedSpan.textContent = lessonsStartedSpan.textContent;
            if (lessonsCompletedSnapshotSpan) lessonsCompletedSnapshotSpan.textContent = lessonsCompletedSnapshotSpan.textContent;
            if (averageScoreSpan) averageScoreSpan.textContent = averageScoreSpan.textContent;
            if (starsEarnedSpan) starsEarnedSpan.textContent = starsEarnedSpan.textContent;
            if (hoursStudiedSpan) hoursStudiedSpan.textContent = hoursStudiedSpan.textContent;

            const searchInput = document.querySelector('input[placeholder="Search lessons..."]');
            if (searchInput) {
                searchInput.placeholder = t.searchPlaceholder || searchInput.placeholder;
            }
            // Language toggle button and settings button are removed, so these lines are no longer needed.
            // if (langToggle) langToggle.textContent = (lang === 'hy') ? 'EN' : 'Հայ';
            // if (settingsButton) settingsButton.title = t.settingsBtn; 
        }

        async function updateDashboard(user) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }

            if (userIdDisplay) userIdDisplay.textContent = user.uid; 

            const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'user_profile', 'profile');
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const userName = userData.name || 'Student';
                    // Header student name is not directly displayed anymore in the simplified header
                    // if (headerStudentNameSpan) headerStudentNameSpan.textContent = userName; 
                    if (mainStudentNameSpan) mainStudentNameSpan.textContent = userName; 

                    const simulatedPoints = Math.floor(Math.random() * 1000) + 100;
                    const simulatedLessonsCompleted = Math.floor(Math.random() * 30) + 5;
                    const simulatedStreak = Math.floor(Math.random() * 10) + 1; 
                    const simulatedOverallProgress = Math.floor(Math.random() * 100); 
                    const simulatedLessonsStarted = simulatedLessonsCompleted + Math.floor(Math.random() * 5); 
                    const simulatedAverageScore = Math.floor(Math.random() * 20) + 70; 
                    const simulatedStarsEarned = Math.floor(Math.random() * 50) + 10;
                    const simulatedMinutesStudied = Math.floor(Math.random() * 120) + 30; 

                    if (studentPointsSpan) studentPointsSpan.textContent = simulatedPoints;
                    if (lessonsCompletedCountSpan) lessonsCompletedCountSpan.textContent = simulatedLessonsCompleted;
                    if (streakCountSpan) streakCountSpan.textContent = simulatedStreak;
                    if (overallCompletionSpan) overallCompletionSpan.textContent = `${simulatedOverallProgress}%`;
                    if (overallProgressBar) overallProgressBar.style.width = `${simulatedOverallProgress}%`;
                    if (lessonsStartedSpan) lessonsStartedSpan.textContent = simulatedLessonsStarted;
                    if (lessonsCompletedSnapshotSpan) lessonsCompletedSnapshotSpan.textContent = simulatedLessonsCompleted;
                    if (averageScoreSpan) averageScoreSpan.textContent = `${simulatedAverageScore}%`;
                    if (starsEarnedSpan) starsEarnedSpan.textContent = simulatedStarsEarned;
                    if (hoursStudiedSpan) hoursStudiedSpan.textContent = simulatedMinutesStudied;

                } else {
                    console.warn("No user profile found for UID:", user.uid);
                    // if (headerStudentNameSpan) headerStudentNameSpan.textContent = 'New Student';
                    if (mainStudentNameSpan) mainStudentNameSpan.textContent = 'New Student';
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                // if (headerStudentNameSpan) headerStudentNameSpan.textContent = 'Student';
                if (mainStudentNameSpan) mainStudentNameSpan.textContent = 'Student';
            }
            applyLang(currentLang);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                if (typeof __initial_auth_token !== 'undefined' && !isAuthReady) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with initial custom token.");
                        await updateDashboard(user); 
                    } catch (error) {
                        console.error("Error signing in with initial custom token:", error);
                        await signInAnonymously(auth); 
                        console.log("Signed in anonymously after custom token failure.");
                        await updateDashboard(auth.currentUser); 
                    }
                } else if (!isAuthReady) {
                    await updateDashboard(user);
                } else if (user.isAnonymous && !isAuthReady) {
                    console.log("User already anonymous. Proceeding to update dashboard.");
                    await updateDashboard(user);
                }
            } else {
                console.log("No user authenticated. Redirecting to login.");
                if (isAuthReady) { 
                    window.location.href = 'index.html'; 
                }
            }
            isAuthReady = true; 
        });

        // Profile photo click functionality (replaces settings button)
        if (profilePhotoNav) {
            profilePhotoNav.addEventListener('click', () => {
                window.location.href = 'https://thelo.space/settings'; 
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            currentLang = params.get('lang') || 'en';
            applyLang(currentLang);

            // Language toggle button is removed, so this event listener is no longer needed.
            // if (langToggle) {
            //     langToggle.addEventListener('click', () => {
            //         currentLang = (currentLang === 'en') ? 'hy' : 'en';
            //         const url = new URL(window.location);
            //         url.searchParams.set('lang', currentLang);
            //         window.history.replaceState({}, '', url); 
            //         applyLang(currentLang);
            //     });
            // }

            if (openThelobookBtn) {
                openThelobookBtn.addEventListener('click', () => {
                    alert('Opening Thelobook!'); 
                });
            }

            if (quickPracticeBtn) {
                quickPracticeBtn.addEventListener('click', () => {
                    alert('Starting Quick Practice!'); 
                });
            }
        });
    </script>
</body>
</html>
