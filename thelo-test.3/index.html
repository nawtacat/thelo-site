<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png">
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">
    <title>thelo | Test Mode</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
    :root {
        --thelo-blue: #2563eb; --thelo-blue-dark: #1d4ed8; --thelo-bg: #ffffff;
        --thelo-text: #111827; --thelo-text-light: #6b7280; --thelo-border: #e5e7eb;
        --success-green: #22c55e; --error-red: #ef4444; --accent-yellow: #f59e0b;
        --bg-white: #ffffff; --ink-black: #000000;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --fade-duration: 0.3s;
    }
    @font-face { font-family: 'Montserrat Arm'; src: url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype'); font-weight: 400; }
    @font-face { font-family: 'Montserrat Arm'; src: url('https://thelo.space/fonts/Montserratarm-SemiBold.otf') format('opentype'); font-weight: 600; }
    @font-face { font-family: 'Montserrat Arm'; src: url('https://thelo.space/fonts/Montserratarm-ExtraBold.otf') format('opentype'); font-weight: 800; }
    body.lang-hy { font-family: 'Montserrat Arm', 'Manrope', system-ui, -apple-system, sans-serif; }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; opacity: 1; transition: opacity 0.5s ease-out; }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    #loading-svg { width: 150px; height: auto; animation: pulse-loader 1.5s infinite ease-in-out; }
    #loading-overlay p { font-weight: 500; margin-top: 1rem; color: var(--thelo-text); }
    @keyframes pulse-loader { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
    html { font-size: 16px; background: var(--thelo-bg); }
    body { margin: 0; height: 100vh; font-family: 'Manrope', system-ui, sans-serif; display: flex; flex-direction: column; overflow: hidden; background-color: var(--thelo-bg); color: var(--thelo-text); user-select: none; -webkit-user-select: none; }
    #app { display: flex; flex-grow: 1; height: 100%; }
    #lessonArea { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden; }
    #boardWrap { position: relative; flex-grow: 1; overflow: hidden; background-color: var(--thelo-bg); background-image: linear-gradient(to right, var(--thelo-border) 1px, transparent 1px), linear-gradient(to bottom, var(--thelo-border) 1px, transparent 1px); background-size: 40px 40px; }
    #backgroundCanvas, #board { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; background-color: transparent; }
    #backgroundCanvas { z-index: 1; pointer-events: none; opacity: 1; transition: opacity var(--fade-duration) ease-in-out; }
    #backgroundCanvas.fade-out { opacity: 0; }
    #board { z-index: 3; cursor: crosshair; touch-action: none; }
    #bottomBar { position: absolute; bottom: 0; left: 0; width: 100%; background-color: transparent; box-sizing: border-box; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 20; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
    #button-group { display: flex; gap: 0.5rem; }
    .control-btn { font-family: inherit; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 500; border: none; border-radius: 0.5rem; color: var(--bg-white); cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-md); touch-action: manipulation; }
    .control-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .control-btn:disabled { background-color: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
    #prevBtn { background-color: #6b7280; }
    #unsureBtn { background-color: var(--accent-yellow); }
    #clearBtn { background-color: var(--error-red); }
    #submitBtn { background-color: var(--thelo-blue); }
    #timerDisplay { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 0.5rem 1.25rem; border-radius: 999px; font-size: 1.2rem; font-weight: 700; color: var(--thelo-text); box-shadow: var(--shadow-md); border: 1px solid var(--thelo-border); }
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background-color: var(--thelo-bg); display: none; flex-direction: column; align-items: center; padding: 2rem; box-sizing: border-box; }
    .screen-container { width: 100%; max-width: 800px; text-align: center; }
    .screen-header { border-bottom: 2px solid var(--thelo-border); padding-bottom: 1rem; margin-bottom: 1.5rem; }
    #resultsScore { font-size: 2.5rem; font-weight: 800; color: var(--thelo-blue); }
    #resultsTime { font-size: 1.2rem; color: var(--thelo-text-light); }
    #navToggleBtn { position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--thelo-blue); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; box-shadow: var(--shadow-lg); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #navPanel { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: #f9fafb; z-index: 1000; box-shadow: var(--shadow-lg); transition: right 0.3s ease-in-out; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; border-left: 1px solid var(--thelo-border); }
    #navPanel.open { right: 0; }
    #navGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; overflow-y: auto; padding: 10px; }
    .nav-item { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 2px solid var(--thelo-border); }
    .nav-item.unanswered { background-color: #e5e7eb; color: #6b7280; }
    .nav-item.answered { background-color: var(--success-green); color: white; border-color: var(--success-green); }
    .nav-item.unsure { background-color: var(--accent-yellow); color: white; border-color: var(--accent-yellow); }
    .nav-item.correct { background-color: var(--success-green); color: white; border-color: var(--success-green); }
    .nav-item.incorrect { background-color: var(--error-red); color: white; border-color: var(--error-red); }
    .nav-item.current { transform: scale(1.1); box-shadow: 0 0 10px var(--thelo-blue); border-color: var(--thelo-blue); }
    #notesPanel { position: fixed; bottom: 90px; right: 20px; width: 300px; height: 40%; background: white; z-index: 1002; box-shadow: var(--shadow-lg); border-radius: 1rem; display: none; flex-direction: column; border: 1px solid var(--thelo-border); }
    #notesPanel.open { display: flex; }
    #notesPanel h4 { margin: 0; padding: 1rem; background-color: #f3f4f6; border-bottom: 1px solid var(--thelo-border); border-radius: 1rem 1rem 0 0;}
    #notesInput { flex-grow: 1; border: none; padding: 1rem; font-family: inherit; font-size: 1rem; resize: none; border-radius: 0 0 1rem 1rem; }
    #notesInput:focus { outline: none; }
    #reviewContainer { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto 1fr; gap: 1rem; width: 100%; max-width: 1200px; height: calc(100vh - 150px); }
    #reviewHeader { grid-column: 1 / -1; }
    #reviewStudentSolution, #reviewCorrectSolution { border: 1px solid var(--thelo-border); border-radius: 0.5rem; padding: 1rem; overflow-y: auto; }
    #reviewStudentSolution h4, #reviewCorrectSolution h4 { margin-top: 0; }
    #reviewStudentDrawing { max-width: 100%; border: 1px solid #ccc; }
    #reviewStudentNotes { background-color: #fefce8; padding: 0.5rem; border-radius: 0.25rem; white-space: pre-wrap; word-wrap: break-word; }
    #reviewNav { position: absolute; bottom: 2rem; width: 100%; display: flex; justify-content: center; gap: 1rem; }
</style>
</head>
<body>
    <div id="loading-overlay">
        <img id="loading-svg" src="https://thelo.space/img/bluethelo.svg" alt="Loading...">
        <p id="loading-text"></p>
    </div>

    <div id="app">
        <div id="lessonArea">
            <div id="boardWrap">
                <canvas id="backgroundCanvas"></canvas>
                <canvas id="board"></canvas>
            </div>
            <div id="bottomBar">
                <div id="timerDisplay">00:00</div>
                <div id="button-group">
                    <button id="prevBtn" class="control-btn" title="Previous Question (←)"></button>
                    <button id="clearBtn" class="control-btn"></button>
                    <button id="unsureBtn" class="control-btn" title="Mark as Unsure (U)"></button>
                    <button id="submitBtn" class="control-btn" title="Next Question (→)"></button>
                </div>
            </div>
        </div>
        
        <button id="navToggleBtn" title="Toggle Problem List">☰</button>
        <div id="navPanel">
            <h3>Problems</h3>
            <div id="navGrid"></div>
        </div>
        
        <div id="notesPanel">
            <h4>My Notes (Toggle with 'A')</h4>
            <textarea id="notesInput" placeholder="Type your notes for this problem here..."></textarea>
        </div>

        <div id="resultsOverviewScreen" class="screen">
            <div class="screen-container">
                <div class="screen-header">
                    <h1 id="resultsHeaderTitle"></h1>
                    <div id="resultsScore"></div>
                    <div id="resultsTime"></div>
                </div>
                <div id="resultsNavGrid" class="nav-grid-results"></div>
                <button id="reviewAnswersBtn" class="control-btn" style="background-color: var(--thelo-blue); margin-top: 2rem;"></button>
            </div>
        </div>

        <div id="reviewScreen" class="screen">
             <div id="reviewContainer">
                <div id="reviewHeader">
                    <h2 id="reviewProblemTitle"></h2>
                </div>
                <div id="reviewStudentSolution">
                    <h4>Your Solution</h4>
                    <img id="reviewStudentDrawing" src="" alt="Your drawing">
                    <h4>Your Notes</h4>
                    <p id="reviewStudentNotes"></p>
                </div>
                <div id="reviewCorrectSolution">
                    <h4>AI Feedback & Correct Answer</h4>
                    <p id="reviewAIFeedback"></p>
                    <p><strong>Correct Answer:</strong> <span id="reviewCorrectAnswer"></span></p>
                </div>
            </div>
            <div id="reviewNav">
                <button id="reviewPrevBtn" class="control-btn">← Previous</button>
                <button id="reviewNextBtn" class="control-btn">Next →</button>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", projectId: "physmathacademy-722b3", messagingSenderId: "1093640992262", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    /* ========== DOM Elements ========== */
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const backgroundCanvas = document.getElementById('backgroundCanvas');
    const canvas = document.getElementById('board');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const lessonArea = document.getElementById('lessonArea');
    const bgCtx = backgroundCanvas.getContext('2d');
    const ctx = canvas.getContext('2d');
    const unsureBtn = document.getElementById('unsureBtn');
    const navToggleBtn = document.getElementById('navToggleBtn');
    const navPanel = document.getElementById('navPanel');
    const navGrid = document.getElementById('navGrid');
    const notesPanel = document.getElementById('notesPanel');
    const notesInput = document.getElementById('notesInput');
    const resultsOverviewScreen = document.getElementById('resultsOverviewScreen');
    const reviewScreen = document.getElementById('reviewScreen');
    const reviewAnswersBtn = document.getElementById('reviewAnswersBtn');
    
    /* ========== State Variables ========== */
    let testData = null;
    let currentStageIndex = 0;
    let drawing = false;
    let isTransitioning = false;
    let devicePixelRatio = window.devicePixelRatio || 1;
    let timerInterval = null;
    let testStartTime = null;
    let testId = null;
    let currentLang = 'en';
    let problemStates = [];

    const UI_TEXT = {
        en: { start: "Start Test", submit: "Next", checking: "Checking...", prev: "Previous", clear: "Clear", testComplete: "Test Complete!", score: "Score:", timeTaken: "Time Taken:", provideSolution: "Please draw a solution before continuing.", question: "Question", aiFeedback: "AI Feedback:", generatingFeedback: "Generating detailed feedback...", analysisError: "Could not submit for analysis.", finishTest: "Finish Test", unsure: "I'm Unsure", reviewAnswers: "Review Answers", analyzing: "Analyzing your answers..." },
        hy: { start: "Սկսել թեստը", submit: "Հաջորդը", checking: "Ստուգվում է...", prev: "Նախորդ", clear: "Մաքրել", testComplete: "Թեստն ավարտված է", score: "Միավոր:", timeTaken: "Ժամանակ:", provideSolution: "Խնդրում ենք լուծումը գրել նոր շարունակել։", question: "Հարց", aiFeedback: "Արհեստական բանականության վերլուծություն:", generatingFeedback: "Ստեղծվում է մանրամասն վերլուծություն...", analysisError: "Չհաջողվեց ուղարկել վերլուծության։", finishTest: "Ավարտել թեստը", unsure: "Վստահ չեմ", reviewAnswers: "Դիտել պատասխանները", analyzing: "Վերլուծվում են պատասխանները..." }
    };

    // KaTeX and drawing utility functions can be placed here (unchanged from previous version)
    let katexCSSInlined = null;
    function abToBase64(ab){ /* ... */ }
    async function getKatexCSSWithEmbeddedFonts(){ /* ... */ }
    async function ensureHeadlineFontsLoaded(){ /* ... */ }
    async function renderComplexHeadline(bgCtx, headline, y, opts = {}){ /* ... */ }
    
    /* ========== Main Application Logic ========== */
    
    function getLocalStorageKey() {
        return `thelo-test-progress-${testId}`;
    }

    function saveStateToLocalStorage() {
        try {
            const stateToSave = {
                currentStageIndex,
                problemStates,
                testStartTime
            };
            localStorage.setItem(getLocalStorageKey(), JSON.stringify(stateToSave));
        } catch (e) {
            console.error("Failed to save state:", e);
        }
    }

    function loadStateFromLocalStorage() {
        try {
            const savedState = localStorage.getItem(getLocalStorageKey());
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                problemStates = parsedState.problemStates || [];
                currentStageIndex = parsedState.currentStageIndex || 0;
                testStartTime = parsedState.testStartTime || null;
                while (problemStates.length < testData.stages.length) {
                    problemStates.push({ status: 'unanswered', drawingDataUrl: null, notes: '' });
                }
                return true;
            }
        } catch (e) {
            console.error("Failed to load state:", e);
            localStorage.removeItem(getLocalStorageKey());
        }
        return false;
    }

    async function loadTest(testJsonPath) {
        testId = new URLSearchParams(window.location.search).get('testFile')?.replace('.json', '');
        isTransitioning = true;
        try {
            const response = await fetch(testJsonPath);
            testData = await response.json();
            
            currentLang = testData.lang === 'hy' ? 'hy' : 'en';
            document.body.className = currentLang === 'hy' ? 'lang-hy' : '';
            document.title = testData.testTitle || "thelo | Test Mode";
            
            if (!loadStateFromLocalStorage()) {
                problemStates = testData.stages.map(() => ({ status: 'unanswered', drawingDataUrl: null, notes: '' }));
                currentStageIndex = 0;
            }
            
            updateAllUITexts();
            renderNavPanel();

            if(testStartTime) {
                timerInterval = setInterval(updateTimerDisplay, 1000);
                transitionToStage(currentStageIndex, true);
            } else {
                 renderStageUI(0);
            }
        } catch (error) {
            console.error("Error loading test:", error);
            alert("Failed to load the test file.");
        } finally {
            isTransitioning = false;
            loadingText.textContent = '';
            loadingOverlay.classList.add('hidden');
        }
    }

    function startTest() {
        if (testStartTime) return;
        testStartTime = Date.now();
        timerInterval = setInterval(updateTimerDisplay, 1000);
        saveStateToLocalStorage();
        transitionToStage(0);
    }
    
    function updateTimerDisplay() {
        if (!testStartTime) return;
        const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    async function renderStageUI(index) {
        currentStageIndex = index;
        const currentProblemState = problemStates[index];
        
        bgCtx.clearRect(0, 0, backgroundCanvas.width, backgroundCanvas.height);
        const headlineText = `${UI_TEXT[currentLang].question} ${index + 1}: ${testData.stages[index].headline || ''}`;
        const baseFont = currentLang === 'hy' ? "Montserrat Arm" : "Manrope";
        bgCtx.font = `24px '${baseFont}', system-ui, sans-serif`;
        // await renderComplexHeadline(bgCtx, headlineText, 65); // Full implementation needed here
        
        clearUserCanvas();
        if (currentProblemState.drawingDataUrl) {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0, canvas.width / devicePixelRatio, canvas.height / devicePixelRatio);
            img.src = currentProblemState.drawingDataUrl;
        }
        
        notesInput.value = currentProblemState.notes;
        updateAllUITexts();
        renderNavPanel();
    }
    
    function transitionToStage(newIndex, isInitialLoad = false) {
        if (isTransitioning || newIndex < 0 || newIndex >= testData.stages.length) return;
        
        if (!isInitialLoad) saveCurrentProblemState();

        isTransitioning = true;
        backgroundCanvas.classList.add('fade-out');
        
        setTimeout(() => {
            renderStageUI(newIndex).then(() => {
                backgroundCanvas.classList.remove('fade-out');
                isTransitioning = false;
            });
        }, 300);
    }

    function saveCurrentProblemState() {
        const hasDrawing = !isCanvasBlank();
        const state = problemStates[currentStageIndex];
        
        if (hasDrawing) {
            state.drawingDataUrl = canvas.toDataURL();
            if (state.status === 'unanswered') state.status = 'answered';
        }
        state.notes = notesInput.value;
        saveStateToLocalStorage();
    }

    function handleNextClick() {
        if (!testStartTime) {
            startTest();
            return;
        }
        if (currentStageIndex < testData.stages.length - 1) {
            transitionToStage(currentStageIndex + 1);
        } else {
            saveCurrentProblemState();
            finishTest();
        }
    }

    async function finishTest() {
        clearInterval(timerInterval);
        loadingText.textContent = UI_TEXT[currentLang].analyzing;
        loadingOverlay.classList.remove('hidden');
        lessonArea.style.display = 'none';

        const timeTaken = Math.floor((Date.now() - testStartTime) / 1000);
        const user = auth.currentUser;
        if (!user) {
            alert("You must be signed in to submit results.");
            return;
        }
        
        const resultsToSubmit = [];
        problemStates.forEach((state, index) => {
            if (state.status !== 'unanswered') {
                resultsToSubmit.push({
                    question: testData.stages[index].headline,
                    correctAnswer: testData.stages[index].correctAnswer,
                    solutionImage: state.drawingDataUrl,
                    initialStatus: state.status, // 'answered' or 'unsure'
                    notes: state.notes
                });
            }
        });

        try {
            const submitTestResults = functions.httpsCallable('submitTestResults');
            const response = await submitTestResults({
                testId: testId,
                totalQuestions: testData.stages.length,
                timeTakenSeconds: timeTaken,
                results: resultsToSubmit,
                language: currentLang
            });

            const resultId = response.data.resultId;
            if (resultId) {
                listenForDetailedFeedback(user.uid, resultId, resultsToSubmit);
            }
        } catch (err) {
            console.error("Error submitting test results:", err);
            alert("There was a problem submitting your test. Please try again.");
            loadingOverlay.classList.add('hidden');
        }
    }
    
    function listenForDetailedFeedback(uid, resultId, submittedResults) {
        const solutionsRef = db.collection('thelo-students').doc(uid).collection('test_results').doc(resultId).collection('solutions');
        let receivedFeedback = [];
        const expectedCount = submittedResults.length;

        const unsubscribe = solutionsRef.onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if ((change.type === "added" || change.type === "modified")) {
                    const data = change.doc.data();
                    if (data.detailedFeedback && !receivedFeedback.some(item => item.docId === change.doc.id)) {
                        receivedFeedback.push({ ...data, docId: change.doc.id });
                    }
                }
            });

            if (receivedFeedback.length >= expectedCount) {
                unsubscribe(); // Stop listening
                renderResultsOverview(receivedFeedback, submittedResults);
                loadingOverlay.classList.add('hidden');
                localStorage.removeItem(getLocalStorageKey());
            }
        });
    }

    function renderResultsOverview(feedbackResults, submittedResults) {
        const texts = UI_TEXT[currentLang];
        const correctAnswers = feedbackResults.filter(r => r.initialStatus === 'correct').length;
        
        document.getElementById('resultsHeaderTitle').textContent = texts.testComplete;
        document.getElementById('resultsScore').textContent = `${texts.score} ${correctAnswers} / ${testData.stages.length}`;
        document.getElementById('resultsTime').textContent = `${texts.timeTaken} ${timerDisplay.textContent}`;
        
        const resultsNavGrid = document.getElementById('resultsNavGrid');
        resultsNavGrid.innerHTML = '';
        
        const allResults = testData.stages.map((stage, index) => {
            const submitted = submittedResults.find(s => s.question === stage.headline);
            const feedback = feedbackResults.find(f => f.question === stage.headline);
            return {
                index,
                question: stage.headline,
                correctAnswer: stage.correctAnswer,
                studentDrawing: submitted ? submitted.solutionImage : null,
                studentNotes: submitted ? submitted.notes : null,
                status: feedback ? feedback.initialStatus : 'unanswered' // 'correct' or 'incorrect'
            };
        });

        allResults.forEach(result => {
            const item = document.createElement('div');
            item.textContent = result.index + 1;
            item.className = `nav-item ${result.status}`;
            resultsNavGrid.appendChild(item);
        });
        
        resultsOverviewScreen.style.display = 'flex';
        reviewAnswersBtn.textContent = texts.reviewAnswers;
        reviewAnswersBtn.onclick = () => {
            resultsOverviewScreen.style.display = 'none';
            renderReviewScreen(0, allResults, feedbackResults);
        };
    }

    function renderReviewScreen(index, allResults, feedbackResults) {
        const result = allResults[index];
        const feedback = feedbackResults.find(f => f.question === result.question);

        document.getElementById('reviewProblemTitle').textContent = `${UI_TEXT[currentLang].question} ${index + 1}: ${result.question}`;
        document.getElementById('reviewStudentDrawing').src = result.studentDrawing || '';
        document.getElementById('reviewStudentDrawing').style.display = result.studentDrawing ? 'block' : 'none';
        document.getElementById('reviewStudentNotes').textContent = result.studentNotes || "No notes taken.";
        document.getElementById('reviewAIFeedback').textContent = feedback ? feedback.detailedFeedback : "Not answered.";
        document.getElementById('reviewCorrectAnswer').textContent = result.correctAnswer;
        
        reviewScreen.style.display = 'flex';
        
        const firstAnswered = allResults.findIndex(r => r.status !== 'unanswered');
        const lastAnswered = allResults.findLastIndex(r => r.status !== 'unanswered');

        document.getElementById('reviewPrevBtn').disabled = index <= firstAnswered;
        document.getElementById('reviewNextBtn').disabled = index >= lastAnswered;
        
        document.getElementById('reviewPrevBtn').onclick = () => {
             const prevAnsweredIndex = allResults.findLastIndex((r, i) => i < index && r.status !== 'unanswered');
             if(prevAnsweredIndex > -1) renderReviewScreen(prevAnsweredIndex, allResults, feedbackResults);
        };
        document.getElementById('reviewNextBtn').onclick = () => {
            const nextAnsweredIndex = allResults.findIndex((r, i) => i > index && r.status !== 'unanswered');
            if(nextAnsweredIndex > -1) renderReviewScreen(nextAnsweredIndex, allResults, feedbackResults);
        };
    }

    function renderNavPanel() {
        navGrid.innerHTML = '';
        problemStates.forEach((state, index) => {
            const item = document.createElement('div');
            item.textContent = index + 1;
            item.className = `nav-item ${state.status}`;
            if (index === currentStageIndex) item.classList.add('current');
            item.onclick = () => transitionToStage(index);
            navGrid.appendChild(item);
        });
    }
    
    function isCanvasBlank() {
        return !ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
    }

    /* Drawing and Canvas Logic */
    function setupContexts() { /* ... */ }
    function resizeCanvases() { /* ... */ }
    function getPos(e, targetCanvas) { /* ... */ }
    function handleDrawingStart(e) { drawing = true; /* ... */ }
    function handleDrawingMove(e) { if (!drawing) return; /* ... */ }
    function handleDrawingEnd(e) { if (!drawing) return; drawing = false; ctx.closePath(); }
    function clearUserCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
    
    function updateAllUITexts() {
        const texts = UI_TEXT[currentLang];
        prevBtn.textContent = texts.prev;
        clearBtn.textContent = texts.clear;
        unsureBtn.textContent = texts.unsure;
        
        if (!testStartTime) {
            submitBtn.textContent = texts.start;
        } else if (currentStageIndex === testData.stages.length - 1) {
            submitBtn.textContent = texts.finishTest;
        } else {
            submitBtn.textContent = texts.submit;
        }
    }

    function initApp() {
        resizeCanvases();
        
        canvas.addEventListener('mousedown', handleDrawingStart);
        canvas.addEventListener('mousemove', handleDrawingMove);
        window.addEventListener('mouseup', handleDrawingEnd);
        
        prevBtn.onclick = () => transitionToStage(currentStageIndex - 1);
        submitBtn.onclick = handleNextClick;
        clearBtn.onclick = clearUserCanvas;
        
        unsureBtn.onclick = () => {
            const state = problemStates[currentStageIndex];
            if (state.status === 'unanswered' && isCanvasBlank()) return;
            state.status = (state.status === 'unsure') ? 'answered' : 'unsure';
            saveStateToLocalStorage();
            renderNavPanel();
        };

        navToggleBtn.onclick = () => navPanel.classList.toggle('open');
        notesInput.addEventListener('input', () => {
             if (problemStates[currentStageIndex]) {
                 problemStates[currentStageIndex].notes = notesInput.value;
                 saveStateToLocalStorage();
             }
        });

        window.addEventListener('keydown', (e) => {
            if (document.activeElement === notesInput) return;
            if (e.key.toLowerCase() === 'a') { e.preventDefault(); notesPanel.classList.toggle('open'); }
            if (e.key.toLowerCase() === 'u') { e.preventDefault(); unsureBtn.click(); }
            if (e.key === 'ArrowRight') { e.preventDefault(); submitBtn.click(); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); prevBtn.click(); }
        });
        
        window.addEventListener('resize', resizeCanvases);
        
        const urlParams = new URLSearchParams(window.location.search);
        const testFileName = urlParams.get('testFile');
        if (testFileName) {
            loadTest(`https://thelo.space/tests/${testFileName}`);
        } else {
            alert("No test file specified. Add '?testFile=your-test.json'.");
            loadingOverlay.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => initApp());
    });
</script>
</body>
</html>
