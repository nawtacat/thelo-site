<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png">
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">
    <title>thelo | Test Mode</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
    :root {
        --thelo-blue: #2563eb; --thelo-blue-dark: #1d4ed8; --thelo-bg: #ffffff;
        --thelo-text: #111827; --thelo-text-light: #6b7280; --thelo-border: #e5e7eb;
        --success-green: #22c55e; --error-red: #ef4444; --accent-yellow: #f59e0b;
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    @font-face { font-family: 'Montserrat Arm'; src: url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype'); font-weight: 400; }
    body.lang-hy { font-family: 'Montserrat Arm', 'Manrope', system-ui, -apple-system, sans-serif; }
    
    html { font-size: 16px; background: var(--thelo-bg); }
    body { margin: 0; height: 100vh; font-family: 'Manrope', system-ui, sans-serif; display: flex; flex-direction: column; overflow: hidden; color: var(--thelo-text); user-select: none; -webkit-user-select: none; }
    
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out; }
    #loading-overlay.visible { opacity: 1; pointer-events: auto; }
    #loading-svg { width: 150px; height: auto; animation: pulse-loader 1.5s infinite ease-in-out; }
    #loading-text { font-weight: 500; font-size: 1.1rem; margin-top: 1rem; color: var(--thelo-text); }
    @keyframes pulse-loader { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

    #app { display: flex; flex-grow: 1; height: 100%; }
    #lessonArea { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; overflow: hidden; }
    #boardWrap { position: relative; flex-grow: 1; background-color: var(--thelo-bg); background-image: linear-gradient(to right, var(--thelo-border) 1px, transparent 1px), linear-gradient(to bottom, var(--thelo-border) 1px, transparent 1px); background-size: 40px 40px; }
    #backgroundCanvas, #board { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; }
    #backgroundCanvas { z-index: 1; pointer-events: none; opacity: 1; transition: opacity 0.3s ease-in-out; }
    #backgroundCanvas.fade-out { opacity: 0; }
    #board { z-index: 3; cursor: crosshair; touch-action: none; }
    
    #bottomBar { position: absolute; bottom: 0; left: 0; width: 100%; background: transparent; box-sizing: border-box; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 20; }
    #button-group { display: flex; gap: 0.5rem; }
    .control-btn { font-family: inherit; padding: 0.6rem 1.2rem; font-size: 1rem; font-weight: 500; border: none; border-radius: 0.5rem; color: white; cursor: pointer; transition: all 0.2s; box-shadow: var(--shadow-md); touch-action: manipulation; }
    .control-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .control-btn:disabled { background-color: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
    #prevBtn { background-color: #6b7280; }
    #unsureBtn { background-color: var(--accent-yellow); }
    #clearBtn { background-color: var(--error-red); }
    #submitBtn { background-color: var(--thelo-blue); }
    #timerDisplay { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); padding: 0.5rem 1.25rem; border-radius: 999px; font-size: 1.2rem; font-weight: 700; box-shadow: var(--shadow-md); border: 1px solid var(--thelo-border); }
    
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background-color: var(--thelo-bg); display: none; flex-direction: column; align-items: center; padding: 2rem; box-sizing: border-box; }
    .screen.visible { display: flex; }
    .screen-container { width: 100%; max-width: 800px; text-align: center; }
    .screen-header { border-bottom: 2px solid var(--thelo-border); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
    #resultsScore { font-size: 2.5rem; font-weight: 800; color: var(--thelo-blue); }
    #resultsTime { font-size: 1.2rem; color: var(--thelo-text-light); }
    
    #navToggleBtn { position: fixed; top: 20px; right: 20px; z-index: 1001; background-color: var(--thelo-blue); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; box-shadow: var(--shadow-lg); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #navPanel { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: #f9fafb; z-index: 1000; box-shadow: var(--shadow-lg); transition: right 0.3s ease-in-out; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; border-left: 1px solid var(--thelo-border); }
    #navPanel.open { right: 0; }
    #navGrid, .nav-grid-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; padding: 10px; }
    .nav-item { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 2px solid var(--thelo-border); }
    .nav-item.unanswered { background-color: #e5e7eb; color: #6b7280; }
    .nav-item.answered { background-color: var(--success-green); color: white; border-color: var(--success-green); }
    .nav-item.unsure { background-color: var(--accent-yellow); color: white; border-color: var(--accent-yellow); }
    .nav-item.correct { background-color: var(--success-green); color: white; border-color: var(--success-green); }
    .nav-item.incorrect { background-color: var(--error-red); color: white; border-color: var(--error-red); }
    .nav-item.current { transform: scale(1.1); box-shadow: 0 0 10px var(--thelo-blue); border-color: var(--thelo-blue); }
    
    #notesPanel { position: fixed; bottom: 90px; right: 20px; width: 300px; height: 40%; background: white; z-index: 1002; box-shadow: var(--shadow-lg); border-radius: 1rem; display: none; flex-direction: column; border: 1px solid var(--thelo-border); }
    #notesPanel.open { display: flex; }
    #notesPanel h4 { margin: 0; padding: 1rem; background-color: #f3f4f6; border-bottom: 1px solid var(--thelo-border); border-radius: 1rem 1rem 0 0;}
    #notesInput { flex-grow: 1; border: none; padding: 1rem; font-family: inherit; font-size: 1rem; resize: none; border-radius: 0 0 1rem 1rem; }
    #notesInput:focus { outline: none; }
    
    #reviewContainer { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto 1fr; gap: 1rem; width: 100%; max-width: 1200px; height: calc(100vh - 150px); }
    #reviewHeader { grid-column: 1 / -1; }
    #reviewStudentSolution, #reviewCorrectSolution { border: 1px solid var(--thelo-border); border-radius: 0.5rem; padding: 1rem; overflow-y: auto; }
    #reviewStudentSolution h4, #reviewCorrectSolution h4 { margin-top: 0; }
    #reviewStudentDrawing { max-width: 100%; border: 1px solid #ccc; }
    #reviewStudentNotes { background-color: #fefce8; padding: 0.5rem; border-radius: 0.25rem; white-space: pre-wrap; word-wrap: break-word; }
    #reviewNav { position: absolute; bottom: 2rem; width: 100%; display: flex; justify-content: center; gap: 1rem; }
</style>
</head>
<body>
    <div id="loading-overlay">
        <img id="loading-svg" src="https://thelo.space/img/bluethelo.svg" alt="Loading...">
        <p id="loading-text"></p>
    </div>

    <div id="app">
        <div id="lessonArea">
            <div id="boardWrap">
                <canvas id="backgroundCanvas"></canvas>
                <canvas id="board"></canvas>
            </div>
            <div id="bottomBar">
                <div id="timerDisplay">00:00</div>
                <div id="button-group">
                    <button id="prevBtn" class="control-btn" title="Previous Question (←)"></button>
                    <button id="clearBtn" class="control-btn"></button>
                    <button id="unsureBtn" class="control-btn" title="Mark as Unsure (U)"></button>
                    <button id="submitBtn" class="control-btn" title="Next Question (→)"></button>
                </div>
            </div>
        </div>
        
        <button id="navToggleBtn" title="Toggle Problem List">☰</button>
        <div id="navPanel">
            <h3>Problems</h3>
            <div id="navGrid"></div>
        </div>
        
        <div id="notesPanel">
            <h4>My Notes (Toggle with 'A')</h4>
            <textarea id="notesInput" placeholder="Type your notes for this problem here..."></textarea>
        </div>

        <div id="resultsOverviewScreen" class="screen">
            <div class="screen-container">
                <div class="screen-header">
                    <h1 id="resultsHeaderTitle"></h1>
                    <div id="resultsScore"></div>
                    <div id="resultsTime"></div>
                </div>
                <div id="resultsNavGrid" class="nav-grid-results"></div>
                <button id="reviewAnswersBtn" class="control-btn" style="background-color: var(--thelo-blue); margin-top: 2rem;"></button>
            </div>
        </div>

        <div id="reviewScreen" class="screen">
             <div id="reviewContainer">
                <div id="reviewHeader"> <h2 id="reviewProblemTitle"></h2> </div>
                <div id="reviewStudentSolution">
                    <h4>Your Solution</h4>
                    <img id="reviewStudentDrawing" src="" alt="Your drawing">
                    <h4>Your Notes</h4>
                    <p id="reviewStudentNotes"></p>
                </div>
                <div id="reviewCorrectSolution">
                    <h4>AI Feedback & Correct Answer</h4>
                    <p id="reviewAIFeedback"></p>
                    <p><strong>Correct Answer:</strong> <span id="reviewCorrectAnswer"></span></p>
                </div>
            </div>
            <div id="reviewNav">
                <button id="reviewPrevBtn" class="control-btn">← Previous</button>
                <button id="reviewNextBtn" class="control-btn">Next →</button>
            </div>
        </div>
    </div>

<script>
    // Firebase Initialization
    const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", projectId: "physmathacademy-722b3", messagingSenderId: "1093640992262", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // DOM Element References
    const dom = {
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingText: document.getElementById('loading-text'),
        backgroundCanvas: document.getElementById('backgroundCanvas'),
        canvas: document.getElementById('board'),
        prevBtn: document.getElementById('prevBtn'),
        submitBtn: document.getElementById('submitBtn'),
        clearBtn: document.getElementById('clearBtn'),
        unsureBtn: document.getElementById('unsureBtn'),
        timerDisplay: document.getElementById('timerDisplay'),
        lessonArea: document.getElementById('lessonArea'),
        navToggleBtn: document.getElementById('navToggleBtn'),
        navPanel: document.getElementById('navPanel'),
        navGrid: document.getElementById('navGrid'),
        notesPanel: document.getElementById('notesPanel'),
        notesInput: document.getElementById('notesInput'),
        resultsOverviewScreen: document.getElementById('resultsOverviewScreen'),
        reviewScreen: document.getElementById('reviewScreen'),
        reviewAnswersBtn: document.getElementById('reviewAnswersBtn'),
    };
    const bgCtx = dom.backgroundCanvas.getContext('2d');
    const ctx = dom.canvas.getContext('2d');

    // In-Memory State
    let state = {
        testData: null,
        problemStates: [],
        currentStageIndex: 0,
        testStartTime: null,
        timerInterval: null,
        isTransitioning: false,
        isDrawing: false,
        testId: null,
        currentLang: 'en',
        finalResults: []
    };
    
    // UI Text Translations
    const UI_TEXT = {
        en: { start: "Start Test", submit: "Next", prev: "Previous", clear: "Clear", testComplete: "Test Complete!", score: "Score:", timeTaken: "Time Taken:", question: "Question", finishTest: "Finish Test", unsure: "I'm Unsure", reviewAnswers: "Review Answers", analyzing: "Analyzing your answers..." },
        hy: { start: "Սկսել թեստը", submit: "Հաջորդը", prev: "Նախորդ", clear: "Մաքրել", testComplete: "Թեստն ավարտված է", score: "Միավոր:", timeTaken: "Ժամանակ:", question: "Հարց", finishTest: "Ավարտել թեստը", unsure: "Վստահ չեմ", reviewAnswers: "Դիտել պատասխանները", analyzing: "Վերլուծվում են պատասխանները..." }
    };
    
    // KaTeX and Headline Rendering (Full implementation required)
    async function renderComplexHeadline(headline) {
        // This is a simplified placeholder. A full implementation like the one in previous versions is needed here.
        bgCtx.font = `24px '${state.currentLang === 'hy' ? "Montserrat Arm" : "Manrope"}'`;
        bgCtx.fillStyle = '#111827';
        bgCtx.textAlign = 'center';
        bgCtx.fillText(headline, dom.backgroundCanvas.width / (2 * window.devicePixelRatio), 65, dom.backgroundCanvas.width * 0.9 / window.devicePixelRatio);
    }

    // --- Main Application Flow ---
    
    async function loadTest(testJsonPath) {
        state.testId = new URLSearchParams(window.location.search).get('testFile')?.replace('.json', '');
        showLoading(true, '');
        try {
            const response = await fetch(testJsonPath);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            state.testData = await response.json();
            
            state.currentLang = state.testData.lang === 'hy' ? 'hy' : 'en';
            document.body.className = state.currentLang === 'hy' ? 'lang-hy' : '';
            document.title = state.testData.testTitle || "thelo | Test Mode";

            state.problemStates = state.testData.stages.map(() => ({
                status: 'unanswered', // 'unanswered', 'answered', 'unsure'
                drawingDataUrl: null,
                notes: ''
            }));
            
            updateAllUITexts();
            renderNavPanel();
            await transitionToStage(0);

        } catch (error) {
            console.error("Error loading test:", error);
            alert("Failed to load the test file. Please check the URL and console for details.");
        } finally {
            showLoading(false);
        }
    }

    function startTest() {
        if (state.testStartTime) return;
        state.testStartTime = Date.now();
        state.timerInterval = setInterval(updateTimerDisplay, 1000);
        updateAllUITexts(); // Update button text from "Start" to "Next"
    }
    
    function handleNavigation(newIndex) {
        if (state.isTransitioning || newIndex < 0 || newIndex >= state.testData.stages.length) return;
        
        if (state.testStartTime) { // Don't save state before test starts
            saveCurrentProblemState();
        }
        
        transitionToStage(newIndex);
    }
    
    async function transitionToStage(index) {
        state.isTransitioning = true;
        dom.backgroundCanvas.classList.add('fade-out');
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        state.currentStageIndex = index;
        await renderStageUI(index);
        
        dom.backgroundCanvas.classList.remove('fade-out');
        state.isTransitioning = false;
    }
    
    async function renderStageUI(index) {
        const problemState = state.problemStates[index];
        const stageData = state.testData.stages[index];

        bgCtx.clearRect(0, 0, dom.backgroundCanvas.width, dom.backgroundCanvas.height);
        const headlineText = `${UI_TEXT[state.currentLang].question} ${index + 1}: ${stageData.headline || ''}`;
        await renderComplexHeadline(headlineText);
        
        clearUserCanvas();
        if (problemState.drawingDataUrl) {
            const img = new Image();
            await new Promise(resolve => {
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, dom.canvas.width / window.devicePixelRatio, dom.canvas.height / window.devicePixelRatio);
                    resolve();
                };
                img.src = problemState.drawingDataUrl;
            });
        }
        
        dom.notesInput.value = problemState.notes;
        updateAllUITexts();
        renderNavPanel();
    }
    
    function saveCurrentProblemState() {
        const problemState = state.problemStates[state.currentStageIndex];
        const hasDrawing = !isCanvasBlank();
        
        if (hasDrawing) {
            problemState.drawingDataUrl = dom.canvas.toDataURL();
            if (problemState.status === 'unanswered') {
                problemState.status = 'answered';
            }
        }
        problemState.notes = dom.notesInput.value;
    }
    
    async function finishTest() {
        clearInterval(state.timerInterval);
        showLoading(true, UI_TEXT[state.currentLang].analyzing);
        dom.lessonArea.style.display = 'none';
        dom.navPanel.style.display = 'none';

        const timeTaken = Math.floor((Date.now() - state.testStartTime) / 1000);
        const user = auth.currentUser;
        if (!user) { alert("Authentication error."); showLoading(false); return; }

        const resultsToSubmit = state.problemStates
            .map((ps, index) => ({ ...ps, index }))
            .filter(ps => ps.status !== 'unanswered')
            .map(ps => ({
                question: state.testData.stages[ps.index].headline,
                correctAnswer: state.testData.stages[ps.index].correctAnswer,
                solutionImage: ps.drawingDataUrl,
                notes: ps.notes,
                initialStatus: ps.status
            }));

        try {
            const submitTestResults = functions.httpsCallable('submitTestResults');
            const response = await submitTestResults({
                testId: state.testId,
                totalQuestions: state.testData.stages.length,
                timeTakenSeconds: timeTaken,
                results: resultsToSubmit,
                language: state.currentLang
            });

            const resultId = response.data.resultId;
            if (resultId) {
                listenForDetailedFeedback(user.uid, resultId, resultsToSubmit);
            }
        } catch (err) {
            console.error("Error submitting test results:", err);
            alert("There was a critical problem submitting your test. Please contact support.");
            showLoading(false);
        }
    }

    function listenForDetailedFeedback(uid, resultId, submittedResults) {
        const solutionsRef = db.collection('thelo-students').doc(uid).collection('test_results').doc(resultId).collection('solutions');
        let receivedFeedback = [];
        const unsubscribe = solutionsRef.onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added" || change.type === "modified") {
                    const data = change.doc.data();
                    if (data.detailedFeedback && !receivedFeedback.some(item => item.question === data.question)) {
                        receivedFeedback.push(data);
                    }
                }
            });

            if (receivedFeedback.length >= submittedResults.length) {
                unsubscribe();
                state.finalResults = receivedFeedback;
                renderResultsOverview(submittedResults);
                showLoading(false);
            }
        });
    }

    function renderResultsOverview(submittedResults) {
        const texts = UI_TEXT[state.currentLang];
        const correctAnswers = state.finalResults.filter(r => r.status === 'correct').length;
        
        document.getElementById('resultsHeaderTitle').textContent = texts.testComplete;
        document.getElementById('resultsScore').textContent = `${texts.score} ${correctAnswers} / ${state.testData.stages.length}`;
        document.getElementById('resultsTime').textContent = `${texts.timeTaken} ${dom.timerDisplay.textContent}`;
        
        const resultsNavGrid = document.getElementById('resultsNavGrid');
        resultsNavGrid.innerHTML = '';
        
        state.problemStates.forEach((ps, index) => {
            const item = document.createElement('div');
            item.textContent = index + 1;
            const feedback = state.finalResults.find(fr => fr.question === state.testData.stages[index].headline);
            const status = feedback ? feedback.status : 'unanswered';
            item.className = `nav-item ${status}`;
            resultsNavGrid.appendChild(item);
        });
        
        dom.resultsOverviewScreen.classList.add('visible');
        dom.reviewAnswersBtn.textContent = texts.reviewAnswers;
        dom.reviewAnswersBtn.onclick = () => {
            dom.resultsOverviewScreen.classList.remove('visible');
            renderReviewScreen(0);
        };
    }

    function renderReviewScreen(index) {
        const stageData = state.testData.stages[index];
        const problemState = state.problemStates[index];
        const feedback = state.finalResults.find(fr => fr.question === stageData.headline);

        document.getElementById('reviewProblemTitle').textContent = `${UI_TEXT[state.currentLang].question} ${index + 1}: ${stageData.headline}`;
        
        const drawingImg = document.getElementById('reviewStudentDrawing');
        drawingImg.src = problemState.drawingDataUrl || '';
        drawingImg.style.display = problemState.drawingDataUrl ? 'block' : 'none';
        
        document.getElementById('reviewStudentNotes').textContent = problemState.notes || "No notes taken.";
        document.getElementById('reviewAIFeedback').textContent = feedback ? feedback.detailedFeedback : "Not answered.";
        document.getElementById('reviewCorrectAnswer').textContent = stageData.correctAnswer;
        
        dom.reviewScreen.classList.add('visible');
        
        document.getElementById('reviewPrevBtn').disabled = index === 0;
        document.getElementById('reviewNextBtn').disabled = index === state.testData.stages.length - 1;
        
        document.getElementById('reviewPrevBtn').onclick = () => renderReviewScreen(index - 1);
        document.getElementById('reviewNextBtn').onclick = () => renderReviewScreen(index + 1);
    }
    
    // --- UI & Event Handlers ---
    
    function setupEventListeners() {
        dom.submitBtn.onclick = () => {
            if (!state.testStartTime) startTest();
            else if (state.currentStageIndex === state.testData.stages.length - 1) finishTest();
            else handleNavigation(state.currentStageIndex + 1);
        };
        dom.prevBtn.onclick = () => handleNavigation(state.currentStageIndex - 1);
        dom.clearBtn.onclick = clearUserCanvas;
        dom.unsureBtn.onclick = () => {
            const problemState = state.problemStates[state.currentStageIndex];
            if (problemState.status === 'unanswered' && isCanvasBlank()) return;
            problemState.status = problemState.status === 'unsure' ? 'answered' : 'unsure';
            renderNavPanel();
        };
        dom.navToggleBtn.onclick = () => dom.navPanel.classList.toggle('open');
        dom.notesInput.oninput = () => {
            if (state.problemStates[state.currentStageIndex]) {
                state.problemStates[state.currentStageIndex].notes = dom.notesInput.value;
            }
        };
        
        window.onkeydown = (e) => {
            if (document.activeElement === dom.notesInput) return;
            const key = e.key.toLowerCase();
            if (key === 'a') { e.preventDefault(); dom.notesPanel.classList.toggle('open'); }
            if (key === 'u') { e.preventDefault(); dom.unsureBtn.click(); }
            if (key === 'arrowright') { e.preventDefault(); dom.submitBtn.click(); }
            if (key === 'arrowleft') { e.preventDefault(); dom.prevBtn.click(); }
        };
        
        dom.canvas.addEventListener('mousedown', handleDrawingStart);
        dom.canvas.addEventListener('mousemove', handleDrawingMove);
        window.addEventListener('mouseup', handleDrawingEnd);
        window.addEventListener('resize', resizeAndRedraw);
    }

    function updateAllUITexts() {
        const texts = UI_TEXT[state.currentLang];
        dom.prevBtn.textContent = texts.prev;
        dom.clearBtn.textContent = texts.clear;
        dom.unsureBtn.textContent = texts.unsure;
        
        if (!state.testStartTime) {
            dom.submitBtn.textContent = texts.start;
        } else if (state.currentStageIndex === state.testData.stages.length - 1) {
            dom.submitBtn.textContent = texts.finishTest;
        } else {
            dom.submitBtn.textContent = texts.submit;
        }
        
        dom.prevBtn.disabled = state.currentStageIndex === 0;
    }

    function renderNavPanel() {
        dom.navGrid.innerHTML = '';
        state.problemStates.forEach((ps, index) => {
            const item = document.createElement('div');
            item.textContent = index + 1;
            item.className = `nav-item ${ps.status}`;
            if (index === state.currentStageIndex) item.classList.add('current');
            item.onclick = () => handleNavigation(index);
            dom.navGrid.appendChild(item);
        });
    }

    function showLoading(visible, text = '') {
        dom.loadingText.textContent = text;
        dom.loadingOverlay.classList.toggle('visible', visible);
    }
    
    // --- Canvas & Drawing Logic ---
    
    function resizeAndRedraw() {
        resizeCanvases();
        renderStageUI(state.currentStageIndex);
    }
    
    function resizeCanvases() {
        const dpr = window.devicePixelRatio || 1;
        const rect = dom.canvas.parentElement.getBoundingClientRect();
        [dom.backgroundCanvas, dom.canvas].forEach(c => {
            c.width = rect.width * dpr;
            c.height = rect.height * dpr;
            c.style.width = `${rect.width}px`;
            c.style.height = `${rect.height}px`;
        });
        [bgCtx, ctx].forEach(context => context.scale(dpr, dpr));
        ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#000000';
    }

    function getPos(e) {
        const rect = dom.canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function handleDrawingStart(e) {
        state.isDrawing = true;
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }
    function handleDrawingMove(e) {
        if (!state.isDrawing) return;
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }
    function handleDrawingEnd() { state.isDrawing = false; }
    function clearUserCanvas() { ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height); }
    function isCanvasBlank() { return !ctx.getImageData(0, 0, dom.canvas.width, dom.canvas.height).data.some(channel => channel !== 0); }
    function updateTimerDisplay() {
        if (!state.testStartTime) return;
        const elapsed = Math.floor((Date.now() - state.testStartTime) / 1000);
        const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const seconds = String(elapsed % 60).padStart(2, '0');
        dom.timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    // --- App Initialization ---
    
    document.addEventListener('DOMContentLoaded', () => {
        auth.onAuthStateChanged(user => {
            if(user) {
                resizeCanvases();
                setupEventListeners();
                const urlParams = new URLSearchParams(window.location.search);
                const testFileName = urlParams.get('testFile');
                if (testFileName) {
                    loadTest(`https://thelo.space/tests/${testFileName}`);
                } else {
                    alert("No test file specified. Add '?testFile=your-test.json' to the URL.");
                }
            } else {
                // Handle user not signed in
                console.log("User not signed in.");
            }
        });
    });
</script>
</body>
</html>
