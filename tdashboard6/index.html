<!DOCTYPE html>
<!-- 
  UX Enhancements (v7 - Navbar/Group Selection):
  - Increased navbar vertical padding (py-6) and logo size (h-12) for more presence.
  - Replaced the custom dropdown with a more robust "pill" selection system.
  - Groups now display as a flex-wrap list of selectable buttons.
  - Removed all JS and CSS related to the old dropdown.
  - Added new CSS for `.group-pill-btn` and its active state.
  - Simplified JS logic in `loadGroups` and `handleGroupSelect` to work with the new pill system.
-->
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Tutor Dashboard | thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font Import for Manrope (Montserrat Arm is self-hosted via @font-face) -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <style>
    /*
     * ============================================
     * Custom Font Definitions for Armenian (Montserrat Arm)
     * ============================================
     */
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype');
      font-weight: 400; /* Regular */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-SemiBold.otf') format('opentype');
      font-weight: 600; /* SemiBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-ExtraBold.otf') format('opentype');
      font-weight: 800; /* ExtraBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }

    /*
     * ============================================
     * Main Site Styles
     * ============================================
     */
    :root {
        --thelo-blue: #2563EB;
        --thelo-bg: #F8F9FA;
        --thelo-text: #111827;
        --grid-color: #E5E7EB;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Montserrat Arm', 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--thelo-bg);
        color: var(--thelo-text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-image:
            linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 40px 40px;
        min-height: 100vh;
    }

    h1, h2, h3, h4, h5, h6 { font-weight: 800; }

    .nav-link { 
        @apply font-semibold text-[var(--thelo-text)] transition-colors duration-200;
    }
    .nav-link:hover { 
        color: var(--thelo-blue); 
    }

    .window-container {
        position: relative;
        background-color: white;
        border: 1px solid var(--grid-color);
        border-radius: 0.75rem; 
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
        padding: 2.5rem; 
    }
    .window-container::before {
        content: ' ';
        position: absolute;
        top: 1.5rem; 
        left: 1.5rem; 
        width: 52px;
        height: 12px;
        background-image: url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E%0A");
        background-repeat: no-repeat;
        z-index: 1;
    }

    /* Button Styles */
    .thelo-btn, .thelo-btn-secondary, .thelo-btn-destructive {
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        cursor: pointer; 
    }
    .thelo-btn {
        background-color: var(--thelo-blue);
        color: white;
    }
    .thelo-btn:hover {
        background-color: #1a56d2; 
        transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); 
    }
    .thelo-btn-secondary {
        background-color: transparent;
        color: var(--thelo-blue);
        border-color: var(--thelo-blue);
    }
    .thelo-btn-secondary:hover {
        background-color: var(--thelo-blue);
        color: white;
    }
    .thelo-btn-secondary-sm {
        font-weight: 600; 
        padding: 0.375rem 0.75rem; 
        font-size: 0.875rem; 
        border-radius: 0.375rem; 
        transition: all 0.2s ease-in-out;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--thelo-blue);
        background-color: transparent;
        color: var(--thelo-blue);
        cursor: pointer;
    }
     .thelo-btn-secondary-sm:hover {
         background-color: var(--thelo-blue);
         color: white;
     }

    .thelo-btn:disabled, .thelo-btn-secondary:disabled, .thelo-btn-secondary-sm:disabled {
        @apply bg-slate-300 border-slate-300 text-slate-500 cursor-not-allowed transform-none shadow-none;
    }

    .input-field {
        @apply w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition-all duration-200 focus:bg-white;
    }
 
    .lang-btn {
        @apply cursor-pointer font-bold text-slate-400;
    }
    .lang-btn.active {
        @apply text-[var(--thelo-blue)];
    }

    /* Notification Toast Styles */
    #notification-toast { @apply fixed bottom-5 right-5 bg-green-600 text-white p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-y-10 opacity-0 z-50; }
    #notification-toast.show { @apply transform-none opacity-100; }
    #notification-toast.error { @apply bg-red-600; }

    /* Tab Styles */
    .tab-btn { @apply border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm cursor-pointer; }
    .tab-btn.active { @apply border-[var(--thelo-blue)] text-[var(--thelo-blue)]; }
    .tab-panel { @apply py-6; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000; backdrop-filter: blur(4px); 
        opacity: 0; transition: opacity 0.3s ease-out; padding: 1rem;
    }
    .modal-overlay.hidden { display: none; }
    .modal-overlay:not(.hidden) { display: flex; }
    .modal-overlay.show { opacity: 1; }
    .modal-content {
        background: white; padding: 2rem; border-radius: 0.75rem; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%;
        position: relative; opacity: 0; transform: scale(0.95);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    .modal-overlay.show .modal-content { opacity: 1; transform: scale(1); }
    .modal-label { font-weight: 600; font-size: 0.875rem; @apply block text-slate-700; }
    .modal-content .input-field { margin-top: 0.25rem; }
    .modal-close-btn { @apply absolute top-4 right-4 text-3xl font-light text-slate-400 hover:text-slate-700 cursor-pointer z-10; }
    #result-modal-content { max-width: 56rem; }

    #create-group-modal-content { max-width: 28rem; } 

    /* --- NEW Group Pill Styles --- */
    .group-pill-btn {
        @apply px-4 py-2 border border-[var(--thelo-blue)] rounded-lg text-[var(--thelo-blue)] font-semibold transition-all duration-200 hover:bg-[var(--thelo-blue)] hover:text-white cursor-pointer text-sm;
    }
    .group-pill-btn:disabled {
        @apply bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed hover:border-slate-200 hover:text-slate-400;
    }
    .group-pill-btn.active {
        @apply bg-blue-50 border-blue-500 text-blue-600 ring-2 ring-blue-200;
    }
    /* --- FINAL FIX: Active state for the secondary button style --- */
    /* This rule ensures that when a button is active, it STAYS blue, even when hovered. */
    .thelo-btn-secondary.active {
        background-color: var(--thelo-blue);
        color: white;
    }

    /* --- END NEW Styles --- */
   
    /* Responsive Styles */
    @media (max-width: 767px) {
         main { padding-left: 1rem; padding-right: 1rem; }
         h1 { font-size: 2.5rem; } 
         h2 { font-size: 1.75rem; } 
         .window-container { padding: 2rem 1rem; border-radius: 1rem; }
         .window-container::before { top: 1rem; left: 1rem; transform: scale(0.8); transform-origin: top left; }
         .modal-content { margin: 1rem; }
         .nav-link { font-size: 0.875rem; } 
         .thelo-btn-secondary { padding: 0.5rem 0.75rem; font-size: 0.875rem;}
    }

   </style>
</head>

<body class="antialiased">

<!-- Navbar: Increased height and logo size -->
<nav id="mainNav" class="w-full z-40"> 
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-6 lg:px-8"> <!-- Increased py-5 to py-6 -->
        <a href="/" class="flex items-center gap-2">
            <img src="https://thelo.space/img/bluethelo.svg" alt="thelo logo" class="h-12 w-auto" /> <!-- Increased h-10 to h-12 -->
        </a>
       
        <div class="flex items-center gap-4">
            <button id="nav-create-group-btn" class="thelo-btn-secondary hidden md:flex" data-i18n="navCreateGroup"> 
                Create Group
            </button>
            <ul class="hidden gap-6 md:flex">
                <li><a href="#" id="logout-btn" class="nav-link" data-i18n="navLogout">Log Out</a></li>
            </ul>
            <div class="flex items-center gap-2 text-sm border-l pl-4 ml-2">
                <span id="lang-en" class="lang-btn">EN</span>
                <span class="text-slate-300">|</span>
                <span id="lang-hy" class="lang-btn">HY</span>
            </div>
        </div>
    </div>
</nav>

<main class="pt-12 pb-16 lg:pt-16 lg:pb-24"> <!-- Adjusted padding -->
    <div class="mx-auto max-w-7xl px-6 lg:px-8">

        <div id="loading-state" class="text-center py-20">
            <h2 class="text-2xl font-bold text-slate-600" data-i18n="loading">Loading Dashboard...</h2>
        </div>

        <div id="error-state" class="hidden text-center py-20 window-container max-w-3xl mx-auto">
            <h2 class="text-3xl font-bold text-red-600" data-i18n="errorTitle">Access Denied</h2>
            <p class="text-lg text-slate-600 mt-4" data-i18n="errorSubtitle">You must be a registered tutor to access this page. Please contact support if you believe this is an error.</p>
            <a href="/" class="thelo-btn inline-block mt-8" data-i18n="errorButton">Back to Home</a>
        </div>

        <div id="dashboard-content" class="hidden">
            <div class="flex justify-between items-center mb-8"> 
                <div>
                    <h1 class="text-4xl font-extrabold tracking-tighter text-[var(--thelo-text)] sm:text-5xl" data-i18n="dashboardTitle">Tutor Dashboard</h1>
                    <p class="text-lg text-slate-600 mt-4" id="welcome-message" data-i18n="dashboardSubtitle">Welcome, tutor. Select a group to get started.</p>
                </div>
                <button id="nav-create-group-btn-mobile" class="thelo-btn-secondary md:hidden" data-i18n="navCreateGroupShort">
                <button id="create-group-btn-mobile" class="thelo-btn-secondary md:hidden" data-i18n="navCreateGroupShort">
                    New
                </button>
            </div>

            <!-- === FULL-WIDTH LAYOUT === -->
            <div class="mt-8"> 
                <section class="w-full window-container">
                    <div> <!-- Removed pt-10 -->
                       
                        <!-- 1. Group Selection -->
                        <div class="mb-12">
                            <!-- This container will be filled by JS with group buttons -->
                            <div id="group-selection-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-3">
                            <div id="group-selection-container" class="flex flex-wrap gap-2">
                                <!-- JS populates this area -->
                            </div>
                             <p id="no-groups-msg" class="text-slate-500 mt-2 hidden" data-i18n="groupsNone">You haven't created any groups yet.</p>
                        </div>
                                   
                        <!-- NEW: Test Selection Container -->
                        <div id="test-selection-container" class="mb-12 hidden">
                            <label class="block text-sm font-bold text-slate-700 mb-3" data-i18n="testsTitle">Tests</label>
                            <div id="test-list-container" class="flex flex-wrap gap-2">
                                <!-- JS will populate this with test pills -->
                            </div>
                            <p id="no-tests-msg" class="text-slate-500 mt-2 hidden" data-i18n="testsNone">No tests have been taken by this group yet.</p>
                        </div>


                        <!-- 2. Results Title -->
                        <h2 id="results-title" class="text-2xl font-bold mt-8" data-i18n="resultsTitleDefault">Select a group</h2>
                       
                        <!-- 3. Empty State -->
                        <div id="results-empty-state" class="text-center py-16">
                            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 16.5h16.5M3.75 8.25h16.5M3.75 4.5h16.5" /> </svg>
                            <h3 class="mt-2 text-lg font-semibold text-slate-800" data-i18n="resultsTitleDefault">Select a group</h3>
                            <p id="results-placeholder" class="mt-1 text-sm text-slate-500" data-i18n="resultsSelectPrompt">Select a group from the list to view its details.</p>
                        </div>

                        <!-- 4. Tabbed Content -->
                        <div id="results-content" class="hidden">
                            <!-- Tab Navigation -->
                            <div class="border-b border-slate-200 mb-4">
                                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                    <button id="tab-btn-results" class="tab-btn active" data-i18n="tabResults"></button>
                                    <button id="tab-btn-roster" class="tab-btn" data-i18n="tabRoster"></button>
                                </nav>
                            </div>

                            <!-- Tab Panels -->
                            <div id="tab-panel-results" class="tab-panel">
                                <div id="results-container" class="overflow-x-auto">
                                    <p id="results-none-msg" class="text-lg text-slate-500 hidden" data-i18n="resultsNone"></p>
                                    <table id="results-table" class="hidden min-w-full divide-y divide-slate-200">
                                        <thead class="bg-slate-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableStudent">Student</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableTest">Test ID</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableScore">Score</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableTime">Time</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableDate">Date</th>
                                                <th scope="col" class="relative px-6 py-3"> <span class="sr-only" data-i18n="tableViewSr">View</span> </th>
                                            </tr>
                                        </thead>
                                        <tbody id="results-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="tab-panel-roster" class="tab-panel hidden">
                                <div id="roster-container">
                                    <div id="roster-list" class="mt-4 p-4 bg-slate-50 rounded-lg max-h-96 overflow-y-auto">
                                        <span id="roster-none-msg" class="text-slate-500 italic hidden" data-i18n="rosterNone"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</main>

<div id="notification-toast" class="hidden"> <span id="notification-message"></span> </div>

<div id="create-group-modal-overlay" class="modal-overlay hidden"> 
    <div id="create-group-modal-content" class="modal-content">
        <button id="create-group-modal-close-btn" class="modal-close-btn">&times;</button>
        <h2 class="text-2xl font-bold" data-i18n="groupsCreateTitle">Create New Group</h2>
        <form id="create-group-form" class="mt-6 space-y-4">
            <div>
                <label for="group-name-input" class="modal-label" data-i18n="groupsCreateLabel">Group Name</label>
                <input type="text" id="group-name-input" class="input-field mt-1" placeholder="e.g. Algebra 1 (Fall)" required>
            </div>
            <button type="submit" id="create-group-submit-btn" class="thelo-btn w-full"> <span data-i18n="groupsCreateButton">Create Group</span> </button>
        </form>
    </div>
</div>

<script type="module">
    // Firebase SDK imports...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Config...
    const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", projectId: "physmathacademy-722b3", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { setLogLevel('debug'); } catch (e) { console.warn("Could not set Firestore log level:", e); }

    // DOM Elements...
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const dashboardContent = document.getElementById('dashboard-content');
    const welcomeMessage = document.getElementById('welcome-message');
    const logoutBtn = document.getElementById('logout-btn');
    const langEnBtn = document.getElementById('lang-en');
    const langHyBtn = document.getElementById('lang-hy');
    // NEW Group Pill Selection Elements
    const groupSelectionContainer = document.getElementById('group-selection-container');
    const noGroupsMsg = document.getElementById('no-groups-msg');
    // Content Panel
    const resultsTitle = document.getElementById('results-title');
    const resultsEmptyState = document.getElementById('results-empty-state');
    const resultsContent = document.getElementById('results-content');
    const tabBtnResults = document.getElementById('tab-btn-results');
    const tabBtnRoster = document.getElementById('tab-btn-roster');
    const tabPanelResults = document.getElementById('tab-panel-results');
    const tabPanelRoster = document.getElementById('tab-panel-roster');
    const resultsContainer = document.getElementById('results-container');
    const resultsNoneMsg = document.getElementById('results-none-msg');
    const resultsTable = document.getElementById('results-table');
    const resultsTableBody = document.getElementById('results-table-body');
    const rosterContainer = document.getElementById('roster-container');
    const testSelectionContainer = document.getElementById('test-selection-container');
    const rosterList = document.getElementById('roster-list');
    const rosterNoneMsg = document.getElementById('roster-none-msg');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    // Modals
    const navCreateGroupBtn = document.getElementById('nav-create-group-btn');
    const navCreateGroupBtnMobile = document.getElementById('nav-create-group-btn-mobile');
    // Create Group Elements
    const createGroupBtn = document.getElementById('nav-create-group-btn');
    const createGroupBtnMobile = document.getElementById('create-group-btn-mobile');
    const createGroupModalOverlay = document.getElementById('create-group-modal-overlay');
    const createGroupModalCloseBtn = document.getElementById('create-group-modal-close-btn');
    const createGroupForm = document.getElementById('create-group-form');
    const groupNameInput = document.getElementById('group-name-input');
    const createGroupSubmitBtn = document.getElementById('create-group-submit-btn');

    // App State...
    let currentUser = null;
    let currentTutor = null;
    let selectedGroupId = null;
    let currentLang = localStorage.getItem('thelo-lang') || 'en';
    let selectedTestId = null;
    let allGroups = []; 
    let studentNameMap = new Map(); // NEW: To store student names for easy lookup

    // UI Strings (i18n)...
    const strings = {
        en: {
            title: 'Tutor Dashboard | thelo', navTutorPortal: 'Tutor Portal', navLogout: 'Log Out', navCreateGroup: 'Create Group', navCreateGroupShort: 'New', loading: 'Loading Dashboard...', loadingSubmit: 'Creating...', errorTitle: 'Access Denied', errorSubtitle: 'You must be a registered tutor to access this page. Please contact support if you believe this is an error.', errorButton: 'Back to Home', dashboardTitle: 'Tutor Dashboard', dashboardSubtitle: 'Welcome. Select a group to get started.', groupsTitle: 'My Groups', groupsSelectDefault: 'Select a group...', groupsNone: "You haven't created any groups yet.", groupsCreateTitle: 'Create New Group', groupsCreateLabel: 'Group Name', groupsCreateButton: 'Create Group', groupsCreateSuccess: 'Group "{groupName}" created! Join Code: {joinCode}', groupsCreateError: 'Error creating group. Please try again.', joinCode: 'Join Code', resultsTitleDefault: 'Select a group', resultsSelectPrompt: 'Select a group from the list to view its details.', resultsTitleLoading: 'Loading data for "{groupName}"...', resultsTitleLoaded: 'Showing results for "{groupName}"', resultsTitleSelectTest: 'Select a test to view results', resultsNone: 'No test results found for this test.', rosterTitle: 'Student Roster', rosterNone: 'No students have joined this group yet.', testsTitle: 'Tests', testsNone: 'No tests have been taken by this group yet.', tabResults: '', tabRoster: '', tableStudent: 'Student', tableTest: 'Test ID', tableScore: 'Score', tableTime: 'Time', tableDate: 'Date', tableTimeValue: '{time}s', tableView: 'View', tableViewSr: 'View Details'
        },
        hy: {
            title: 'Ուսուցչի Վահանակ | Թելո', navTutorPortal: 'Ուսուցչի Վահանակ', navLogout: 'Դուրս գալ', navCreateGroup: 'Ստեղծել Խումբ', navCreateGroupShort: 'Նոր', loading: 'Բեռնվում է...', loadingSubmit: 'Ստեղծվում է...', errorTitle: 'Մուտքը մերժված է', errorSubtitle: 'Դուք պետք է լինեք գրանցված ուսուցիչ՝ այս էջը տեսնելու համար։', errorButton: 'Գլխավոր էջ', dashboardTitle: 'Ուսուցչի Վահանակ', dashboardSubtitle: 'Բարի գալուստ։ Ընտրեք խումբ՝ սկսելու համար։', groupsTitle: 'Իմ Խմբերը', groupsSelectDefault: 'Ընտրեք խումբ...', groupsNone: 'Դուք դեռ խմբեր չեք ստեղծել։', groupsCreateTitle: 'Ստեղծել Նոր Խումբ', groupsCreateLabel: 'Խմբի Անունը', groupsCreateButton: 'Ստեղծել Խումբ', groupsCreateSuccess: '«{groupName}» խումբը ստեղծված է։ Միանալու կոդը՝ {joinCode}', groupsCreateError: 'Սխալ՝ խումբ ստեղծելիս։ Խնդրում ենք փորձել նորից։', joinCode: 'Միանալու կոդ', resultsTitleDefault: 'Ընտրեք խումբ', resultsSelectPrompt: 'Ընտրեք խումբ ցանկից՝ մանրամասները տեսնելու համար։', resultsTitleLoading: 'Բեռնվում են «{groupName}» խմբի տվյալները...', resultsTitleLoaded: '«{groupName}» խմբի արդյունքները', resultsTitleSelectTest: 'Ընտրեք թեստ՝ արդյունքները տեսնելու համար', resultsNone: 'Այս թեստի համար արդյունքներ չկան։', rosterTitle: 'Աշակերտների Ցուցակ', rosterNone: 'Այս խմբին դեռ ոչ մի աշակերտ չի միացել։', testsTitle: 'Թեստեր', testsNone: 'Այս խումբը դեռ թեստեր չի հանձնել։', tabResults: '', tabRoster: '', tableStudent: 'Աշակերտ', tableTest: 'Թեստի ID', tableScore: 'Միավոր', tableTime: 'Ժամանակ', tableDate: 'Ամսաթիվ', tableTimeValue: '{time}վ', tableView: 'Դիտել', tableViewSr: 'Դիտել Մանրամասները'
        }
    };

    /** Shows notification toast */
    function showNotification(message, isError = false) {
        const toast = document.getElementById('notification-toast');
        const msgEl = document.getElementById('notification-message');
        if (!toast || !msgEl) return;
        msgEl.textContent = message;
        toast.classList.toggle('error', isError);
        toast.classList.remove('hidden');
        requestAnimationFrame(() => { toast.classList.add('show'); });
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toast.classList.add('hidden'); toast.classList.remove('error'); }, 300); 
        }, 3000);
    }

    /** Applies UI text based on language */
    function applyContent(lang) {
        const T = strings[lang];
        if (!T) return;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (T[key]) { el.innerHTML = T[key]; }
        });
        document.documentElement.lang = lang;
        langEnBtn.classList.toggle('active', lang === 'en');
        langHyBtn.classList.toggle('active', lang === 'hy');
       
        groupNameInput.placeholder = (lang === 'hy') ? 'օր.՝ Հանրահաշիվ 1 (Աշուն)' : 'e.g. Algebra 1 (Fall)';
        resultsNoneMsg.textContent = T.resultsNone;
        rosterNoneMsg.textContent = T.rosterNone;
        if (resultsPlaceholder) resultsPlaceholder.textContent = T.resultsSelectPrompt;
       
        const defaultTitleEls = document.querySelectorAll('[data-i18n="resultsTitleDefault"]');
        defaultTitleEls.forEach(el => el.textContent = T.resultsTitleDefault);
        if (!selectedGroupId) resultsTitle.textContent = T.resultsTitleDefault;

        // Removed selectedGroupText logic

        const tableHeaders = resultsTable.querySelectorAll('thead th[data-i18n]');
        tableHeaders.forEach(th => {
            const key = th.dataset.i18n;
             if (T[key]) { th.textContent = T[key]; }
        });
        const srViewHeader = resultsTable.querySelector('thead th span[data-i18n="tableViewSr"]');
         if (srViewHeader && T.tableViewSr) { srViewHeader.textContent = T.tableViewSr; }
    }

    /** Formats string with values */
    function formatString(str, values) { return str.replace(/{(\w+)}/g, (match, key) => values[key] || match); }

    /** Auth state change handler */
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("Auth state changed. User is present:", user.email);
            currentUser = user;
            try {
                const tutorDocRef = doc(db, "tutors", user.email);
                const tutorDoc = await getDoc(tutorDocRef);
                if (tutorDoc.exists()) {
                    currentTutor = { email: user.email, uid: user.uid, ...tutorDoc.data() };
                    await initDashboard();
                } else { console.warn("User is not listed:", user.email); showErrorState(); }
            } catch (err) { console.error("Error checking tutor:", err); showErrorState(); }
        } else { window.location.href = '/auth'; }
    });

    /** Shows error state */
    function showErrorState() { loadingState.classList.add('hidden'); errorState.classList.remove('hidden'); }

    /** Initializes dashboard */
    async function initDashboard() {
        loadingState.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
        const T = strings[currentLang];
        welcomeMessage.textContent = formatString(T.dashboardSubtitle, { tutorEmail: currentTutor.email });
        applyContent(currentLang);
        setupEventListeners(); await loadGroups();
    }

    /** Sets up event listeners */
    function setupEventListeners() {
        logoutBtn.addEventListener('click', handleLogout);
        langEnBtn.addEventListener('click', () => switchLanguage('en'));
        langHyBtn.addEventListener('click', () => switchLanguage('hy'));
        navCreateGroupBtn.addEventListener('click', showCreateGroupModal);
        navCreateGroupBtnMobile.addEventListener('click', showCreateGroupModal);
        createGroupBtn.addEventListener('click', showCreateGroupModal);
        createGroupBtnMobile.addEventListener('click', showCreateGroupModal);
        createGroupModalCloseBtn.addEventListener('click', hideCreateGroupModal);
        createGroupModalOverlay.addEventListener('click', (e) => { if (e.target === createGroupModalOverlay) hideCreateGroupModal(); });
        createGroupForm.addEventListener('submit', handleCreateGroup);
        tabBtnResults.addEventListener('click', () => switchTab('results'));
        tabBtnRoster.addEventListener('click', () => switchTab('roster'));
        // Removed modal and dropdown listeners
    }
   
    /** Switches active language */
    async function switchLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('thelo-lang', currentLang);
        applyContent(currentLang); // Apply text first
        
        // Await the reloading of groups to ensure `allGroups` is populated
        await loadGroups(selectedGroupId); 
       
        // If a group is selected, reload its data to update table dates/text
        if (selectedGroupId) {
            const selectedGroup = allGroups.find(g => g.id === selectedGroupId);
            if (selectedGroup) {
                loadGroupData(selectedGroup); // Reload table data etc.
            } 
            // No 'else' needed, as loadGroups will handle showing the empty state if the selected group is gone.
        }
    }

    /** Switches active tab */
    function switchTab(tabId) {
        const isActive = tabId === 'results';
        tabBtnResults.classList.toggle('active', isActive);
        tabPanelResults.classList.toggle('hidden', !isActive);
        tabBtnRoster.classList.toggle('active', !isActive);
        tabPanelRoster.classList.toggle('hidden', isActive);
    }
   
    /** Handles group selection from pill buttons */
    function handleGroupSelect(groupId) {
        // If clicking the same active group, deselect it
        if (groupId === selectedGroupId) {
            selectedGroupId = null;
            selectedTestId = null;
        } else {
            selectedGroupId = groupId;
        }

        // Update visual state of all pills
        document.querySelectorAll('#group-selection-container .thelo-btn-secondary').forEach(item => {
            item.classList.toggle('active', item.dataset.groupId === selectedGroupId);
        });

        if (!selectedGroupId) {
            showEmptyState();
            testSelectionContainer.classList.add('hidden');
            return;
        }
        
        const selectedGroup = allGroups.find(g => g.id === selectedGroupId);
        if (selectedGroup) {
            loadGroupData(selectedGroup);
        }
    }

    /** Resets the main panel to empty state */
    function showEmptyState() {
        const T = strings[currentLang];
        resultsTitle.textContent = T.resultsTitleDefault;
        testSelectionContainer.classList.add('hidden');
        selectedTestId = null;
        resultsEmptyState.classList.remove('hidden');
        resultsContent.classList.add('hidden');
    }

    /** Logs the user out */
    async function handleLogout(e) { e.preventDefault(); try { await signOut(auth); window.location.href = '/'; } catch (err) { console.error("Error logging out:", err); } }

    /** Loads groups into the pill container */
    async function loadGroups(preserveSelected = null) {
        allGroups = []; 
        const T = strings[currentLang];
        groupSelectionContainer.innerHTML = ''; // Clear pill container
       
        const q = query(collection(db, "groups"), where("ownerId", "==", currentUser.uid));
        try {
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                noGroupsMsg.classList.remove('hidden'); 
                groupSelectionContainer.classList.add('hidden'); 
                showEmptyState(); 
                return;
            }
           
            noGroupsMsg.classList.add('hidden'); 
            groupSelectionContainer.classList.remove('hidden'); 
           
            const groups = [];
            querySnapshot.forEach(doc => groups.push({ id: doc.id, ...doc.data() }));
            groups.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            let isPreservedSelected = preserveSelected && groups.some(g => g.id === preserveSelected);

            groups.forEach(group => {
                allGroups.push(group); // Keep track of all groups
                const item = document.createElement('button');
                item.className = 'thelo-btn-secondary'; // Use the same class as "Create Group"
                item.dataset.groupId = group.id;
                item.textContent = `${group.groupName} (Code: ${group.joinCode})`;
                item.classList.toggle('active', preserveSelected === group.id);
                item.onclick = () => handleGroupSelect(group.id);
                groupSelectionContainer.appendChild(item);
            });

            if (isPreservedSelected) {
                 selectedGroupId = preserveSelected; 
            } else {
                 selectedGroupId = null; 
                 if (!preserveSelected) showEmptyState(); 
            }

        } catch (err) { console.error("Error loading groups:", err); noGroupsMsg.textContent = "Error loading groups."; noGroupsMsg.classList.remove('hidden'); }
    }

    /** Generates join code */
    function generateJoinCode() { const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789'; let r = ''; for (let i = 0; i < 6; i++) r += chars.charAt(Math.floor(Math.random() * chars.length)); return r; }
    /** Shows create group modal */
    function showCreateGroupModal() { createGroupModalOverlay.classList.remove('hidden'); setTimeout(() => createGroupModalOverlay.classList.add('show'), 10); }
    /** Hides create group modal */
    function hideCreateGroupModal() { createGroupModalOverlay.classList.remove('show'); setTimeout(() => createGroupModalOverlay.classList.add('hidden'), 300); }

    /** Handles create group form submission */
    async function handleCreateGroup(e) {
        e.preventDefault();
        const groupName = groupNameInput.value.trim();
        if (!groupName) return;
       
        createGroupSubmitBtn.disabled = true;
        const T = strings[currentLang];
        createGroupSubmitBtn.querySelector('span').textContent = T.loadingSubmit; 
       
        const newGroup = { groupName, ownerId: currentUser.uid, ownerEmail: currentUser.email, joinCode: generateJoinCode(), createdAt: serverTimestamp(), memberIds: [] };
        try {
            const docRef = await addDoc(collection(db, "groups"), newGroup);
            showNotification(formatString(T.groupsCreateSuccess, { groupName: newGroup.groupName, joinCode: newGroup.joinCode }));
            groupNameInput.value = '';
            hideCreateGroupModal();
            await loadGroups(docRef.id); 
            handleGroupSelect(docRef.id); 

        } catch (err) { console.error("Error creating group:", err); showNotification(T.groupsCreateError, true);
        } finally { createGroupSubmitBtn.disabled = false; createGroupSubmitBtn.querySelector('span').textContent = T.groupsCreateButton; }
    }

    /** Loads data for the selected group */
    async function loadGroupData(group) { // <-- MODIFIED: Now fetches students first
        const T = strings[currentLang]; // Get current language strings
        resultsTitle.textContent = formatString(T.resultsTitleLoading, { groupName: group.groupName });
        resultsEmptyState.classList.add('hidden'); 
        resultsContent.classList.add('hidden'); // Hide results table initially
        testSelectionContainer.classList.remove('hidden'); // Show test selection area
        document.getElementById('test-list-container').innerHTML = ''; // Clear old tests
        document.getElementById('no-tests-msg').classList.add('hidden');
        rosterList.innerHTML = ''; 
        rosterNoneMsg.classList.add('hidden');
        studentNameMap.clear(); // Clear previous student data

        try {
            // Step 1: Fetch all students in the group and populate the roster and name map
            const studentsQuery = query(collection(db, "thelo-students"), where("groupId", "==", group.id));
            const studentSnapshot = await getDocs(studentsQuery);
            
            if (studentSnapshot.empty) { 
                rosterList.appendChild(rosterNoneMsg); 
                rosterNoneMsg.classList.remove('hidden'); 
            } else {
                studentSnapshot.forEach(doc => { const el = document.createElement('span'); el.className = 'block text-sm text-slate-700'; el.textContent = doc.data().email; rosterList.appendChild(el); });
                studentSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    const fullName = `${studentData.name || ''} ${studentData.surname || ''}`.trim();
                    studentNameMap.set(studentData.email, fullName || studentData.email); // Fallback to email
                    const el = document.createElement('span'); 
                    el.className = 'block text-sm text-slate-700'; 
                    el.textContent = fullName || studentData.email; // Display full name in roster
                    rosterList.appendChild(el);
                });
            }

            // Step 2: Fetch all test results for the group
            const resultsQuery = query(collection(db, "thelo-test-results"), where("groupId", "==", group.id));
            const resultsSnapshot = await getDocs(resultsQuery);
            
            if (resultsSnapshot.empty) {
                document.getElementById('no-tests-msg').classList.remove('hidden');
                resultsTitle.textContent = formatString(T.resultsTitleLoaded, { groupName: group.groupName });
            } else {
                const results = [];
                resultsSnapshot.forEach(doc => results.push({ id: doc.id, ...doc.data() }));
                
                // Find unique test IDs
                const uniqueTestIds = [...new Set(results.map(r => r.testId))];
                
                const testListContainer = document.getElementById('test-list-container');
                uniqueTestIds.forEach(testId => {
                    const btn = document.createElement('button');
                    btn.className = 'thelo-btn-secondary';
                    btn.dataset.testId = testId;
                    btn.textContent = testId;
                    btn.onclick = () => {
                        testListContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        selectedTestId = testId;
                        loadTestResults(testId, results, group.groupName);
                    };
                    testListContainer.appendChild(btn);
                });

                resultsTitle.textContent = T.resultsTitleSelectTest;
            }
        } catch (err) { console.error("Error loading group data:", err); resultsTitle.textContent = "Error loading data"; resultsNoneMsg.textContent = "Error loading results."; resultsNoneMsg.classList.remove('hidden'); }
    }

    /** Loads and displays results for a specific test */
    function loadTestResults(testId, allResults, groupName) { // <-- MODIFIED: Now uses studentNameMap
        const T = strings[currentLang];
        resultsContent.classList.remove('hidden');
        switchTab('results');
        resultsTableBody.innerHTML = '';

        const testResults = allResults.filter(r => r.testId === testId);

        if (testResults.length === 0) {
            resultsNoneMsg.classList.remove('hidden');
            resultsTable.classList.add('hidden');
        } else {
            resultsNoneMsg.classList.add('hidden');
            testResults.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));
            testResults.forEach(result => renderResultRow(result));
            resultsTable.classList.remove('hidden');
        }
        resultsTitle.textContent = formatString(T.resultsTitleLoaded, { groupName: `${groupName} / ${testId}` });
    }

    /** Renders a single result row */
    function renderResultRow(result) {
        const T = strings[currentLang];
        const row = document.createElement('tr'); row.className = 'hover:bg-slate-50';
        const scoreText = `${result.score} / ${result.totalQuestions}`;
        const timeText = formatString(T.tableTimeValue, { time: result.timeTakenSeconds });
        const dateText = result.submittedAt ? result.submittedAt.toDate().toLocaleString(currentLang.startsWith('hy') ? 'hy-AM' : 'en-US') : 'N/A';
        const studentName = studentNameMap.get(result.email) || result.email; // Get name from map, fallback to email

        // MODIFIED: The button is now an anchor tag linking to the new details page.
        const viewButtonHtml = `
            <a href="/tdtest?id=${result.id}" target="_blank" class="thelo-btn-secondary-sm">
                ${T.tableView}
            </a>`;

        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${studentName}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.testId}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${scoreText}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${timeText}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${dateText}</td> <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${viewButtonHtml}</td>`;
        resultsTableBody.appendChild(row);
    }

    // Initial language setup
    applyContent(currentLang);

</script>

</body>
</html>
