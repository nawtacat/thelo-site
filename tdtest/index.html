<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Test Result | thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <style>
    /*
     * ============================================
     * Custom Font Definitions for Armenian (Montserrat Arm)
     * ============================================
     */
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype');
      font-weight: 400; /* Regular */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-SemiBold.otf') format('opentype');
      font-weight: 600; /* SemiBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-ExtraBold.otf') format('opentype');
      font-weight: 800; /* ExtraBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }

    /*
     * ============================================
     * Main Site Styles (Copied from Dashboard)
     * ============================================
     */
    :root {
        --thelo-blue: #2563EB;
        --thelo-bg: #F8F9FA;
        --thelo-text: #111827;
        --grid-color: #E5E7EB;
    }
    html { scroll-behavior: smooth; }
    body {
        font-family: 'Montserrat Arm', 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--thelo-bg);
        color: var(--thelo-text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-image:
            linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 40px 40px;
        min-height: 100vh;
    }

    h1, h2, h3, h4, h5, h6 { font-weight: 800; }

    .nav-link { 
        @apply font-semibold text-[var(--thelo-text)] transition-colors duration-200;
    }
    .nav-link:hover { 
        color: var(--thelo-blue); 
    }

    .window-container {
        position: relative;
        background-color: white;
        border: 1px solid var(--grid-color);
        border-radius: 0.75rem; 
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
        padding: 2.5rem; 
    }
    .window-container::before {
        content: ' ';
        position: absolute;
        top: 1.5rem; 
        left: 1.5rem; 
        width: 52px;
        height: 12px;
        background-image: url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E%0A");
        background-repeat: no-repeat;
        z-index: 1;
    }
    
    /* Button Styles (Kept for consistency) */
    .thelo-btn-secondary {
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        cursor: pointer; 
        background-color: transparent;
        color: var(--thelo-blue);
        border-color: var(--thelo-blue);
    }
    .thelo-btn-secondary:hover {
        background-color: var(--thelo-blue);
        color: white;
    }

    /* Language Button Styles */
    .lang-btn {
        @apply cursor-pointer font-bold text-slate-400;
    }
    .lang-btn.active {
        @apply text-[var(--thelo-blue)];
    }
    
    /* Question Detail Styles (Copied from Dashboard) */
    .question-label { 
        @apply block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2; /* Default to bold (700) for English */
    }    
    .student-solution-img { @apply w-full h-auto bg-white border border-slate-300 rounded-md object-contain; }
    .feedback-text { @apply p-3 bg-slate-50 rounded-md text-slate-700 text-sm prose max-w-none; }
    .question-status-correct { @apply inline-block text-sm font-bold bg-green-100 text-green-700 px-3 py-1 rounded-full; }
    .question-status-incorrect { @apply inline-block text-sm font-bold bg-red-100 text-red-700 px-3 py-1 rounded-full; }
  </style>
</head>

<body class="antialiased">

<!-- Navbar: Updated with language switcher and button ID -->
<nav id="mainNav" class="w-full z-40"> 
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-6 lg:px-8">
        <a href="/" class="flex items-center gap-2">
            <img src="https://thelo.space/img/bluethelo.svg" alt="thelo logo" class="h-12 w-auto" />
        </a>
        
        <div class="flex items-center gap-4">
            <a href="https://thelo.space/tdashboard" id="back-to-dashboard-btn" class="thelo-btn-secondary" data-i18n="navBackToDashboard">
                Back to Dashboard
            </a>
            <!-- Language Switcher -->
            <div class="flex items-center gap-2 text-sm border-l pl-4 ml-2">
                <span id="lang-en" class="lang-btn">EN</span>
                <span class="text-slate-300">|</span>
                <span id="lang-hy" class="lang-btn">HY</span>
            </div>
        </div>
    </div>
</nav>

<!-- 
  MAIN CONTENT: 
  This is now a wrapper with a loading state and an empty content block.
  The JavaScript will fill this in.
-->
<main class="pt-12 pb-16 lg:pt-16 lg:pb-24">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20">
            <h2 class="text-2xl font-bold text-slate-600" data-i18n="loading">Loading Result Details...</h2>
        </div>

        <!-- Main Content (Hidden by default) -->
        <div id="main-content" class="hidden">
        
            <!-- Page Header -->
            <div class="mb-12">
                <h1 class="text-4xl font-extrabold tracking-tighter text-[var(--thelo-text)] sm:text-5xl" data-i18n="pageTitle">Test Result Details</h1>
                <!-- This <p> tag will be filled by JS -->
                <p class="text-lg text-slate-600 mt-4" id="page-subtitle"></p>
            </div>

            <!-- Summary Card (First "Floating Window") -->
            <div class="window-container mb-12">
                 <!-- pt-10 is added to avoid the traffic lights -->
                <div class="mt-4 pt-10 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="summaryStudent">Student</span>
                        <!-- This <span> will be filled by JS -->
                        <span class="block font-medium text-slate-800" id="summary-student-email">...</span>
                    </div>
                    <div>
                        <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="summaryTestID">Test ID</span>
                        <span class="block font-medium text-slate-800" id="summary-test-id">...</span>
                    </div>
                    <div>
                        <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="summaryScore">Score</span>
                        <span class="block font-medium text-slate-800" id="summary-score">...</span>
                    </div>
                    <div>
                        <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="summaryTime">Time Taken</span>
                        <span class="block font-medium text-slate-800" id="summary-time">...</span>
                    </div>
                </div>
            </div>


            <!-- Question Breakdown -->
            <h2 class="text-3xl font-bold mb-8" data-i18n="breakdownTitle">Question Breakdown</h2>
            
            <!-- 
              This container will be dynamically filled by the script.
            -->
            <div id="question-breakdown-container" class="space-y-12">
                <!-- JavaScript will add question cards here -->
            </div>

        </div> <!-- /#main-content -->

    </div>
</main>


<!-- 
  ============================================
  DYNAMIC SCRIPT
  ============================================
  This script fetches and renders all the data
  for this page.
-->
<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Config (Copied from your dashboard)
    const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", projectId: "physmathacademy-722b3", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    try { setLogLevel('debug'); } catch (e) { console.warn("Could not set Firestore log level:", e); }

    // --- DOM Elements ---
    const loadingState = document.getElementById('loading-state');
    const mainContent = document.getElementById('main-content');
    const pageSubtitle = document.getElementById('page-subtitle');
    const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
    
    // Summary Card Elements
    const summaryStudentEmail = document.getElementById('summary-student-email');
    const summaryTestId = document.getElementById('summary-test-id');
    const summaryScore = document.getElementById('summary-score');
    const summaryTime = document.getElementById('summary-time');
    
    // Question List Container
    const questionBreakdownContainer = document.getElementById('question-breakdown-container');
    
    // Language Elements
    const langEnBtn = document.getElementById('lang-en');
    const langHyBtn = document.getElementById('lang-hy');

    // --- App State ---
    let currentLang = localStorage.getItem('thelo-lang') || 'en';

    // --- UI Strings (i18n) ---
    const strings = {
        en: {
            title: 'Test Result | thelo',
            navBackToDashboard: 'Back to Dashboard',
            loading: 'Loading Result Details...',
            errorTitle: 'Result Not Found',
            errorSubtitle: 'Could not find a result with the specified ID. Please check the link and try again.',
            pageTitle: 'Test Result Details',
            pageSubtitle: 'Viewing result for <strong class="text-slate-800">{email}</strong>',
            summaryStudent: 'Student',
            summaryTestID: 'Test ID',
            summaryScore: 'Score',
            summaryTime: 'Time Taken',
            breakdownTitle: 'Question Breakdown',
            questionTitle: 'Question {index}',
            solutionTitle: "Student's Solution",
            feedbackTitle: 'Feedback & Details',
            statusCorrect: 'Correct',
            statusIncorrect: 'Incorrect',
            labelSolution: "Student's Solution",
            labelFeedback: 'AI Feedback',
            labelQuestion: 'Question',
            labelCorrectAnswer: 'Correct Answer',
            tableTimeValue: '{time}s', // Used for summary
            noFeedback: 'No feedback provided.',
            noQuestion: 'N/A',
            noAnswer: 'N/A'
        },
        hy: {
            title: 'Թեստի Արդյունք | Թելո',
            navBackToDashboard: 'Վերադառնալ',
            loading: 'Բեռնվում են Արդյունքները...',
            errorTitle: 'Արդյունքը Չի Գտնվել',
            errorSubtitle: 'Նշված ID-ով արդյունք չի գտնվել։ Խնդրում ենք ստուգել հղումը։',
            pageTitle: 'Թեստի Արդյունքներ',
            pageSubtitle: 'Դիտում եք <strong class="text-slate-800">{email}</strong>-ի արդյունքը',
            summaryStudent: 'Աշակերտ',
            summaryTestID: 'Թեստի ID',
            summaryScore: 'Միավոր',
            summaryTime: 'Ծախսած Ժամանակ',
            breakdownTitle: 'Հարցերի Վերլուծություն',
            questionTitle: 'Հարց {index}',
            solutionTitle: 'Աշակերտի Լուծումը',
            feedbackTitle: 'Կարծիք և Մանրամասներ',
            statusCorrect: 'Ճիշտ է',
            statusIncorrect: 'Սխալ է',
            labelSolution: 'Աշակերտի Լուծումը',
            labelFeedback: 'AI-ի Կարծիքը',
            labelQuestion: 'Հարց',
            labelCorrectAnswer: 'Ճիշտ Պատասխան',
            tableTimeValue: '{time}վ', // Used for summary
            noFeedback: 'Կարծիք չի տրամադրվել։',
            noQuestion: 'N/A',
            noAnswer: 'N/A'
        }
    };
    
    /** Formats string with values */
    function formatString(str, values) { 
        if (!str) return '';
        return str.replace(/{(\w+)}/g, (match, key) => values[key] || match); 
    }

    /** Applies UI text based on language */
    function applyContent(lang) {
        const T = strings[lang];
        if (!T) return;
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (T[key]) { el.innerHTML = T[key]; }
        });
        
        document.documentElement.lang = lang;
        document.title = T.title;
        langEnBtn.classList.toggle('active', lang === 'en');
        langHyBtn.classList.toggle('active', lang === 'hy');

        // Apply text to elements without data-i18n
        if (backToDashboardBtn) backToDashboardBtn.textContent = T.navBackToDashboard;
    }

    /** Switches active language */
    function switchLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('thelo-lang', currentLang);
        applyContent(currentLang);
        // Re-load data to get localized strings
        const urlParams = new URLSearchParams(window.location.search);
        const resultId = urlParams.get('id');
        if (resultId) {
            loadResultData(resultId);
        }
    }

    /** Renders the top summary card */
    function renderSummary(resultData) {
        const T = strings[currentLang];
        pageSubtitle.innerHTML = formatString(T.pageSubtitle, { email: resultData.email });
        summaryStudentEmail.textContent = resultData.email;
        summaryTestId.textContent = resultData.testId;
        summaryScore.textContent = `${resultData.score} / ${resultData.totalQuestions}`;
        summaryTime.textContent = formatString(T.tableTimeValue, { time: resultData.timeTakenSeconds });
        
        // Update summary labels
        document.querySelector('[data-i18n="summaryStudent"]').textContent = T.summaryStudent;
        document.querySelector('[data-i18n="summaryTestID"]').textContent = T.summaryTestID;
        document.querySelector('[data-i18n="summaryScore"]').textContent = T.summaryScore;
        document.querySelector('[data-i18n="summaryTime"]').textContent = T.summaryTime;
    }

    /** Renders a single question section */
    function renderQuestion(questionData, index) {
        const T = strings[currentLang];
        
        // Determine status
        let statusClass = '', statusText = '';
        if (questionData.status === 'correct') { 
            statusClass = 'question-status-correct'; 
            statusText = T.statusCorrect; 
        } else if (questionData.status === 'incorrect') { 
            statusClass = 'question-status-incorrect'; 
            statusText = T.statusIncorrect; 
        }
        
        const questionTitle = formatString(T.questionTitle, { index: index });

        const section = document.createElement('section');
        // Handle potential errors for images, providing a fallback
        const solutionImage = questionData.solutionImage || 'https://placehold.co/400x300/e2e8f0/94a3b8?text=No+Solution+Image';
        
        section.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">${questionTitle}</h3>
                ${statusText ? `<span class="${statusClass}">${statusText}</span>` : ''}
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                
                <!-- Solution Card -->
                <div class="lg:col-span-2">
                    <div class="window-container">
                         <!-- pt-10 to clear traffic lights -->
                        <h4 class="text-lg font-bold pt-10">${T.solutionTitle}</h4>
                        <a href="${solutionImage}" target="_blank" rel="noopener noreferrer">
                            <img 
                                src="${solutionImage}" 
                                alt="Student solution for ${questionTitle}" 
                                class="student-solution-img mt-4 cursor-pointer"
                                onerror="this.src='https://placehold.co/400x300/e2e8f0/94a3b8?text=Image+Load+Error'; this.onerror=null;"
                            >
                        </a>
                    </div>
                </div>

                <!-- Feedback Card -->
                <div class="lg:col-span-3">
                    <div class="window-container">
                        <!-- pt-10 to clear traffic lights -->
                        <h4 class="text-lg font-bold pt-10">${T.feedbackTitle}</h4>
                        
                        <div class="mt-4 space-y-6">
                            <div>
                                <span class="question-label">${T.labelFeedback}</span>
                                <div class="feedback-text">
                                    <p>${questionData.feedback || T.noFeedback}</p>
                                ...</div>
                            </div>
                            
                            <div>
                                <span class="question-label">${T.labelQuestion}</span>
                                <div class="feedback-text">
                                    <p>${questionData.question || T.noQuestion}</p>
                                </div>
                            </div>
                            
                            <div>
                                <span class="question-label">${T.labelCorrectAnswer}</span>
                                <div class="feedback-text">
                                    <p>${questionData.correctAnswer || T.noAnswer}</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        `;
        questionBreakdownContainer.appendChild(section);
    }
    
    /** Shows a full-page error */
    function showError(title, message) {
        const T = strings[currentLang];
        loadingState.innerHTML = `
            <h2 class="text-3xl font-bold text-red-600">${title || T.errorTitle}</h2>
            <p class="text-lg text-slate-600 mt-4">${message || T.errorSubtitle}</p>
        `;
        loadingState.classList.remove('hidden');
        mainContent.classList.add('hidden');
    }

    /** Main function to load all data */
    async function loadResultData(resultId) {
        try {
            // 1. Fetch the main result document
            const resultDocRef = doc(db, "thelo-test-results", resultId);
            const resultDoc = await getDoc(resultDocRef);

            if (!resultDoc.exists()) {
                showError();
                return;
            }
            
            const resultData = { id: resultDoc.id, ...resultDoc.data() };
            
            // 2. Fetch all question results from the sub-collection
            const questionsQuery = query(collection(db, "thelo-test-results", resultId, "results"));
            const questionsSnapshot = await getDocs(questionsQuery);
            
            const questions = [];
            questionsSnapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));
            // Sort questions by their ID, which is assumed to be a number (e.g., "0", "1", "2")
            questions.sort((a, b) => parseInt(a.id) - parseInt(b.id));

            // 3. Render the page
            renderSummary(resultData);
            
            questionBreakdownContainer.innerHTML = ''; // Clear any static content
            questions.forEach((q, index) => {
                renderQuestion(q, index + 1);
            });

            // 4. Show the content
            loadingState.classList.add('hidden');
            mainContent.classList.remove('hidden');

        } catch (err) {
            console.error("Error loading result data:", err);
            showError("An Error Occurred", "There was a problem loading the test results. Please try again later.");
        }
    }

    // --- INITIALIZATION ---
    
    // 1. Apply language first
    applyContent(currentLang);
    
    // 2. Setup language listeners
    langEnBtn.addEventListener('click', () => switchLanguage('en'));
    langHyBtn.addEventListener('click', () => switchLanguage('hy'));

    // 3. Get Result ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const resultId = urlParams.get('id');

    // 4. Load data
    if (resultId) {
        loadResultData(resultId);
    } else {
        showError(); // Show "Result Not Found"
    }

</script>

</body>
</html>
