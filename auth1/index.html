<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Authentication</title>
<link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
:root{--thelo-blue:#2563EB;--thelo-bg:#F8F9FA;--thelo-text:#111827;--grid-color:#E5E7EB}
body{
    font-family:'Manrope',system-ui,-apple-system,'Segoe UI','Helvetica Neue',Arial,sans-serif;
    background:var(--thelo-bg);
    color:var(--thelo-text);
    background-image:
        linear-gradient(to right,var(--grid-color) 1px,transparent 1px),
        linear-gradient(to bottom,var(--grid-color) 1px,transparent 1px);
    background-size:40px 40px;
    min-height:100vh;
    display:flex;align-items:center;justify-content:center;
    padding:1.5rem;
}
html[lang="hy"] body{font-family:'Noto Serif Armenian',serif}

.window-container{
    background:#fff;border:1px solid var(--grid-color);border-radius:.75rem;
    padding:2.5rem;box-shadow:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
    position:relative;
    max-width:480px;
    width:100%}
.window-container::before{
    content:"";position:absolute;top:1rem;left:1rem;width:52px;height:12px;
    background-image:url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E")}
.form-input{width:100%;border-radius:.5rem;border:1px solid #D1D5DB;background:#fff;
    padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.05);
    transition:border-color .2s,box-shadow .2s}
.form-input:focus{border-color:var(--thelo-blue);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.2)}
#submitBtn{grid-column:1/-1}
.form-button:disabled{opacity:.7;cursor:not-allowed}
@media(max-width:640px){
    .fixed.top-4.left-4,.fixed.top-4.right-4{top:.5rem;font-size:.75rem;padding:.25rem .5rem}
    .fixed.top-4.left-4{left:.5rem}.fixed.top-4.right-4{right:.5rem}}

/* ===== STYLES for Character Selection ===== */
.char-option {
    cursor: pointer;
    border-radius: 9999px; /* pill shape */
    border: 3px solid transparent;
    transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out;
    background-color: #f0f0f0; /* A light background for the images */
}
.char-option:hover {
    transform: scale(1.08);
}
.char-option.selected {
    border-color: var(--thelo-blue);
    transform: scale(1.08);
    box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
}

/* ===== NEW STYLES for Account Type ===== */
.account-type-btn {
    flex: 1; /* Make buttons share space */
    padding: 0.75rem 1rem;
    border: 2px solid #D1D5DB; /* default border */
    border-radius: 0.5rem;
    font-weight: 700;
    color: #6B7280; /* text-slate-500 */
    background-color: #F9FAFB; /* bg-slate-50 */
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}
.account-type-btn:hover {
    border-color: #9CA3AF; /* border-slate-400 */
    color: #374151; /* text-slate-700 */
}
.account-type-btn.selected {
    border-color: var(--thelo-blue);
    background-color: #EFF6FF; /* blue-50 */
    color: var(--thelo-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

/* ===== NEW UTILITY STYLES (converted from Tailwind) ===== */
.page-header-link { position: fixed; top: 1rem; left: 1rem; font-size: 0.875rem; font-weight: 600; color: #6B7280; }
.page-header-link:hover { color: var(--thelo-blue); }
.lang-toggle-btn { position: fixed; top: 1rem; right: 1rem; border-radius: 0.375rem; border: 1px solid #D1D5DB; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; color: #4B5563; }
.lang-toggle-btn:hover { background-color: #F3F4F6; }

.form-title { font-size: 1.5rem; line-height: 2rem; font-weight: 800; margin-bottom: 0.75rem; text-align: center; }
.welcome-p { text-align: center; font-size: 0.875rem; line-height: 1.25rem; color: #4B5563; margin-bottom: 1.5rem; }

.auth-form { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); row-gap: 1rem; }

.form-label { display: block; font-size: 0.875rem; line-height: 1.25rem; font-weight: 700; margin-bottom: 0.25rem; }
.account-type-container { display: flex; gap: 0.75rem; }
.avatar-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 0.75rem; justify-items: center; }

.submit-btn {
    margin-top: 0.5rem;
    border-radius: 0.5rem;
    background-color: var(--thelo-blue);
    padding: 0.75rem 2rem;
    font-weight: 700;
    color: #fff;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    transition: transform 0.15s ease-in-out;
    border: none;
    cursor: pointer;
}
.submit-btn:hover { transform: scale(1.05); }
.submit-btn:disabled { opacity: 0.7; cursor: not-allowed; }

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--thelo-blue);
    border-radius: 50%;
    width: 1.5rem;
    height: 1.5rem;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-left: 0.5rem;
    vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }

.toggle-auth-container { text-align: center; font-size: 0.875rem; line-height: 1.25rem; margin-top: 1.5rem; }
.toggle-auth-link { font-weight: 600; color: var(--thelo-blue); }
.toggle-auth-link:hover { text-decoration: underline; }

.toast-message { margin-top: 1.5rem; text-align: center; font-size: 0.875rem; line-height: 1.25rem; }
.toast-error { color: #DC2626; }
.toast-success { color: #16A34A; }
.hidden { display: none; }

@media (min-width: 640px) {
    .avatar-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); }
}
/* ===== END UTILITY STYLES ===== */

</style>
</head>

<body>
<a href="/" class="page-header-link">
    <span id="homeArrow">←</span> <span id="homeLink">Home</span></a>
<button id="langToggle" class="lang-toggle-btn">Հայ</button>

<div id="authWindowContainer" class="window-container">
    <h2 id="formTitle" class="form-title">Sign In</h2>
    <p id="welcomeMessage" class="welcome-p"></p>

    <form id="authForm" class="auth-form">

        <div id="accountTypeDiv" class="hidden">
            <label id="labelAccountType" class="form-label">I am a:</label>
            <div class="account-type-container">
                <button type="button" id="btn-student" class="account-type-btn selected">Student</button>
                <button type="button" id="btn-tutor" class="account-type-btn">Tutor</button>
            </div>
        </div>

        <div id="fullNameDiv" class="hidden">
            <label id="labelFullName" class="form-label" for="fullName">Full Name</label>
            <input id="fullName" type="text" class="form-input">
        </div>

        <div id="avatarDiv" class="hidden">
            <label id="labelAvatar" class="form-label">Choose Your Character</label>
            <div id="avatarGrid" class="avatar-grid"></div>
        </div>

        <div id="emailDiv">
            <label id="labelEmail" class="form-label" for="email">Email</label>
            <input id="email" type="email" class="form-input" required>
        </div>

        <div id="passwordDiv">
            <label id="labelPassword" class="form-label" for="password">Password</label>
            <input id="password" type="password" class="form-input" required>
        </div>

        <button id="submitBtn" type="submit" class="submit-btn">
            Sign In
        </button>
    </form>

    <div class="toggle-auth-container">
        <a href="#" id="toggleAuthModeLink" class="toggle-auth-link"></a>
    </div>

    <p id="toast" class="toast-message hidden"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
// UPDATED: Added getDoc import
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const firebaseConfig = {
    // IMPORTANT: SECURE YOUR API KEYS USING FIREBASE APP CHECK
    apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
    authDomain: "physmathacademy-722b3.firebaseapp.com",
    projectId: "physmathacademy-722b3",
    storageBucket: "physmathacademy-722b3.appspot.com",
    appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const TXT = {
    en: {
        home: "Home",
        signInTitle: "Sign In to thelo",
        signUpTitle: "Create Your Account",
        signInBtn: "Sign In",
        signUpBtn: "Create Account",
        welcomeMessageSignIn: "Welcome back! Please enter your details.",
        welcomeMessageSignUp: "Join thelo to start your journey.",
        email: "Email",
        password: "Password",
        fullName: "Full Name",
        avatar: "Choose Your Character",
        toggleToSignUp: "Don't have an account? Sign Up",
        toggleToSignIn: "Already have an account? Sign In",
        accountType: "I am a:", // NEW
        student: "Student",     // NEW
        tutor: "Tutor"          // NEW
    },
    hy: {
        home: "Գլխավոր",
        signInTitle: "Մուտք գործել thelo",
        signUpTitle: "Ստեղծել Հաշիվ",
        signInBtn: "Մուտք",
        signUpBtn: "Ստեղծել Հաշիվ",
        welcomeMessageSignIn: "Ուրախ ենք Ձեզ նորից տեսնել։",
        welcomeMessageSignUp: "Միացեք thelo-ին՝ սկսելու ձեր ճամփորդությունը։",
        email: "Էլ-փոստ",
        password: "Գաղտնաբառ",
        fullName: "Անուն Ազգանուն",
        avatar: "Ընտրեք Ձեր Նկարը",
        toggleToSignUp: "Չունե՞ք հաշիվ։ Գրանցվել",
        toggleToSignIn: "Արդեն ունե՞ք հաշիվ։ Մուտք",
        accountType: "Ես",     // NEW
        student: "Աշակերտ",     // NEW
        tutor: "Ուսուցիչ"       // NEW
    }
};

let lang = 'en';
let isSignUpMode = false;
let selectedAvatarUrl = '';
let selectedAccountType = 'student'; // NEW: Default to student

const langBtn = document.getElementById('langToggle');
const homeLink = document.getElementById('homeLink');
const form = document.getElementById('authForm');
const formTitle = document.getElementById('formTitle');
const welcomeMessage = document.getElementById('welcomeMessage');
const submitBtn = document.getElementById('submitBtn');
const toast = document.getElementById('toast');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const fullNameInput = document.getElementById('fullName');
const fullNameDiv = document.getElementById('fullNameDiv');
const labelEmail = document.getElementById('labelEmail');
const labelPassword = document.getElementById('labelPassword');
const labelFullName = document.getElementById('labelFullName');
const toggleAuthModeLink = document.getElementById('toggleAuthModeLink');
const avatarDiv = document.getElementById('avatarDiv');
const avatarGrid = document.getElementById('avatarGrid');
const labelAvatar = document.getElementById('labelAvatar');

// ===== NEW: Account Type DOM Elements =====
const accountTypeDiv = document.getElementById('accountTypeDiv');
const labelAccountType = document.getElementById('labelAccountType');
const btnStudent = document.getElementById('btn-student');
const btnTutor = document.getElementById('btn-tutor');


function updateFormUI() {
    const s = TXT[lang];
    if (isSignUpMode) {
        formTitle.textContent = s.signUpTitle;
        welcomeMessage.textContent = s.welcomeMessageSignUp;
        submitBtn.textContent = s.signUpBtn;
        toggleAuthModeLink.textContent = s.toggleToSignIn;
        // Show all sign-up fields
        accountTypeDiv.classList.remove('hidden'); // NEW
        fullNameDiv.classList.remove('hidden');
        
        // NEW: Only show avatar if student is selected
        if (selectedAccountType === 'student') {
            avatarDiv.classList.remove('hidden');
        } else {
            avatarDiv.classList.add('hidden');
        }
        
        fullNameInput.required = true;
    } else {
        formTitle.textContent = s.signInTitle;
        welcomeMessage.textContent = s.welcomeMessageSignIn;
        submitBtn.textContent = s.signInBtn;
        toggleAuthModeLink.textContent = s.toggleToSignUp;
        // Hide all sign-up fields
        accountTypeDiv.classList.add('hidden'); // NEW
        fullNameDiv.classList.add('hidden');
        avatarDiv.classList.add('hidden');
        
        fullNameInput.required = false;
    }
}

function applyLang() {
    const s = TXT[lang];
    document.documentElement.lang = lang;
    langBtn.textContent = lang === 'en' ? 'Հայ' : 'EN';
    homeLink.textContent = s.home;
    labelEmail.textContent = s.email;
    labelPassword.textContent = s.password;
    labelFullName.textContent = s.fullName;
    labelAvatar.textContent = s.avatar;
    // ===== NEW: Translate new fields =====
    labelAccountType.textContent = s.accountType;
    btnStudent.textContent = s.student;
    btnTutor.textContent = s.tutor;
    
    updateFormUI();
}

function showToast(message, isError = true) {
    toast.textContent = message;
    toast.classList.remove('hidden', 'toast-error', 'toast-success');
    toast.classList.add(isError ? 'toast-error' : 'toast-success');
}

function hideToast() {
    toast.classList.add('hidden');
    toast.textContent = '';
}

function setLoading(isLoading) {
    const btnText = isSignUpMode ? TXT[lang].signUpBtn : TXT[lang].signInBtn;
    if (isLoading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `${btnText}... <span class="loading-spinner"></span>`;
    } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = btnText;
    }
}

function handleAvatarSelection(e) {
    avatarGrid.querySelectorAll('.char-option').forEach(img => img.classList.remove('selected'));
    const clickedImg = e.target;
    clickedImg.classList.add('selected');
    selectedAvatarUrl = clickedImg.dataset.url;
}

function populateAvatars() {
    for (let i = 1; i <= 6; i++) {
        const imgUrl = `https://thelo.space/img/char${i}.png`;
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = `Character ${i}`;
        img.dataset.url = imgUrl;
        img.className = 'char-option'; /* Classes moved to CSS */
        img.addEventListener('click', handleAvatarSelection);
        avatarGrid.appendChild(img);
    }
}

/**
 * ===== MODIFIED: Handles new user sign-up for BOTH students and tutors =====
 */
async function handleNewUserSignUp(email, password, fullName, avatarUrl, accountType) {
    try {
        // Step 1: Create user in Authentication
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Step 2: Send verification email
        await sendEmailVerification(user);

        const nameParts = fullName.split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';

        // ===== NEW: Step 3: Create profile in Firestore based on account type =====
        if (accountType === 'student') {
            // --- Create a Student Document (by UID) ---
            await setDoc(doc(db, "thelo-students", user.uid), {
                name: firstName,
                surname: lastName,
                email: user.email,
                language: lang,
                profilePicture: avatarUrl, // Student gets an avatar
                points: 0,
                lessonsCompleted: 0,
                groupId: null,
                createdAt: serverTimestamp(),
                streakData: { currentStreak: 0, longestStreak: 0, lastActivityWeek: null },
                visionUsage: { count: 0, month: new Date().toISOString().slice(0, 7) }
            });
            
            await addDoc(collection(db, "analytics_events"), {
                type: "student_signed_up", // Specific analytics event
                userId: user.uid,
                timestamp: serverTimestamp(),
                signupLanguage: lang
            });

        } else if (accountType === 'tutor') {
            // --- Create a Tutor Document (by Email, as per tutor dashboard logic) ---
            await setDoc(doc(db, "tutors", user.email), {
                uid: user.uid,
                email: user.email,
                fullName: fullName,
                createdAt: serverTimestamp()
            });
            
            await addDoc(collection(db, "analytics_events"), {
                type: "tutor_signed_up", // Specific analytics event
                userId: user.uid,
                timestamp: serverTimestamp(),
                signupLanguage: lang
            });
        }
        
        console.log(`Successfully created ${accountType} and sent verification email.`);
        showToast("Account created! Please check your inbox to verify your email.", false);
        setLoading(false); // Stop loading but don't redirect
        setTimeout(() => { location.reload(); }, 5000);

    } catch (error) {
        console.error("Sign up error:", error);
        let errorMessage = "An unknown error occurred during sign up.";
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = "This email is already in use. Please sign in or use a different email.";
        } else if (error.code === 'auth/weak-password') {
            errorMessage = "Password is too weak. It should be at least 6 characters.";
        }
        showToast(errorMessage, true);
        setLoading(false);
    }
}

// --- Event Listeners ---

langBtn.addEventListener('click', () => { lang = lang === 'en' ? 'hy' : 'en'; applyLang(); });

toggleAuthModeLink.addEventListener('click', (e) => {
    e.preventDefault();
    isSignUpMode = !isSignUpMode;
    form.reset();
    hideToast();
    // Reset selections
    selectedAvatarUrl = '';
    avatarGrid.querySelectorAll('.char-option').forEach(img => img.classList.remove('selected'));
    selectedAccountType = 'student'; // NEW: Reset to default
    btnStudent.classList.add('selected'); // NEW
    btnTutor.classList.remove('selected'); // NEW
    
    updateFormUI();
});

// ===== NEW: Event listeners for account type buttons =====
btnStudent.addEventListener('click', () => {
    selectedAccountType = 'student';
    btnStudent.classList.add('selected');
    btnTutor.classList.remove('selected');
    avatarDiv.classList.remove('hidden'); // Show avatar grid for students
});

btnTutor.addEventListener('click', () => {
    selectedAccountType = 'tutor';
    btnTutor.classList.add('selected');
    btnStudent.classList.remove('selected');
    avatarDiv.classList.add('hidden'); // Hide avatar grid for tutors
});


form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideToast();
    setLoading(true);

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (isSignUpMode) {
        const fullName = fullNameInput.value.trim();
        if (!fullName) {
            showToast("Please enter your full name.", true);
            setLoading(false);
            return;
        }

        // ===== MODIFIED: Branched logic for student vs. tutor =====
        if (selectedAccountType === 'student') {
            if (!selectedAvatarUrl) {
                showToast("Please choose a character avatar.", true);
                setLoading(false);
                return;
            }
            // Sign up as a Student
            await handleNewUserSignUp(email, password, fullName, selectedAvatarUrl, 'student');
        
        } else if (selectedAccountType === 'tutor') {
            // Sign up as a Tutor (no avatar needed)
            await handleNewUserSignUp(email, password, fullName, null, 'tutor');
        }

    } else {
        // --- SIGN IN LOGIC (MODIFIED for REDIRECT) ---
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            if (!user.emailVerified) {
                showToast("Please verify your email before signing in. Another verification email has been sent.", true);
                await sendEmailVerification(user);
                setLoading(false);
                return;
            }

            console.log("User signed in:", user.uid);
            showToast("Signed in successfully! Checking account type...", false);
            
            // --- NEW: Check if user is a tutor ---
            // Tutors are stored by email
            const tutorDocRef = doc(db, "tutors", user.email);
            const tutorDocSnap = await getDoc(tutorDocRef);

            if (tutorDocSnap.exists()) {
                // User is a tutor
                console.log("User is a tutor. Redirecting to /tdashboard");
                showToast("Redirecting to tutor dashboard...", false);
                setTimeout(() => { window.location.href = 'https://thelo.space/tdashboard'; }, 1500);
            } else {
                // User is not a tutor, check student collection
                // Students are stored by UID
                const studentDocRef = doc(db, "thelo-students", user.uid);
                const studentDocSnap = await getDoc(studentDocRef);

                if (studentDocSnap.exists()) {
                     console.log("User is a student. Redirecting to /sdashboard");
                     showToast("Redirecting to student dashboard...", false);
                    setTimeout(() => { window.location.href = 'https://thelo.space/sdashboard'; }, 1500);
                } else {
                    // This case is unlikely if sign-up logic is correct, but good to handle.
                    console.error("User document not found in 'tutors' or 'thelo-students'.");
                    showToast("Error: Could not determine your account type. Please contact support.", true);
                    setLoading(false);
                }
            }

        } catch (error) {
            console.error("Sign in error:", error);
            let errorMessage = "Invalid email or password. Please try again.";
            if (error.code === 'auth/user-disabled') {
                errorMessage = "Your account has been disabled.";
            } else if (error.code === 'auth/invalid-credential') {
                errorMessage = "Invalid email or password. Please try again.";
            }
            showToast(errorMessage, true);
            setLoading(false);
        }
    }
});

// --- Initial Page Load ---
populateAvatars();
applyLang();
</script>
</body>
</html>
