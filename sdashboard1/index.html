<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dashboardTitle">thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
    :root {
        --thelo-blue: #2563EB;
        --thelo-blue-light: #EFF6FF;
        --thelo-green: #10B981;
        --thelo-amber: #F59E0B;
        --thelo-bg: #F8F9FA;
        --thelo-text: #111827;
        --thelo-text-light: #6B7280;
        --grid-color: #E5E7EB;
        --path-color: #D1D5DB;
    }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    body {
        font-family: 'Manrope', sans-serif;
        background-color: var(--thelo-bg);
        color: var(--thelo-text);
        background-image:
            linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 50px 50px;
        perspective: 1000px;
    }
    
    /* === HEADER STYLES (UPDATED: CLEAN & STATIC) === */
    .main-header {
        background: transparent; /* No background color */
        border: none;            /* No border */
        box-shadow: none;        /* No shadow */
        position: relative;      /* Static positioning (scrolls with page) */
        padding: 2.5rem 2.5rem 0 2.5rem; /* Padding to sit nicely at top */
        max-width: 1200px;       /* Align with main content */
        margin: 0 auto;
        z-index: 10;
    }

    /* Stats styling to pop against the grid background */
    .stat-pill {
        background-color: #fff;
        border: 1px solid var(--grid-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        border-radius: 9999px; /* Pill shape */
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* === LEARNING PATH (DESKTOP DEFAULT) === */
    main { padding: 1rem 2.5rem 4rem 2.5rem; max-width: 1200px; margin: auto; }
    
    .learning-path { position: relative; padding-bottom: 4rem; margin-top: 2rem; }
    
    /* The Center Line */
    .learning-path::before {
        content: ''; position: absolute; top: 0; left: 50%;
        width: 4px; height: 100%;
        background: linear-gradient(var(--path-color), var(--path-color)) no-repeat;
        background-size: 4px 20px; /* Dashed effect */
        background-position: center; 
        transform: translateX(-50%); z-index: 1;
        mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
    }

    .path-unit { position: relative; z-index: 2; margin-bottom: 3rem; }

    /* Unit Header positioning */
    .path-unit-header { position: relative; display: flex; align-items: center; width: 50%; padding: 1rem 3rem; box-sizing: border-box; }
    .path-unit:nth-child(odd) .path-unit-header { margin-left: 50%; justify-content: flex-start; text-align: left; }
    .path-unit:nth-child(even) .path-unit-header { margin-left: 0; flex-direction: row-reverse; text-align: right; justify-content: flex-end; }

    /* The Dots on the center line */
    .path-unit-header::before {
        content: ''; position: absolute; top: 50%; transform: translateY(-50%);
        width: 20px; height: 20px; border-radius: 50%;
        background-color: var(--thelo-bg); border: 4px solid var(--path-color); z-index: 3;
    }
    .path-unit:nth-child(odd) .path-unit-header::before { left: -10px; }
    .path-unit:nth-child(even) .path-unit-header::before { right: -10px; }

    .unit-icon {
        font-size: 1.5rem; color: var(--thelo-blue); background-color: var(--thelo-blue-light);
        padding: 0.75rem; border-radius: 50%; width: 3.5rem; height: 3.5rem; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 0 4px var(--thelo-bg); flex-shrink: 0;
    }
    .path-unit:nth-child(odd) .unit-icon { margin-right: 1rem; }
    .path-unit:nth-child(even) .unit-icon { margin-left: 1rem; }

    .unit-title { font-size: 1.5rem; font-weight: 800; line-height: 1.2; }
    .unit-meta { color: var(--thelo-text-light); font-size: 0.9rem; margin-top: 0.25rem; }

    /* === CARD STYLES === */
    .topic-card {
        background-color: #fff;
        border: 1px solid var(--grid-color);
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: calc(50% - 3rem); /* Breathing room from center line */
        position: relative;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        text-decoration: none;
        overflow: hidden;
    }

    /* Positioning Cards */
    .path-unit:nth-child(odd) .topic-card { margin-top: 1.5rem; margin-left: calc(50% + 3rem); }
    .path-unit:nth-child(even) .topic-card { margin-top: 1.5rem; margin-right: calc(50% + 3rem); margin-left: auto; }

    /* Connecting Lines to Center */
    .topic-card::before {
        content: ''; position: absolute; top: 50%; height: 2px;
        width: 3rem; background-color: var(--path-color); z-index: -1;
    }
    .path-unit:nth-child(odd) .topic-card::before { left: -3rem; }
    .path-unit:nth-child(even) .topic-card::before { right: -3rem; }

    /* Status Indicators (Left strip) */
    .topic-card::after {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0;
        width: 6px; background-color: transparent; transition: background-color 0.3s;
    }
    .topic-card.completed::after { background-color: var(--thelo-green); }
    .topic-card.in-progress::after { background-color: var(--thelo-amber); }

    /* Hover Effects (Desktop) */
    @media (hover: hover) {
        .topic-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--thelo-blue-light);
        }
        .topic-card.next-up:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 0 0 2px var(--thelo-blue), 0 20px 40px -5px rgba(37, 99, 235, 0.2);
        }
    }

    /* Next Up Styling */
    .topic-card.next-up {
        box-shadow: 0 0 0 2px var(--thelo-blue), 0 10px 15px -3px rgba(37, 99, 235, 0.15);
        background-color: #fff;
    }

    .topic-info { flex-grow: 1; padding-right: 1rem; }
    .topic-name { font-weight: 700; color: var(--thelo-text); font-size: 1.1rem; margin-bottom: 0.25rem; }
    .topic-status { font-size: 0.8rem; font-weight: 600; color: var(--thelo-text-light); display: flex; align-items: center; gap: 0.4rem; }
    .topic-status.completed { color: var(--thelo-green); }
    .topic-status.in-progress { color: var(--thelo-amber); }
    .topic-status.next-up { color: var(--thelo-blue); }

    .topic-action-btn {
        background-color: var(--thelo-blue-light);
        color: var(--thelo-blue);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }
    .topic-card:hover .topic-action-btn, .topic-card.next-up .topic-action-btn {
        background-color: var(--thelo-blue);
        color: white;
    }

    /* === MOBILE OPTIMIZATION === */
    @media (max-width: 768px) {
        .main-header { padding: 1.5rem 1rem 0 1rem; flex-direction: column; gap: 1rem; }
        
        main { padding: 2rem 1rem; }
        
        /* 1. Shift the main line to the left */
        .learning-path::before { 
            left: 2rem; 
            transform: none; 
            width: 3px;
        }

        /* 2. Reset Units to Full Width */
        .path-unit { margin-bottom: 2rem; }
        
        /* 3. Normalize Header Layout (Align Left) */
        .path-unit-header, 
        .path-unit:nth-child(odd) .path-unit-header, 
        .path-unit:nth-child(even) .path-unit-header {
            width: 100%;
            margin-left: 0;
            padding: 0 0 0 4.5rem; /* Space for icon */
            flex-direction: row;
            text-align: left;
            justify-content: flex-start;
            margin-bottom: 1rem;
        }

        /* 4. Fix Unit Dots placement */
        .path-unit-header::before,
        .path-unit:nth-child(odd) .path-unit-header::before,
        .path-unit:nth-child(even) .path-unit-header::before {
            left: 1.45rem; /* Center on the new line position */
            right: auto;
            width: 16px; height: 16px;
            border-width: 3px;
        }

        /* 5. Fix Unit Icons */
        .unit-icon {
            display: none; 
        }

        .unit-title { font-size: 1.25rem; }

        /* 6. Normalize Cards (Stack them) */
        .topic-card,
        .path-unit:nth-child(odd) .topic-card,
        .path-unit:nth-child(even) .topic-card {
            width: calc(100% - 1rem);
            margin: 0.75rem 0 0 3.5rem; /* Push right of the line */
            width: calc(100% - 3.5rem);
            padding: 1.25rem;
        }

        /* 7. Fix Card Connectors */
        .topic-card::before,
        .path-unit:nth-child(odd) .topic-card::before,
        .path-unit:nth-child(even) .topic-card::before {
            left: -1.5rem; /* Connect to the line at 2rem */
            width: 1.5rem;
            right: auto;
        }

        /* 8. Stats Scrolling */
        .header-stats {
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            width: 100%;
            justify-content: flex-start;
            gap: 1rem;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .header-stats::-webkit-scrollbar { display: none; }
        
        /* 9. Disable 3D tilt on mobile */
        .topic-card:hover { transform: none; }
    }
    </style>
</head>
<body class="antialiased">

    <header class="main-header flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center gap-3">
                <img src="https://thelo.space/img/bluethelo.svg" alt="Thelo logo" class="h-8 md:h-10 w-auto" />
            </div>
            <div class="flex items-center gap-4 md:hidden">
                <a href="https://thelo.space/settings" aria-label="Go to settings">
                    <img id="profile-photo-nav-mobile" src="https://via.placeholder.com/150/E5E7EB/FFFFFF?text=L" alt="Profile" class="h-10 w-10 rounded-full cursor-pointer border-2 border-white shadow-sm object-cover">
                </a>
            </div>
        </div>

        <div class="header-stats w-full md:w-auto flex items-center md:justify-center">
            <div class="stat-pill">
                <i class="fas fa-star text-yellow-500"></i>
                <div>
                    <div id="student-points" class="font-bold text-sm md:text-base">...</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide" data-i18n="pointsTitle">Points</div>
                </div>
            </div>
            <div class="stat-pill">
                <i class="fas fa-fire text-orange-500"></i>
                <div>
                    <div id="streak-count" class="font-bold text-sm md:text-base">...</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide" data-i18n="streakTitle">Streak</div>
                </div>
            </div>
            <div class="stat-pill">
                <i class="fas fa-check-circle text-green-500"></i>
                <div>
                    <div id="lessons-completed-count" class="font-bold text-sm md:text-base">...</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide" data-i18n="lessonsCompletedTitle">Lessons</div>
                </div>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-6">
            <button id="open-thelobook-btn" class="text-gray-500 hover:text-blue-600 transition-colors" title="TheloBook">
                <i class="fas fa-book-open text-xl"></i>
            </button>
            <a href="https://thelo.space/settings" aria-label="Go to settings">
                <img id="profile-photo-nav" src="https://via.placeholder.com/150/E5E7EB/FFFFFF?text=L" alt="Profile" class="h-11 w-11 rounded-full cursor-pointer border-2 border-white hover:border-blue-500 shadow-sm object-cover transition-all">
            </a>
        </div>
    </header>

    <main>
        <section id="welcome-section" class="text-center mb-12 opacity-0 -translate-y-3 transition-all duration-700 ease-out pt-4">
            <div class="relative inline-block">
                <img id="welcome-avatar" src="https://via.placeholder.com/150/E5E7EB/FFFFFF?text=L" alt="User Avatar" class="w-24 h-24 md:w-28 md:h-28 rounded-full mx-auto mb-4 border-4 border-white shadow-xl object-cover">
                <div class="absolute bottom-4 right-0 w-6 h-6 bg-green-400 border-4 border-white rounded-full"></div>
            </div>
            
            <h1 class="text-3xl md:text-5xl font-extrabold text-gray-800 tracking-tight">
                Good to see you, <br class="md:hidden" />
                <span id="welcome-name" class="text-[var(--thelo-blue)]">...</span>
            </h1>
            <p id="stats-summary" class="mt-3 text-base md:text-lg text-gray-500 max-w-xl mx-auto leading-relaxed px-4">
                Loading your progress...
            </p>
        </section>

        <div class="learning-path" id="learning-path-container"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, updateDoc, where, arrayUnion, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
            authDomain: "physmathacademy-722b3.firebaseapp.com",
            projectId: "physmathacademy-722b3",
            storageBucket: "physmathacademy-722b3.appspot.com",
            appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const profilePhotoNav = document.getElementById('profile-photo-nav');
        const profilePhotoNavMobile = document.getElementById('profile-photo-nav-mobile');
        const studentPointsSpan = document.getElementById('student-points');
        const lessonsCompletedCountSpan = document.getElementById('lessons-completed-count');
        const streakCountSpan = document.getElementById('streak-count');
        const learningPathContainer = document.getElementById('learning-path-container');
        const welcomeSection = document.getElementById('welcome-section');
        const welcomeAvatar = document.getElementById('welcome-avatar');
        const welcomeName = document.getElementById('welcome-name');
        const statsSummary = document.getElementById('stats-summary');


        async function renderFullCourse(courseId, userId) {
            if (!learningPathContainer) return;
            learningPathContainer.innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-3"></i>
                    <p class="text-gray-500">Loading your path...</p>
                </div>`;

            try {
                const progressQuery = query(collection(db, 'thelo-students', userId, 'progress'));
                const unitsQuery = query(collection(db, 'courses', courseId, 'units'), orderBy('order'));

                const [progressSnapshot, unitsSnapshot] = await Promise.all([
                    getDocs(progressQuery),
                    getDocs(unitsQuery)
                ]);

                const progressMap = new Map(progressSnapshot.docs.map(doc => [doc.id, doc.data()]));

                let allTopics = [];
                for (const unitDoc of unitsSnapshot.docs) {
                    const unitData = { id: unitDoc.id, ...unitDoc.data() };
                    const topicsQuery = query(collection(unitDoc.ref, 'topics'), orderBy('order'));
                    const topicsSnapshot = await getDocs(topicsQuery);
                    const topics = topicsSnapshot.docs.map(doc => ({ id: doc.id, unit: unitData, ...doc.data() }));
                    allTopics.push(...topics);
                }

                const nextUpTopic = allTopics.find(topic => !progressMap.has(topic.id));

                let fullCourseHTML = '';
                let currentUnitId = null;

                allTopics.forEach((topic) => {
                    if (topic.unit.id !== currentUnitId) {
                        if (currentUnitId !== null) { fullCourseHTML += `</div></div>`; }
                        currentUnitId = topic.unit.id;
                        fullCourseHTML += `
                            <div class="path-unit">
                                <div class="path-unit-header">
                                    <div class="hidden md:flex items-center justify-center unit-icon">
                                        <i class="fas ${topic.unit.icon || 'fa-book'}"></i>
                                    </div>
                                    <div>
                                        <h2 class="unit-title">${topic.unit.unitTitle}</h2>
                                        <p class="unit-meta">${topic.unit.unitMeta}</p>
                                    </div>
                                </div>
                                <div class="topics-container">
                        `;
                    }

                    const progress = progressMap.get(topic.id);
                    let status = "Not Started";
                    let statusClass = "not-started";
                    let statusIcon = "fa-play-circle";
                    let actionText = "Start";

                    if (progress && progress.status === 'completed') {
                        status = "Completed";
                        statusClass = "completed";
                        statusIcon = "fa-check-circle";
                        actionText = "Review";
                    } else if (progress && progress.status === 'in-progress') {
                        status = "In Progress";
                        statusClass = "in-progress";
                        statusIcon = "fa-spinner";
                        actionText = "Continue";
                    }

                    if (nextUpTopic && topic.id === nextUpTopic.id) {
                        statusClass += ' next-up';
                    }

                    fullCourseHTML += `
                        <a href="https://thelo.space/learn/?lessonFile=${topic.lessonFileUrl}" class="topic-card ${statusClass}">
                            <div class="topic-info">
                                <div class="topic-name">${topic.topicName}</div>
                                <div class="topic-status ${statusClass}"><i class="fas ${statusIcon}"></i> ${status}</div>
                            </div>
                            <span class="topic-action-btn">${actionText}</span>
                        </a>
                    `;
                });

                if (unitsSnapshot.docs.length > 0) {
                    fullCourseHTML += `</div></div>`;
                }

                learningPathContainer.innerHTML = fullCourseHTML;

            } catch (error) {
                console.error("Error rendering course:", error);
                learningPathContainer.innerHTML = '<p class="text-center text-red-500">Could not load the learning path. Please try again later.</p>';
            }
        }

        async function updateDashboardData(user) {
            const studentDocRef = doc(db, 'thelo-students', user.uid);
            try {
                const docSnap = await getDoc(studentDocRef);

                if (docSnap.exists()) {
                    const studentData = docSnap.data();
                    const name = studentData.name || 'Student';
                    const firstName = name.split(' ')[0];
                    const lessons = studentData.lessonsCompleted || 0;
                    const streak = studentData.streakData?.currentStreak || 0;
                    const avatarUrl = studentData.profilePicture;

                    if (avatarUrl) {
                        welcomeAvatar.src = avatarUrl;
                        if(profilePhotoNav) profilePhotoNav.src = avatarUrl;
                        if(profilePhotoNavMobile) profilePhotoNavMobile.src = avatarUrl;
                    }
                    welcomeName.textContent = firstName;

                    let summaryMessage = '';
                    if (lessons === 0) {
                        summaryMessage = "Welcome! Your learning journey starts now. Let's begin with your first lesson";
                    } else if (streak < 2 && lessons < 5) {
                        summaryMessage = `Great start with <strong>${lessons}</strong> lessons done! Keep going to build your first streak.`;
                    } else {
                        summaryMessage = `You're on a <strong>${streak} week</strong> streak with <strong>${lessons}</strong> lessons completed. Keep up the great work!`;
                    }
                    statsSummary.innerHTML = summaryMessage;

                    studentPointsSpan.textContent = studentData.points || 0;
                    streakCountSpan.textContent = streak;
                    lessonsCompletedCountSpan.textContent = lessons;

                } else {
                    console.warn("No student profile found for UID:", user.uid);
                    welcomeName.textContent = 'Student';
                    statsSummary.textContent = 'Your learning journey starts now. Pick a lesson below to begin!';
                }

                welcomeSection.classList.remove('opacity-0', '-translate-y-3');

            } catch (error) {
                console.error("Error fetching student profile:", error);
                welcomeName.textContent = 'Student';
                statsSummary.textContent = 'Could not load your progress, but you can still start a lesson below.';
                 welcomeSection.classList.remove('opacity-0', '-translate-y-3');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User authenticated:", user.uid);
                await Promise.all([
                    updateDashboardData(user),
                    renderFullCourse('sat-math-prep', user.uid)
                ]);
            } else {
                console.log("Redirecting: User not signed in.");
                window.location.href = 'https://thelo.space/auth';
            }
        });
    </script>
</body>
</html>
