<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>thelo – Auth</title>
<link rel="icon" href="https://thelo.space/img/newthelo.png" type="image/png"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
:root{--thelo-blue:#2563EB;--thelo-bg:#F8F9FA;--thelo-text:#111827;--grid-color:#E5E7EB}
body{
  font-family:'Manrope',system-ui,-apple-system,'Segoe UI','Helvetica Neue',Arial,sans-serif;
  background:var(--thelo-bg);
  color:var(--thelo-text);
  background-image:
    linear-gradient(to right,var(--grid-color) 1px,transparent 1px),
    linear-gradient(to bottom,var(--grid-color) 1px,transparent 1px);
  background-size:40px 40px;
  min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem}
html[lang="hy"] body{font-family:'Noto Serif Armenian',serif}

.window-container{
  background:#fff;border:1px solid var(--grid-color);border-radius:.75rem;
  padding:2.5rem;box-shadow:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
  position:relative;max-width:480px;width:100%}
@media(min-width:768px){.window-container{max-width:820px}}
.window-container::before{
  content:"";position:absolute;top:1rem;left:1rem;width:52px;height:12px;
  background-image:url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E")}
.form-input{width:100%;border-radius:.5rem;border:1px solid #D1D5DB;background:#fff;
  padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.05);
  transition:border-color .2s,box-shadow .2s}
.form-input:focus{border-color:var(--thelo-blue);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.2)}

/* make the submit button always span the full row even in 2-col mode  */
#submitBtn{grid-column:1/-1}

.profile-picture-upload-area{display:flex;flex-direction:column;align-items:center;margin-bottom:1rem}
.profile-picture-preview{width:96px;height:96px;border-radius:50%;border:2px solid var(--grid-color);
  background:#f0f0f0;margin-bottom:.5rem;display:flex;align-items:center;justify-content:center;
  color:#ccc;font-size:2.5rem;cursor:pointer;overflow:hidden}
.profile-picture-preview:hover{border-color:var(--thelo-blue);box-shadow:0 0 0 3px rgba(37,99,235,.2)}
.profile-picture-preview img{width:100%;height:100%;object-fit:cover}
.profile-picture-input{opacity:0;position:absolute;z-index:-1}

.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid var(--thelo-blue);
  border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;margin-left:.5rem}
@keyframes spin{to{transform:rotate(360deg)}}
.form-button:disabled{opacity:.7;cursor:not-allowed}
@media(max-width:640px){
  .fixed.top-4.left-4,.fixed.top-4.right-4{top:.5rem;font-size:.75rem;padding:.25rem .5rem}
  .fixed.top-4.left-4{left:.5rem}.fixed.top-4.right-4{right:.5rem}}
</style>
</head>

<body>
<a href="/" class="fixed top-4 left-4 text-sm font-semibold text-slate-500 hover:text-[var(--thelo-blue)]">
  <span id="homeArrow">←</span> <span id="homeLink">Home</span></a>
<button id="langToggle" class="fixed top-4 right-4 rounded-md border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-100">Հայ</button>

<div id="authWindowContainer" class="window-container">
  <h2 id="formTitle" class="text-2xl font-extrabold mb-6 text-center">Sign In</h2>
  <p class="text-center text-sm mb-4">
    <span id="togglePrompt">Don't have an account?</span>
    <button id="toggleLink" class="text-[var(--thelo-blue)] font-semibold hover:underline">Create one</button>
  </p>

  <form id="authForm" class="grid signin grid-cols-1 gap-y-4">
    <div id="pfpUploadWrap" class="hidden profile-picture-upload-area md:col-span-2">
      <div class="profile-picture-preview" id="pfpPreview"><i class="fas fa-user-circle"></i></div>
      <input type="file" id="pfpInput" accept="image/*" class="profile-picture-input">
      <span id="pfpStatusText" class="text-sm text-slate-500 mt-1">Upload Profile Picture</span>
    </div>

    <div id="nameWrap"       class="hidden"><label id="labelName"     class="block text-sm font-bold mb-1" for="nameInput">Name</label>    <input id="nameInput"     type="text" class="form-input"></div>
    <div id="surnameWrap"  class="hidden"><label id="labelSurname" class="block text-sm font-bold mb-1" for="surnameInput">Surname</label><input id="surnameInput" type="text" class="form-input"></div>

    <div id="emailDiv">
      <label id="labelEmail" class="block text-sm font-bold mb-1" for="email">Email</label>
      <input id="email" type="email" class="form-input" required>
    </div>
    <div id="roleWrap" class="hidden">
      <label id="labelRole" class="block text-sm font-bold mb-1" for="roleSelect">I am a:</label>
      <select id="roleSelect" class="form-input">
        <option value="student" id="optStudent">Student</option>
        <option value="teacher" id="optTeacher">Teacher</option>
      </select>
    </div>
    <div id="passwordDiv">
      <label id="labelPassword" class="block text-sm font-bold mb-1" for="password">Password</label>
      <input id="password" type="password" class="form-input" required>
    </div>
    <div id="confirmWrap" class="hidden">
      <label id="labelConfirm" class="block text-sm font-bold mb-1" for="confirm">Confirm Password</label>
      <input id="confirm" type="password" class="form-input">
    </div>

    <button id="submitBtn" type="submit"
            class="mt-2 rounded-lg bg-[var(--thelo-blue)] px-8 py-3 font-bold text-white shadow hover:scale-105 transition-transform">
      Sign In
    </button>
  </form>

  <p id="toast" class="mt-6 text-center text-sm text-red-600 hidden"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
    authDomain: "physmathacademy-722b3.firebaseapp.com",
    projectId: "physmathacademy-722b3",
    storageBucket: "physmathacademy-722b3.appspot.com",
    appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const TXT = {
    en: {
        home: "Home", signInTitle: "Sign In", signUpTitle: "Create Account", signInBtn: "Sign In", signUpBtn: "Create Account",
        toggleHave: "Don't have an account?", toggleHas: "Already have one?", toggleCreate: "Create one", toggleSignin: "Sign in",
        nameLabel: "Name", surnameLabel: "Surname", email: "Email", password: "Password", confirm: "Confirm Password",
        roleLabel: "I am a:", student: "Student", teacher: "Teacher", mismatch: "Passwords do not match",
        uploadPfpLabel: "Upload Profile Picture", pfpUploading: "Uploading...",
        // Error messages
        invalidEmail: "Invalid email address.",
        weakPassword: "Password should be at least 6 characters.",
        emailAlreadyInUse: "This email is already registered.",
        userNotFound: "No user found with this email.",
        wrongPassword: "Incorrect password.",
        genericError: "An unexpected error occurred. Please try again."
    },
    hy: {
        home: "Գլխավոր", signInTitle: "Մուտք", signUpTitle: "Ստեղծել հաշիվ", signInBtn: "Մուտք", signUpBtn: "Ստեղծել",
        toggleHave: "Չունե՞ք հաշիվ?", toggleHas: "Արդեն ունե՞ք հաշիվ?", toggleCreate: "Ստեղծել", toggleSignin: "Մուտք",
        nameLabel: "Անուն", surnameLabel: "Ազգանուն", email: "Էլ-փոստ", password: "Գաղտնաբառ", confirm: "Կրկնել գաղտնաբառը",
        roleLabel: "Ես՝", student: "Ուսանող եմ", teacher: "Ուսուցիչ եմ", mismatch: "Գաղտնաբառերը չեն համընկնում",
        uploadPfpLabel: "Ներբեռնել պրոֆիլի նկար", pfpUploading: "Ներբեռնում...",
        // Error messages
        invalidEmail: "Սխալ էլեկտրոնային հասցե։",
        weakPassword: "Գաղտնաբառը պետք է լինի առնվազն 6 նիշ։",
        emailAlreadyInUse: "Այս էլեկտրոնային հասցեն արդեն գրանցված է։",
        userNotFound: "Այս էլեկտրոնային հասցեով օգտատեր չի գտնվել։",
        wrongPassword: "Սխալ գաղտնաբառ։",
        genericError: "Տեղի է ունեցել անսպասելի սխալ։ Խնդրում ենք նորից փորձել։"
    }
};

let lang = 'en';
let mode = 'signin';
let selectedFile = null;

/* DOM Elements */
const langBtn = document.getElementById('langToggle');
const homeLink = document.getElementById('homeLink');
const form = document.getElementById('authForm');
const formTitle = document.getElementById('formTitle');
const togglePrompt = document.getElementById('togglePrompt');
const toggleLink = document.getElementById('toggleLink');
const nameWrap = document.getElementById('nameWrap');
const surnameWrap = document.getElementById('surnameWrap');
const labelName = document.getElementById('labelName');
const labelSurname = document.getElementById('labelSurname');
const labelEmail = document.getElementById('labelEmail');
const labelPassword = document.getElementById('labelPassword');
const labelConfirm = document.getElementById('labelConfirm');
const labelRole = document.getElementById('labelRole');
const optStudent = document.getElementById('optStudent');
const optTeacher = document.getElementById('optTeacher');
const confirmWrap = document.getElementById('confirmWrap');
const roleWrap = document.getElementById('roleWrap');
const submitBtn = document.getElementById('submitBtn');
const toast = document.getElementById('toast');
const pfpUploadWrap = document.getElementById('pfpUploadWrap');
const pfpPreview = document.getElementById('pfpPreview');
const pfpInput = document.getElementById('pfpInput');
const pfpStatusText = document.getElementById('pfpStatusText');
const nameInput = document.getElementById('nameInput');
const surnameInput = document.getElementById('surnameInput');
const emailInput = document.getElementById('email'); // Added for easier access
const passwordInput = document.getElementById('password'); // Added for easier access
const confirmInput = document.getElementById('confirm'); // Added for easier access
const roleSelect = document.getElementById('roleSelect'); // Added for easier access

/* --- Helper Functions --- */
function showToast(message, isError = true) {
    toast.textContent = message;
    toast.classList.remove('hidden');
    if (isError) {
        toast.classList.remove('text-green-600');
        toast.classList.add('text-red-600');
    } else {
        toast.classList.remove('text-red-600');
        toast.classList.add('text-green-600');
    }
}

function hideToast() {
    toast.classList.add('hidden');
    toast.textContent = '';
}

function setLoading(isLoading) {
    if (isLoading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="loading-spinner"></span> ${TXT[lang].pfpUploading}`; // Reusing pfpUploading for a generic loading state
    } else {
        submitBtn.disabled = false;
        applyLang(); // Reapply button text based on current mode/lang
    }
}

function applyLang() {
    const s = TXT[lang];
    document.documentElement.lang = lang;
    langBtn.textContent = lang === 'en' ? 'Հայ' : 'EN';
    homeLink.textContent = s.home;
    labelName.textContent = s.nameLabel;
    labelSurname.textContent = s.surnameLabel;
    labelEmail.textContent = s.email;
    labelPassword.textContent = s.password;
    labelConfirm.textContent = s.confirm;
    labelRole.textContent = s.roleLabel;
    optStudent.textContent = s.student;
    optTeacher.textContent = s.teacher;
    pfpStatusText.textContent = s.uploadPfpLabel;
    if (mode === 'signup') {
        formTitle.textContent = s.signUpTitle;
        togglePrompt.textContent = s.toggleHas;
        toggleLink.textContent = s.toggleSignin;
        submitBtn.textContent = s.signUpBtn;
    } else {
        formTitle.textContent = s.signInTitle;
        togglePrompt.textContent = s.toggleHave;
        toggleLink.textContent = s.toggleCreate;
        submitBtn.textContent = s.signInBtn;
    }
}

function setMode(m) {
    mode = m;
    pfpPreview.innerHTML = '<i class="fas fa-user-circle"></i>';
    selectedFile = null;
    pfpInput.value = '';
    nameInput.value = ''; // Clear inputs on mode switch
    surnameInput.value = '';
    emailInput.value = '';
    passwordInput.value = '';
    confirmInput.value = '';

    if (m === 'signup') {
        form.classList.remove('signin');
        form.classList.add('md:grid-cols-2', 'md:gap-x-4');
        pfpUploadWrap.classList.remove('hidden');
        nameWrap.classList.remove('hidden');
        surnameWrap.classList.remove('hidden');
        confirmWrap.classList.remove('hidden');
        roleWrap.classList.remove('hidden');
    } else {
        form.classList.add('signin');
        form.classList.remove('md:grid-cols-2', 'md:gap-x-4');
        pfpUploadWrap.classList.add('hidden');
        nameWrap.classList.add('hidden');
        surnameWrap.classList.add('hidden');
        confirmWrap.classList.add('hidden');
        roleWrap.classList.add('hidden');
    }
    applyLang();
    hideToast();
}

/* --- Profile Picture Logic --- */
pfpInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = e => { pfpPreview.innerHTML = `<img src="${e.target.result}" alt="Profile">` };
        reader.readAsDataURL(file);
    } else {
        selectedFile = null;
        pfpPreview.innerHTML = '<i class="fas fa-user-circle"></i>';
    }
    pfpStatusText.textContent = TXT[lang].uploadPfpLabel;
});
pfpPreview.addEventListener('click', () => pfpInput.click());

/* --- Language and Mode Toggles --- */
langBtn.addEventListener('click', () => { lang = lang === 'en' ? 'hy' : 'en'; applyLang() });
toggleLink.addEventListener('click', () => setMode(mode === 'signin' ? 'signup' : 'signin'));

/* --- Firebase Authentication Logic --- */

form.addEventListener('submit', async (e) => {
    e.preventDefault(); // Prevent default form submission
    hideToast(); // Clear previous toast messages

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (mode === 'signup') {
        const name = nameInput.value.trim();
        const surname = surnameInput.value.trim();
        const confirmPassword = confirmInput.value.trim();
        const role = roleSelect.value;

        // Client-side validation for signup
        if (!name || !surname || !email || !password || !confirmPassword) {
            showToast("Please fill in all required fields.");
            return;
        }
        if (password.length < 6) {
            showToast(TXT[lang].weakPassword);
            return;
        }
        if (password !== confirmPassword) {
            showToast(TXT[lang].mismatch);
            return;
        }

        // Proceed with Firebase signup
        setLoading(true);
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            console.log("User signed up:", user);

            let pfpUrl = '';
            if (selectedFile) {
                try {
                    const pfpRef = ref(storage, `profilePictures/${user.uid}/${selectedFile.name}`);
                    await uploadBytes(pfpRef, selectedFile);
                    pfpUrl = await getDownloadURL(pfpRef);
                    console.log("Profile picture uploaded:", pfpUrl);
                } catch (storageError) {
                    console.error("Error uploading profile picture:", storageError);
                    showToast("Failed to upload profile picture. Please try again.");
                    // Don't block signup if PFP upload fails, but inform user
                }
            }

            // Store additional user data in Firestore
            await setDoc(doc(db, "users", user.uid), {
                name: name,
                surname: surname,
                email: user.email,
                role: role,
                pfpUrl: pfpUrl || null, // Store the PFP URL, or null if not uploaded
                createdAt: new Date()
            });

            showToast("Account created successfully! Redirecting...", false);
            // Redirect to a dashboard or home page after a short delay
            setTimeout(() => {
                window.location.href = '/dashboard.html'; // Or your desired logged-in page
            }, 1500);

        } catch (error) {
            const errorCode = error.code;
            let errorMessage = TXT[lang].genericError; // Default generic error

            switch (errorCode) {
                case 'auth/email-already-in-use':
                    errorMessage = TXT[lang].emailAlreadyInUse;
                    break;
                case 'auth/invalid-email':
                    errorMessage = TXT[lang].invalidEmail;
                    break;
                case 'auth/weak-password':
                    errorMessage = TXT[lang].weakPassword;
                    break;
                default:
                    console.error("Signup error:", errorCode, error.message);
                    break;
            }
            showToast(errorMessage);
        } finally {
            setLoading(false);
        }
    } else { // Signin mode
        // Client-side validation for signin
        if (!email || !password) {
            showToast("Please enter your email and password.");
            return;
        }

        // Proceed with Firebase signin
        setLoading(true);
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            console.log("User signed in:", user);

            showToast("Signed in successfully! Redirecting...", false);
            // Redirect to a dashboard or home page after a short delay
            setTimeout(() => {
                window.location.href = '/dashboard.html'; // Or your desired logged-in page
            }, 1500);

        } catch (error) {
            const errorCode = error.code;
            let errorMessage = TXT[lang].genericError; // Default generic error

            switch (errorCode) {
                case 'auth/invalid-email':
                    errorMessage = TXT[lang].invalidEmail;
                    break;
                case 'auth/user-not-found':
                    errorMessage = TXT[lang].userNotFound;
                    break;
                case 'auth/wrong-password':
                    errorMessage = TXT[lang].wrongPassword;
                    break;
                case 'auth/user-disabled':
                    errorMessage = "Your account has been disabled.";
                    break;
                default:
                    console.error("Signin error:", errorCode, error.message);
                    break;
            }
            showToast(errorMessage);
        } finally {
            setLoading(false);
        }
    }
});

// Optional: Keep track of auth state changes (e.g., for redirecting if already logged in)
onAuthStateChanged(auth, (user) => {
    if (user) {
        // User is signed in, you might want to redirect them away from the auth page
        console.log("User already logged in:", user.uid);
        // window.location.href = '/dashboard.html'; // Uncomment if you want immediate redirect
    } else {
        // No user is signed in, display auth forms
        console.log("No user logged in.");
    }
});


applyLang(); // initial paint
</script>
</body>
</html>
