<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

   <style>
    /*
      ============================================
      Custom Font Definitions for Armenian
      ============================================
      - Only loads when Armenian characters are detected.
      - Uses Montserrat Arm for Armenian text.
    */
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype');
      font-weight: 400; /* Regular */
      font-style: normal;
      font-display: swap;
      /* Armenian Unicode character range */
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-SemiBold.otf') format('opentype');
      font-weight: 600; /* SemiBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-ExtraBold.otf') format('opentype');
      font-weight: 800; /* ExtraBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }

    /*
      ============================================
      Original and Updated Site Styles
      ============================================
    */
    :root {
        --thelo-blue: #2563EB;
        --thelo-bg: #F8F9FA;
        --thelo-text: #111827;
        --grid-color: #E5E7EB;
    }
    html { scroll-behavior: smooth; }
    body {
        /*
          UPDATED FONT STACK:
          - 'Montserrat Arm' is now the first choice.
          - Due to unicode-range, it will only apply to Armenian text.
          - 'Manrope' will be used for all English/Latin text as a fallback.
        */
        font-family: 'Montserrat Arm', 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--thelo-bg);
        color: var(--thelo-text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-image:
            linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 40px 40px;
    }
    h1, h2, h3, h4, h5, h6 { font-weight: 800; }
    .anim-target {
        opacity: 0;
        transition: opacity 0.7s cubic-bezier(0.215, 0.610, 0.355, 1), transform 0.7s cubic-bezier(0.215, 0.610, 0.355, 1);
        transform: translateY(20px);
    }
    .anim-target.is-visible { opacity: 1; transform: translateY(0); }
    .nav-link { color: var(--thelo-text); transition: color 0.2s; }
    .nav-link:hover { color: var(--thelo-blue); }
    .window-container {
        position: relative;
        background-color: white;
        border: 1px solid var(--grid-color);
        border-radius: 0.75rem;
        padding: 2.5rem;
    }
    .window-container::before {
        content: ' ';
        position: absolute;
        top: 1rem;
        left: 1rem;
        width: 52px;
        height: 12px;
        background-image: url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E%0A");
        background-repeat: no-repeat;
    }
    #replay-feedback { transform: translate(-50%, 49px); } /* center on x, 12px below */

</style>
</head>

<body class="antialiased">

<nav id="mainNav" class="w-full z-40">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-6 lg:px-8">
        <a href="/" class="flex items-center gap-2">
            <img src="https://thelo.space/img/bluethelo.svg" alt="thelo logo" class="h-12 w-auto" />
        </a>
        <div class="flex items-center gap-4">
            <ul class="hidden gap-6 md:flex">
                <li><a href="#why" class="nav-link font-semibold" data-i18n="navWhy"></a></li>
                <li><a href="#thelopad" class="nav-link font-semibold" data-i18n="navThelopad"></a></li>
                <li><a href="#contact" class="nav-link font-semibold" data-i18n="navContact"></a></li>
                <li><a href="https://thelo.space/auth" class="nav-link font-semibold" data-i18n="navAuth"></a></li>
            </ul>
             <div class="flex items-center gap-2 text-sm">
                 <span id="lang-en" class="lang-btn">EN</span>
                 <span class="text-slate-300">|</span>
                 <span id="lang-hy" class="lang-btn">HY</span>
             </div>
            <button id="mobileMenuButton" class="md:hidden rounded-md p-2 text-slate-600 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-[var(--thelo-blue)]/50">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>
    </div>
    <div id="mobileMenu" class="hidden md:hidden">
        <ul class="bg-white border-t border-slate-200 px-4 pt-2 pb-4">
            <li><a href="#why" class="block py-2 nav-link font-semibold" data-i18n="navWhy"></a></li>
            <li><a href="#thelopad" class="block py-2 nav-link font-semibold" data-i18n="navThelopad"></a></li>
            <li><a href="https://thelo.space/auth" class="block py-2 nav-link font-semibold" data-i18n="navAuth"></a></li>
            <li><a href="#contact" class="block py-2 nav-link font-semibold" data-i18n="navContact"></a></li>
            <li><a href="https://thelo.space/satmathteam/" class="nav-link font-semibold" data-i18n="navJoin"></a></li>
        </ul>
    </div>
</nav>

    <header class="relative overflow-hidden pt-16 pb-24 lg:pt-24 lg:pb-32">
        <div class="mx-auto max-w-7xl px-6 lg:px-8">
            <div class="grid max-w-2xl grid-cols-1 gap-x-12 gap-y-16 lg:max-w-none lg:grid-cols-2">
                <div class="anim-target">
                    <h1 class="text-5xl font-extrabold tracking-tighter text-[var(--thelo-text)] md:text-6xl lg:text-7xl" data-i18n="heroTitle"> </h1>
                </div>
                <div class="anim-target flex flex-col justify-center" style="transition-delay: 0.1s;">
                    <p class="text-lg font-semibold" data-i18n="heroP1"></p>
                    <p class="mt-4 text-lg text-slate-600" data-i18n="heroP2"></p>
                    <p class="mt-4 text-lg text-slate-600" data-i18n="heroP3"></p>
                </div>
            </div>
        </div>
    </header>

<section id="why" class="py-24 sm:py-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
        <div class="mx-auto max-w-3xl text-center anim-target">
            <h2 class="text-4xl font-extrabold text-[var(--thelo-text)] sm:text-5xl" data-i18n="whyTitle"></h2>
        </div>
        <div class="mt-16 window-container anim-target" style="transition-delay: 0.2s;">
            <div class="grid grid-cols-1 gap-12 text-center md:grid-cols-3 md:text-left pt-8">
                <div>
                    <h3 class="text-xl font-bold text-[var(--thelo-text)]" data-i18n="why1h"></h3>
                    <p class="mt-2 text-slate-600" data-i18n="why1p"></p>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-[var(--thelo-text)]" data-i18n="why2h"></h3>
                    <p class="mt-2 text-slate-600" data-i18n="why2p"></p>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-[var(--thelo-text)]" data-i18n="why3h"></h3>
                    <p class="mt-2 text-slate-600" data-i18n="why3p"></p>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="thelopad" class="py-24 sm:py-32">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
        <div class="grid grid-cols-1 gap-x-16 gap-y-10 lg:grid-cols-2">
            <div class="flex flex-col justify-center anim-target">
                <h2 class="text-4xl font-extrabold text-[var(--thelo-text)] sm:text-5xl" data-i18n="thelopadTitle"></h2>
                <div class="mt-4 inline-block rounded-full bg-[var(--thelo-blue)] px-4 py-1.5 text-lg font-bold text-white w-fit" data-i18n="thelopadTag"></div>
                <p class="mt-8 text-slate-600 text-lg" data-i18n="thelopadSub"></p>
            </div>
            <div class="anim-target" style="transition-delay: 0.2s;">
                <img id="laptopImage" src="https://thelo.space/img/theloLaptopEn.png" alt="A mockup of the thelopad tablet and a laptop showing thelo's interface" class="w-full h-auto object-contain">
            </div>
        </div>
    </div>
</section>
<section id="drawing-replay" class="hidden sm:block pt-24 pb-16 sm:pt-32 sm:pb-20">
    <div class="mx-auto max-w-7xl px-6 lg:px-8">
        <div class="relative w-full aspect-video">
            <canvas id="replayCanvas" class="absolute top-0 left-0 w-full h-full bg-transparent"></canvas>
            <div id="replay-feedback" class="absolute opacity-0 transition-opacity duration-700 ease-out pointer-events-none">
                <div class="max-w-md p-4 bg-white/70 backdrop-blur-sm border border-slate-200 rounded-2xl shadow-md pointer-events-auto">
                    <p class="font-semibold text-slate-800" data-i18n="replayFeedback"></p>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="contact" class="py-24 sm:py-32">
    <div class="mx-auto max-w-4xl px-6 text-center">
        <div class="anim-target">
            <h2 class="text-4xl font-extrabold text-[var(--thelo-text)] sm:text-5xl" data-i18n="contactTitle"></h2>
            <p class="mt-6 text-lg text-slate-600" data-i18n="contactSub"></p>
        </div>
        <div class="anim-target mt-8 text-slate-600" style="transition-delay: 0.1s;">
            <p class="mb-4" data-i18n="contactAlt"></p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 sm:gap-8">
                <a href="mailto:community.relations@thelo.space" class="font-semibold flex items-center gap-2 hover:text-[var(--thelo-blue)] transition-colors">
                    <i class="fas fa-envelope fa-fw"></i> <span>community.relations@thelo.space</span>
                </a>
            </div>
        </div>
        <div class="calendly-inline-widget anim-target mt-12" data-url="https://calendly.com/aramasatryan290/30min" style="min-width:320px; height:700px; transition-delay: 0.2s;"> </div>
        <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
    </div>
</section>

<footer class="py-10 text-center text-sm text-slate-500">
    <p data-i18n="footer"></p>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {

        let currentUser = null;
        let targetDashboard = null;

        const strings = {
            en: {
                title: 'thelo | AI Tutoring for Schools',
                navWhy: 'For Schools',
                navThelopad: 'How It Works',
                navAuth: 'Log in',
                navDash: 'Dashboard',
                navContact: 'Partner With Us',
                navJoin: 'Join',
                heroTitle: 'Empower Your School with <br><span class="text-[var(--thelo-blue)]">AI Tutoring.</span>',
                heroP1: 'thelo transforms your existing computer labs into interactive, AI-powered learning ecosystems.',
                heroP2: 'Using our unique tablet pair that connects to any computer, student handwriting is instantly digitized and analyzed, providing every student with a personal AI tutor for real-time, step-by-step guidance.',
                heroP3: 'Bridge the feedback gap, boost student outcomes, and bring world-class educational tools to your classrooms at an accessible cost.',
                whyTitle: 'A Seamless Upgrade For Your School',
                why1h: 'Builds Mastery and Confidence',
                why1p: 'Our AI provides private, real-time feedback, allowing students to correct mistakes instantly and build the confidence to tackle complex problems.',
                why2h: 'Empowers True Differentiation',
                why2p: 'By automating step-by-step corrections, our AI co-pilot frees teachers from repetitive grading to focus on targeted, one-on-one student support.',
                why3h: 'Makes Learning Gaps Visible',
                why3p: 'We digitize the entire problem-solving process, not just the final answer, giving teachers the visibility to spot learning gaps early and intervene effectively.',
                thelopadTitle: 'Simple to Deploy, Powerful to Use.',
                thelopadTag: 'Built for the Classroom',
                thelopadSub: 'Setting up a thelo lab is straightforward. Our system integrates with your school\'s existing computers. We provide our unique tablet pairs that connect in minutes, turning any desk into an advanced learning station. No complex installations or special hardware required.',
                replayFeedback: 'That is the correct formula. Great work! 🎉',
                contactTitle: 'Partner With Us',
                contactSub: 'We are seeking forward-thinking schools, NGOs, and partners to bring the future of education to students across Armenia and beyond. Let\'s discuss how we can build a learning ecosystem together.',
                contactAlt: 'The best way to start is to schedule an introductory call or email us directly:',
                footer: '© 2025 thelo',
                laptopImageSrc: 'https://thelo.space/img/theloLaptopEn.png'
            },
            hy: {
                title: 'Թելո | ԱԲ ուսուցում դպրոցների համար',
                navWhy: 'Դպրոցների համար',
                navThelopad: 'Ինչպե՞ս է աշխատում',
                navAuth: 'Մուտք',
                navDash: 'Վահանակ',
                navContact: 'Դարձե՛ք գործընկեր',
                navJoin: 'Միանալ',
                heroTitle: 'Ձեր դպրոցը՝<br><span class="text-[var(--thelo-blue)]">Թելոյի ուսուցմամբ</span>',
                heroP1: 'Թելոն դպրոցների համակարգչային լսարաններին հնարավորություն է տալիս դառնալ ինտերակտիվ, մաթեմատիկական ուսուցման էկոհամակարգերի։',
                heroP2: 'Մեր յուրահատուկ թաբլեթների զույգը, միանալով ցանկացած համակարգչի, աշակերտի ձեռագիրն ակնթարթորեն թվայնացվում է և վերլուծում՝ ստուգելով նրա աշխատանքը։',
                heroP3: 'Հնարավորություն ընձեռնեք՛ ձեր դպրոցի աշակերտներին սովորել մաթեմատիկա՝ ասես դա երբեք ավելի արդյունավետ չի եղել։',
                whyTitle: 'Նորարական ձեռքբերում ձեր դպրոցի համար',
                why1h: 'Օգնում է վարժվել',
                why1p: 'Մեր ԱԲ֊ն տրամադրում է անհատական ուղղորդում՝ թույլ տալով աշակերտներին ակնթարթորեն ուղղել սխալները և ձեռք բերել բարդ խնդիրներ լուծելու վստահություն։',
                why2h: 'Ստեղծում է իրական տարբերություն',
                why2p: 'Ավտոմատացնելով քայլ առ քայլ ստուգումները՝ մեր ԱԲ օգնականը ուսուցիչներին ազատում է կարմիր գրչի անվերջ ժամերից՝ կենտրոնանալու աշակերտների անհատական աջակցության վրա։',
                why3h: 'Տեսանելի է դարձնում ուսումնական բացերը',
                why3p: 'Մենք թվայնացնում ենք խնդրի լուծման ողջ գործընթացը, ոչ միայն պատասխանը, ինչը ուսուցիչներին տալիս է տեսանելիություն՝ ուսումնական բացերը վաղ նկատելու և արդյունավետ միջամտելու համար։',
                thelopadTitle: 'Հեշտ տեղակայվող, արդյունավետ կիրառմամբ',
                thelopadTag: 'Դասարանի համար',
                thelopadSub: 'Թելոլաբ ստեղծելը պարզ է։ Մեր համակարգը ինտեգրվում է ձեր դպրոցի առկա համակարգիչներին։ Մենք տրամադրում ենք մեր թաբլեթեները, որոնք րոպեների ընթացքում ցանկացած գրասեղան վերածում են առաջադեմ ուսումնական կայանի։',
                replayFeedback: 'Դու ճիշտ ես օգտագործել բանաձևը։ Ապրե՜ս',
                contactTitle: 'Դարձե՛ք մեր գործընկերը',
                contactSub: 'Մենք փնտրում ենք առաջադեմ դպրոցներ և հասարակական կազմակերպություններ՝ կրթության ապագան Հայաստանի և նրա սահմաններից դուրս գտնվող աշակերտներին հասցնելու համար։ Եկե՛ք քննարկենք, թե ինչպես կարող ենք միասին կառուցել ուսումնական էկոհամակարգեր։',
                contactAlt: 'Լավագույն միջոցը՝ նախապես զանգահարելը՝ կամ մեզ ուղղակիորեն նամակ գրելն է։',
                footer: '© 2025 thelo',
                laptopImageSrc: 'https://thelo.space/img/theloLaptopHy.png'
            }
        };

        let currentLang = localStorage.getItem('thelo-lang') || 'en';

        const laptopImage = document.getElementById('laptopImage');
        const langEnBtn = document.getElementById('lang-en');
        const langHyBtn = document.getElementById('lang-hy');

        // --- MODIFY THIS FUNCTION DEFINITION ---
function updateAuthUI(lang, targetDashboard) { // <-- Add targetDashboard argument
    const T = strings[lang];
    const loginAnchors = document.querySelectorAll('[data-i18n="navAuth"]');

    loginAnchors.forEach(anchor => {
        if (currentUser && targetDashboard) { // <-- Check for targetDashboard
            // --- USE targetDashboard HERE ---
            anchor.href = targetDashboard;
            // --- END CHANGE ---
            anchor.textContent = T.navDash;
        } else {
            anchor.href = "/auth";
            anchor.textContent = T.navAuth;
        }
    });
}

      function applyContent(lang) {
    const T = strings[lang];
    if (!T) return;

    // Updates all text content based on the selected language
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (key !== 'navAuth' && T[key]) {
            el.innerHTML = T[key];
        }
    });
    
    // Updates the laptop image source for the correct language
    laptopImage.src = T.laptopImageSrc;
    
    // Sets the 'lang' attribute on the HTML tag for accessibility
    document.documentElement.lang = lang;
    
    // Toggles the active state on the language switcher buttons
    langEnBtn.classList.toggle('active', lang === 'en');
    langHyBtn.classList.toggle('active', lang === 'hy');

    // Logic for Navbar Font Weight
    const navLinks = document.querySelectorAll('a.nav-link.font-semibold');
    navLinks.forEach(link => {
        if (lang === 'hy') {
            link.style.fontWeight = '400'; // Apply REGULAR weight for Armenian
        } else {
            link.style.fontWeight = '600'; // Revert to SEMIBOLD for English
        }
    });
    const heroTitleEl = document.querySelector('[data-i18n="heroTitle"]');
    if (heroTitleEl) {
        if (lang === 'en') {
            // Use ExtraBold (800) for Manrope in English
            heroTitleEl.style.fontWeight = '800'; 
        } else {
            // You can set a different weight for Armenian here if needed
            // For now, we'll keep it at ExtraBold as well
            heroTitleEl.style.fontWeight = '800';
        }
    }

    // --- Logic for Feedback Message Width ---
    const replayFeedbackEl = document.getElementById('replay-feedback');
    if (replayFeedbackEl) {
        const innerFeedbackDiv = replayFeedbackEl.querySelector('div');

        if (lang === 'hy') {
            // Set specific width for Armenian
            if (innerFeedbackDiv) {
                innerFeedbackDiv.style.maxWidth = 'none';
                innerFeedbackDiv.style.width = '420px'; // Set to 500px
            }
        } else {
            // Revert to default for English
            if (innerFeedbackDiv) {
                innerFeedbackDiv.style.maxWidth = '';
                innerFeedbackDiv.style.width = '';
            }
        }
    }
    // --- END Logic ---
}
        
        langEnBtn.addEventListener('click', () => {
            currentLang = 'en';
            localStorage.setItem('thelo-lang', currentLang);
            applyContent(currentLang);
            updateAuthUI(currentLang, targetDashboard); // <-- ADD THIS LINE
        });

        langHyBtn.addEventListener('click', () => {
            currentLang = 'hy';
            localStorage.setItem('thelo-lang', currentLang);
            applyContent(currentLang);
            updateAuthUI(currentLang, targetDashboard); // <-- ADD THIS LINE
        });

        const firebaseConfig = {
            apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
            authDomain: "physmathacademy-722b3.firebaseapp.com",
            projectId: "physmathacademy-722b3",
            storageBucket: "physmathacademy-722b3.appspot.com",
            appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => { // <-- Make the function async
    currentUser = user;

    if (currentUser) {
        // --- START MODIFICATION ---
        // User is logged in, check if they are a tutor or student
        console.log("User logged in:", currentUser.email); // Debugging line
        let isTutor = false;
        let isStudent = false;
        

        try {
            // Check tutors collection (using email as ID)
            const tutorDocRef = doc(db, "tutors", currentUser.email);
            const tutorDocSnap = await getDoc(tutorDocRef);
            if (tutorDocSnap.exists()) {
                console.log("User is a tutor."); // Debugging line
                isTutor = true;
                targetDashboard = "/tdashboard"; // Set target to tutor dashboard
            } else {
                // Optional: Check students collection if not a tutor (using UID as ID)
                const studentDocRef = doc(db, "thelo-students", currentUser.uid);
                const studentDocSnap = await getDoc(studentDocRef);
                if (studentDocSnap.exists()) {
                    console.log("User is a student."); // Debugging line
                    isStudent = true;
                    targetDashboard = "/sdashboard"; // Explicitly set target
                } else {
                     console.warn("User document not found in tutors or thelo-students."); // Debugging line
                     // Keep default /sdashboard or redirect elsewhere?
                }
            }

            // Update the UI after checking Firestore
            updateAuthUI(currentLang, targetDashboard);

        } catch (error) {
            console.error("Error checking user role:", error);
            // Fallback: update UI with default dashboard link in case of error
            updateAuthUI(currentLang, targetDashboard);
        }
        // --- END MODIFICATION ---

    } else {
        // User is logged out, update UI normally
        targetDashboard = null; // <-- ADD THIS LINE
        updateAuthUI(currentLang, null); // Pass null when logged out
    }
});

        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        document.querySelectorAll('#mobileMenu a').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.add('hidden');
            });
        });

        const animationObserver = new IntersectionObserver((entries) => entries.forEach(entry => {
            if(entry.isIntersecting){ entry.target.classList.add('is-visible'); animationObserver.unobserve(entry.target); }
        }), { threshold: 0.1 });
        document.querySelectorAll('.anim-target').forEach(el => animationObserver.observe(el));

        // Drawing Replay Logic (no changes needed here)
        const setupDrawingReplay = () => {
            const canvas = document.getElementById('replayCanvas');
            const feedbackEl = document.getElementById('replay-feedback');
            if (!canvas || !feedbackEl) return;
            const ctx = canvas.getContext('2d');
            let drawingData = null;
            let animationFrameId = null;
            const devicePixelRatio = window.devicePixelRatio || 1;
            const resizeCanvas = () => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * devicePixelRatio;
                canvas.height = rect.height * devicePixelRatio;
                ctx.scale(devicePixelRatio, devicePixelRatio);
                if (drawingData) {
                    renderDrawingAtTime(Infinity, drawingData, ctx);
                }
            };
            const renderDrawingAtTime = (targetTime, data, context) => {
                const canvasWidth = context.canvas.width / devicePixelRatio;
                const canvasHeight = context.canvas.height / devicePixelRatio;
                context.clearRect(0, 0, canvasWidth, canvasHeight);
                context.lineCap = 'round';
                context.lineJoin = 'round';
                data.strokes.forEach(stroke => {
                    const strokeStartTime = stroke.startTime || 0;
                    if (targetTime < strokeStartTime) return;
                    context.strokeStyle = stroke.color || '#2563EB';
                    context.lineWidth = stroke.lineWidth || 4;
                    context.beginPath();
                    let movedToFirstPoint = false;
                    for (let i = 0; i < stroke.points.length; i++) {
                        const point = stroke.points[i];
                        const pointTimeAbsolute = strokeStartTime + (point.timeOffset || 0);
                        if (pointTimeAbsolute > targetTime) break;
                        if (!movedToFirstPoint) {
                            context.moveTo(point.normX * canvasWidth, point.normY * canvasHeight);
                            movedToFirstPoint = true;
                        } else {
                            context.lineTo(point.normX * canvasWidth, point.normY * canvasHeight);
                        }
                    }
                    if (movedToFirstPoint) context.stroke();
                });
            };
            const startReplayAnimation = (data) => {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                let startTime = 0;
                const totalDuration = data.strokes.reduce((max, s) => Math.max(max, s.endTime), 0);
                const animate = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const elapsedTime = timestamp - startTime;
                    renderDrawingAtTime(elapsedTime, data, ctx);
                    if (elapsedTime < totalDuration) {
                        animationFrameId = requestAnimationFrame(animate);
                    } else {
                        renderDrawingAtTime(Infinity, data, ctx);
                        animationFrameId = null;
                        setTimeout(() => {
                            try {
                                const container = canvas.parentElement;
                                const rect = container.getBoundingClientRect();
                                const lastStroke = data.strokes.reduce((a, b) => (a.endTime > b.endTime ? a : b));
                                const lastPt = lastStroke.points[lastStroke.points.length - 1];
                                const xPx = lastPt.normX * rect.width;
                                const yPx = lastPt.normY * rect.height;
                                feedbackEl.style.right = 'auto';
                                feedbackEl.style.bottom = 'auto';
                                feedbackEl.style.left = `${xPx}px`;
                                feedbackEl.style.top  = `${yPx}px`;
                                feedbackEl.classList.remove('opacity-0');
                                feedbackEl.classList.add('opacity-100');
                            } catch (e) { console.error('Could not place feedback:', e); feedbackEl.classList.remove('opacity-0'); feedbackEl.classList.add('opacity-100'); }
                        }, 500);
                    }
                };
                animationFrameId = requestAnimationFrame(animate);
            };
            const replayObserver = new IntersectionObserver(async (entries, observer) => {
                if (entries[0].isIntersecting) {
                    try {
                        const response = await fetch('https://thelo.space/lessons/drawings/main.json');
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        drawingData = await response.json();
                        resizeCanvas();
                        startReplayAnimation(drawingData);
                        observer.unobserve(canvas);
                    } catch (error) { console.error('Failed to load drawing data:', error); }
                }
            }, { threshold: 0.4 }); 
            replayObserver.observe(canvas);
            window.addEventListener('resize', resizeCanvas);
        };

        // Initial Load
        applyContent(currentLang);
        setupDrawingReplay();
    });
</script>

</body>
</html>
