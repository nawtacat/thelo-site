<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dashboardTitle">Thelo Student Dashboard</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />

    <!-- Google Fonts: Manrope (for English) & Noto Serif Armenian -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --thelo-blue: #2563EB;
            --thelo-bg: #F8F9FA;
            --thelo-text: #111827;
            --grid-color: #E5E7EB;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--thelo-bg);
            color: var(--thelo-text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* The signature grid background */
            background-image:
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Language-specific font rules */
        html[lang="en"] body {
            font-family: 'Manrope', sans-serif;
        }
        html[lang="hy"] body {
            font-family: "Noto Serif Armenian", serif;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 800; /* Bolder Manrope */
        }
        html[lang="hy"] h1, 
        html[lang="hy"] h2, 
        html[lang="hy"] h3, 
        html[lang="hy"] h4, 
        html[lang="hy"] h5, 
        html[lang="hy"] h6 {
            font-weight: 700; /* Bolder Noto Serif Armenian */
        }

        /* Reusable Card Style */
        .card {
            background-color: white;
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem; /* Consistent rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        /* Primary Button Style */
        .thelo-btn {
            background-color: var(--thelo-blue);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .thelo-btn:hover {
            background-color: #1a56d2; /* Darker blue */
            transform: translateY(-2px);
        }

        /* Secondary Button Style */
        .thelo-btn-secondary {
            background-color: transparent;
            color: var(--thelo-blue);
            border: 1px solid var(--thelo-blue);
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .thelo-btn-secondary:hover {
            background-color: var(--thelo-blue);
            color: white;
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: var(--grid-color);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 10px;
            background-color: var(--thelo-blue);
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
        }

        /* Lesson Card specific styles (for both continue and explore sections) */
        .lesson-card-item {
            background-color: white;
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem;
            overflow: hidden; /* For image/thumbnail */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .lesson-card-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .lesson-card-thumbnail {
            width: 100%;
            height: 120px; /* Fixed height for thumbnails */
            object-fit: cover;
            background-color: #f0f0f0; /* Placeholder color */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--grid-color);
        }
        .lesson-card-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .lesson-card-content {
            padding: 1rem;
            flex-grow: 1; /* Allows content to push footer down */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .lesson-card-progress {
            margin-top: 0.75rem;
        }

        /* Horizontal scroll for Continue Learning */
        .horizontal-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scrollbar-width: none; /* Firefox */
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .horizontal-scroll-content {
            display: flex;
            gap: 1.5rem; /* Space between cards */
            padding-bottom: 1rem; /* Space for scrollbar if it appears */
        }
        .horizontal-scroll-item {
            flex: 0 0 280px; /* Fixed width for horizontal items */
            max-width: 80%; /* Ensure it doesn't get too wide on small screens */
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            .dashboard-grid {
                grid-template-columns: 1fr; /* Single column on mobile */
                gap: 1.5rem;
            }
            .card {
                padding: 1.25rem;
            }
            .horizontal-scroll-content {
                padding-left: 1.5rem; /* Padding for first item on mobile */
                padding-right: 1.5rem; /* Padding for last item on mobile */
            }
            .horizontal-scroll-item {
                flex: 0 0 calc(100% - 3rem); /* Adjust width to fit screen with padding */
            }
            main {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            header {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            h2 {
                font-size: 2.25rem; /* Adjust heading size */
            }
            h3 {
                font-size: 1.125rem;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header Navigation -->
    <header class="w-full bg-white/70 backdrop-blur-sm border-b border-slate-200 py-4 px-6 lg:px-8 flex flex-col md:flex-row items-center justify-between z-10">
        <div class="flex items-center gap-4 mb-3 md:mb-0">
            <img src="https://thelo.space/img/thelo-Photoroom.png" alt="Thelo logo" class="h-8 w-auto" />
            <h1 class="text-2xl font-bold text-[var(--thelo-text)]" data-i18n="dashboardTitleShort">Dashboard</h1>
        </div>
        <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
            <div class="text-lg font-semibold text-right flex flex-col md:flex-row gap-2 md:gap-4 items-center">
                <span data-i18n="pointsDisplay">üéØ Points: <span id="student-points" class="text-[var(--thelo-blue)]">0</span></span>
                <span data-i18n="lessonsCompletedDisplay">üîí Lessons: <span id="lessons-completed-count" class="text-[var(--thelo-blue)]">0</span></span>
            </div>
            <div class="flex gap-2 mt-3 md:mt-0">
                <button id="langToggle" class="rounded-md border border-slate-300 px-3 py-1.5 text-sm font-semibold text-slate-600 hover:bg-slate-100 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-[var(--thelo-blue)]/50">’Ä’°’µ</button>
                <button id="settings-button" class="thelo-btn-secondary text-sm px-3 py-1.5 rounded-full w-9 h-9 flex items-center justify-center">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto px-6 lg:px-8 py-8 md:py-12">
        <!-- Welcome & Quick Overview -->
        <section id="welcome-overview" class="mb-12">
            <h2 class="text-3xl lg:text-4xl font-extrabold text-[var(--thelo-text)] mb-8" data-i18n="welcomeGreeting">Good afternoon, <span id="student-name">Student</span>!</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 dashboard-grid">
                <!-- Progress Snapshot Card -->
                <div class="card flex flex-col items-start">
                    <h3 class="text-xl font-semibold mb-3" data-i18n="progressSnapshotTitle">Your Overall Progress</h3>
                    <div class="w-full mb-4">
                        <p class="text-sm text-slate-600 mb-2" data-i18n="overallCompletion">Overall Completion: <span id="overall-completion">0%</span></p>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="w-full text-sm text-slate-600">
                        <p data-i18n="hoursStudied"><span id="hours-studied">0</span> hours studied this week</p>
                        <p class="mt-1" data-i18n="accuracyRate">Average Accuracy: <span id="average-accuracy">0%</span></p>
                    </div>
                </div>

                <!-- Notebook Card -->
                <div class="card flex flex-col justify-between items-start">
                    <div>
                        <h3 class="text-xl font-semibold mb-3" data-i18n="notebookTitle">Your Thelobook</h3>
                        <p class="text-sm text-slate-600 mb-4" data-i18n="notebookDesc">Access and create your personalized handwritten notes and drafts.</p>
                    </div>
                    <button id="open-thelobook-btn" class="thelo-btn-secondary w-full mt-4" data-i18n="openNotebookBtn">
                        <i class="fas fa-book-open mr-2"></i> Open Thelobook
                    </button>
                </div>

                <!-- Quick Practice Card -->
                <div class="card flex flex-col justify-between items-start">
                    <div>
                        <h3 class="text-xl font-semibold mb-3" data-i18n="quickPracticeTitle">Quick Practice</h3>
                        <p class="text-sm text-slate-600 mb-4" data-i18n="quickPracticeDesc">Sharpen your skills with a quick set of problems!</p>
                    </div>
                    <button id="quick-practice-btn" class="thelo-btn w-full mt-4" data-i18n="startPracticeBtn">
                        <i class="fas fa-pencil-alt mr-2"></i> Start Practice
                    </button>
                </div>
            </div>
        </section>

        <!-- Continue Learning Section (Horizontal Scroll) -->
        <section id="continue-learning" class="mb-12">
            <h2 class="text-2xl lg:text-3xl font-extrabold text-[var(--thelo-text)] mb-6" data-i18n="continueLearningSectionTitle">Continue Learning</h2>
            <div class="horizontal-scroll-container">
                <div class="horizontal-scroll-content">
                    <!-- Dynamic Continue Lesson Card 1 -->
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-square-root-alt"></i> <!-- Math icon -->
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle1">Algebra I: Basic Equations</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">70%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 70%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                    <!-- Dynamic Continue Lesson Card 2 -->
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-calculator"></i> <!-- Calculator icon -->
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle2">Geometry: Area Formulas</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">45%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 45%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                    <!-- Dynamic Continue Lesson Card 3 -->
                    <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-chart-line"></i> <!-- Chart icon -->
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle3">Data Analysis: Statistics Basics</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">90%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 90%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                     <!-- Add more dynamic continue lessons here -->
                     <div class="lesson-card-item horizontal-scroll-item">
                        <div class="lesson-card-thumbnail">
                            <i class="fas fa-atom"></i> <!-- Science icon -->
                        </div>
                        <div class="lesson-card-content">
                            <div>
                                <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="lessonTitle4">Physics: Kinematics</h3>
                                <p class="text-sm text-slate-600" data-i18n="lessonProgress">Progress: <span class="font-bold">20%</span></p>
                                <div class="progress-bar-container lesson-card-progress">
                                    <div class="progress-bar" style="width: 20%;"></div>
                                </div>
                            </div>
                            <button class="thelo-btn mt-3 text-sm" data-i18n="resumeLessonBtn">Resume Lesson</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Explore All Lessons Section -->
        <section id="explore-lessons" class="mb-12">
            <h2 class="text-2xl lg:text-3xl font-extrabold text-[var(--thelo-text)] mb-6" data-i18n="exploreLessonsSectionTitle">Explore All Lessons</h2>
            
            <!-- Search & Categories -->
            <div class="flex flex-col md:flex-row items-center gap-4 mb-8">
                <input type="text" placeholder="Search lessons..." class="flex-grow w-full md:w-auto p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--thelo-blue)]/50" data-i18n="searchPlaceholder">
                <div class="flex flex-wrap justify-center gap-3">
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryAll">All</button>
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryMath">Math</button>
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryLogic">Logic</button>
                    <button class="thelo-btn-secondary px-4 py-2 text-sm" data-i18n="categoryLanguage">Language</button>
                </div>
            </div>

            <!-- Lessons Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Example Lesson Card 1 -->
                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-infinity"></i> <!-- Infinity icon -->
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson1Title">Calculus: Limits Introduction</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson1Desc">Understand the fundamental concept of limits in calculus.</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="watchBtn">Watch</button>
                            <button class="thelo-btn-secondary flex-1 text-sm" data-i18n="tryBtn">Try</button>
                        </div>
                    </div>
                </div>

                <!-- Example Lesson Card 2 -->
                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-brain"></i> <!-- Brain icon -->
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson2Title">Logic Puzzles: Deductive Reasoning</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson2Desc">Solve challenging puzzles using logical deduction.</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="watchBtn">Watch</button>
                            <button class="thelo-btn-secondary flex-1 text-sm" data-i18n="tryBtn">Try</button>
                        </div>
                    </div>
                </div>

                <!-- Example Lesson Card 3 -->
                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-language"></i> <!-- Language icon -->
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson3Title">Armenian I: Basic Phrases</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson3Desc">Learn essential Armenian phrases for daily conversation.</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="watchBtn">Watch</button>
                            <button class="thelo-btn-secondary flex-1 text-sm" data-i18n="tryBtn">Try</button>
                        </div>
                    </div>
                </div>
                
                <!-- Example Lesson Card 4 -->
                <div class="lesson-card-item">
                    <div class="lesson-card-thumbnail">
                        <i class="fas fa-square-root-alt"></i> <!-- Math icon -->
                    </div>
                    <div class="lesson-card-content">
                        <div>
                            <h3 class="text-md font-semibold text-[var(--thelo-blue)] mb-1" data-i18n="exploreLesson4Title">Algebra II: Quadratic Equations</h3>
                            <p class="text-sm text-slate-600" data-i18n="exploreLesson4Desc">Dive deeper into solving quadratic equations with various methods.</p>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button class="thelo-btn flex-1 text-sm" data-i18n="watchBtn">Watch</button>
                            <button class="thelo-btn-secondary flex-1 text-sm" data-i18n="tryBtn">Try</button>
                        </div>
                    </div>
                </div>
                <!-- More lesson cards can be dynamically loaded here -->
            </div>
        </section>
        
        <!-- User ID Display (for debugging/identification) -->
        <div class="text-center text-sm text-slate-500 mt-12 mb-4">
            <p>Your User ID: <span id="user-id-display" class="font-mono text-slate-700">Loading...</span></p>
        </div>
    </main>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from environment variables
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const studentNameSpan = document.getElementById('student-name');
        const studentPointsSpan = document.getElementById('student-points');
        const lessonsCompletedCountSpan = document.getElementById('lessons-completed-count');
        const overallCompletionSpan = document.getElementById('overall-completion');
        const overallProgressBar = document.querySelector('#overall-completion + .progress-bar-container .progress-bar');
        const hoursStudiedSpan = document.getElementById('hours-studied');
        const averageAccuracySpan = document.getElementById('average-accuracy');
        const openThelobookBtn = document.getElementById('open-thelobook-btn');
        // const manageAccountBtn = document.getElementById('manage-account-btn'); // Removed
        // const reportProblemBtn = document.getElementById('report-problem-btn'); // Removed
        // const logoutButton = document.getElementById('logout-button'); // Removed
        const settingsButton = document.getElementById('settings-button'); // New
        const langToggle = document.getElementById('langToggle');
        const userIdDisplay = document.getElementById('user-id-display');

        let isAuthReady = false; // Flag to ensure Firebase auth state is checked

        // --- Internationalization Strings ---
        const strings = {
            en: {
                dashboardTitle: 'Thelo Student Dashboard',
                dashboardTitleShort: 'Dashboard',
                welcomeGreeting: 'Good afternoon, <span id="student-name">Student</span>!',
                pointsDisplay: 'üéØ Points: <span id="student-points" class="text-[var(--thelo-blue)]">0</span>',
                lessonsCompletedDisplay: 'üîí Lessons: <span id="lessons-completed-count" class="text-[var(--thelo-blue)]">0</span>',
                progressSnapshotTitle: 'Your Overall Progress',
                overallCompletion: 'Overall Completion: <span id="overall-completion">0%</span>',
                hoursStudied: '<span id="hours-studied">0</span> hours studied this week',
                accuracyRate: 'Average Accuracy: <span id="average-accuracy">0%</span>',
                notebookTitle: 'Your Thelobook',
                notebookDesc: 'Access and create your personalized handwritten notes and drafts.',
                openNotebookBtn: 'Open Thelobook',
                // settingsFeedbackTitle: 'Settings & Support', // Removed
                // settingsFeedbackDesc: 'Manage your account or get help.', // Removed
                // manageAccountBtn: 'Manage Account', // Removed
                // reportProblemBtn: 'Report a Problem', // Removed
                continueLearningSectionTitle: 'Continue Learning',
                lessonTitle1: 'Algebra I: Basic Equations',
                lessonTitle2: 'Geometry: Area Formulas',
                lessonTitle3: 'Data Analysis: Statistics Basics',
                lessonTitle4: 'Physics: Kinematics',
                lessonProgress: 'Progress: <span class="font-bold">0%</span>',
                resumeLessonBtn: 'Resume Lesson',
                exploreLessonsSectionTitle: 'Explore All Lessons',
                searchPlaceholder: 'Search lessons...',
                categoryAll: 'All',
                categoryMath: 'Math',
                categoryLogic: 'Logic',
                categoryLanguage: 'Language',
                exploreLesson1Title: 'Calculus: Limits Introduction',
                exploreLesson1Desc: 'Understand the fundamental concept of limits in calculus.',
                exploreLesson2Title: 'Logic Puzzles: Deductive Reasoning',
                exploreLesson2Desc: 'Solve challenging puzzles using logical deduction.',
                exploreLesson3Title: 'Armenian I: Basic Phrases',
                exploreLesson3Desc: 'Learn essential Armenian phrases for daily conversation.',
                exploreLesson4Title: 'Algebra II: Quadratic Equations',
                exploreLesson4Desc: 'Dive deeper into solving quadratic equations with various methods.',
                watchBtn: 'Watch',
                tryBtn: 'Try',
                // logoutBtn: 'Logout' // Removed
                settingsBtn: 'Settings' // New string for settings icon alt text/title
            },
            hy: {
                dashboardTitle: '‘π’•’¨’∏ ’à÷Ç’Ω’°’∂’∏’≤’´ ’é’°’∞’°’∂’°’Ø',
                dashboardTitleShort: '’é’°’∞’°’∂’°’Ø',
                welcomeGreeting: '‘≤’°÷Ä’´ ’Ø’•’Ω÷Ö÷Ä, <span id="student-name">’à÷Ç’Ω’°’∂’∏’≤</span>!',
                pointsDisplay: 'üéØ ’Ñ’´’°’æ’∏÷Ä’∂’•÷Ä: <span id="student-points" class="text-[var(--thelo-blue)]">0</span>',
                lessonsCompletedDisplay: 'üîí ‘¥’°’Ω’•÷Ä: <span id="lessons-completed-count" class="text-[var(--thelo-blue)]">0</span>',
                progressSnapshotTitle: '’Å’•÷Ä ‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ‘±’º’°’ª’®’∂’©’°÷Å’®',
                overallCompletion: '‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ‘±’æ’°÷Ä’ø’æ’°’Æ’∏÷Ç’©’µ’∏÷Ç’∂: <span id="overall-completion">0%</span>',
                hoursStudied: '<span id="hours-studied">0</span> ’™’°’¥ ’∏÷Ç’Ω’∏÷Ç’¥’∂’°’Ω’´÷Ä’æ’°’Æ ’°’µ’Ω ’∑’°’¢’°’©',
                accuracyRate: '’Ñ’´’ª’´’∂ ’É’∑’£÷Ä’ø’∏÷Ç’©’µ’∏÷Ç’∂: <span id="average-accuracy">0%</span>',
                notebookTitle: '’Å’•÷Ä ‘π’•’¨’∏’£’´÷Ä÷Ñ’®',
                notebookDesc: '’Ñ’∏÷Ç’ø÷Ñ ’£’∏÷Ä’Æ’•÷Ñ ÷á ’Ω’ø’•’≤’Æ’•÷Ñ ’±’•÷Ä ’°’∂’±’∂’°’Ø’°’∂ ’±’•’º’°’£’´÷Ä ’∂’∑’∏÷Ç’¥’∂’•÷Ä’∂ ’∏÷Ç ’Ω÷á’°’£÷Ä’•÷Ä’®÷â',
                openNotebookBtn: '‘≤’°÷Å’•’¨ ‘π’•’¨’∏’£’´÷Ä÷Ñ’®',
                // settingsFeedbackTitle: '‘ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä ÷á ‘±’ª’°’Ø÷Å’∏÷Ç’©’µ’∏÷Ç’∂', // Removed
                // settingsFeedbackDesc: '‘ø’°’º’°’æ’°÷Ä’•÷Ñ ’±’•÷Ä ’∞’°’∑’´’æ’® ’Ø’°’¥ ’Ω’ø’°÷Å’•÷Ñ ÷Ö’£’∂’∏÷Ç’©’µ’∏÷Ç’∂÷â', // Removed
                // manageAccountBtn: '‘ø’°’º’°’æ’°÷Ä’•’¨ ’∞’°’∑’´’æ’®', // Removed
                // reportProblemBtn: '’Ä’°’≤’∏÷Ä’§’•’¨ ’≠’∂’§÷Ä’´ ’¥’°’Ω’´’∂', // Removed
                continueLearningSectionTitle: '’á’°÷Ä’∏÷Ç’∂’°’Ø’•’¨ ’à÷Ç’Ω’∏÷Ç’¥’®',
                lessonTitle1: '’Ä’°’∂÷Ä’°’∞’°’∑’´’æ I: ’Ä’´’¥’∂’°’Ø’°’∂ ’Ä’°’æ’°’Ω’°÷Ä’∏÷Ç’¥’∂’•÷Ä',
                lessonTitle2: '‘µ÷Ä’Ø÷Ä’°’π’°÷É’∏÷Ç’©’µ’∏÷Ç’∂: ’Ñ’°’Ø’•÷Ä’•’Ω’´ ‘≤’°’∂’°’±÷á’•÷Ä',
                lessonTitle3: '’è’æ’µ’°’¨’∂’•÷Ä’´ ’é’•÷Ä’¨’∏÷Ç’Æ’∏÷Ç’©’µ’∏÷Ç’∂: ’é’´’≥’°’Ø’°’£÷Ä’∏÷Ç’©’µ’°’∂ ’Ä’´’¥’∏÷Ç’∂÷Ñ’∂’•÷Ä',
                lessonTitle4: '’ñ’´’¶’´’Ø’°: ‘ø’´’∂’•’¥’°’ø’´’Ø’°',
                lessonProgress: '‘±’º’°’ª’®’∂’©’°÷Å: <span class="font-bold">0%</span>',
                resumeLessonBtn: '’á’°÷Ä’∏÷Ç’∂’°’Ø’•’¨ ’§’°’Ω’®',
                exploreLessonsSectionTitle: '‘≤’∏’¨’∏÷Ä ‘¥’°’Ω’•÷Ä’®',
                searchPlaceholder: '’à÷Ä’∏’∂’•’¨ ’§’°’Ω’•÷Ä...',
                categoryAll: '‘≤’∏’¨’∏÷Ä’®',
                categoryMath: '’Ñ’°’©’•’¥’°’ø’´’Ø’°',
                categoryLogic: '’è÷Ä’°’¥’°’¢’°’∂’∏÷Ç’©’µ’∏÷Ç’∂',
                categoryLanguage: '‘º’•’¶’∏÷Ç',
                exploreLesson1Title: '’Ñ’°’©’•’¥’°’ø’´’Ø’°’Ø’°’∂ ‘±’∂’°’¨’´’¶: ’ç’°’∞’¥’°’∂’∂’•÷Ä’´ ’Ü’•÷Ä’°’Æ’∏÷Ç’©’µ’∏÷Ç’∂',
                exploreLesson1Desc: '’Ä’°’Ω’Ø’°’∂’°’¨ ’Ω’°’∞’¥’°’∂’∂’•÷Ä’´ ’∞’´’¥’∂’°÷Ä’°÷Ä ’∞’°’Ω’Ø’°÷Å’∏÷Ç’©’µ’∏÷Ç’∂’® ’¥’°’©’•’¥’°’ø’´’Ø’°’Ø’°’∂ ’°’∂’°’¨’´’¶’∏÷Ç’¥÷â',
                exploreLesson2Title: '’è÷Ä’°’¥’°’¢’°’∂’°’Ø’°’∂ ‘Ω’∂’§’´÷Ä’∂’•÷Ä: ‘¥’•’§’∏÷Ç’Ø’ø’´’æ ’Ñ’ø’°’Æ’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂',
                exploreLesson2Desc: '‘º’∏÷Ç’Æ’•’¨ ’§’™’æ’°÷Ä’´’∂ ’≠’∂’§’´÷Ä’∂’•÷Ä’ù ÷Ö’£’ø’°’£’∏÷Ä’Æ’•’¨’∏’æ ’ø÷Ä’°’¥’°’¢’°’∂’°’Ø’°’∂ ’§’•’§’∏÷Ç’Ø÷Å’´’°÷â',
                exploreLesson3Title: '’Ä’°’µ’•÷Ä’•’∂ I: ’Ä’´’¥’∂’°’Ø’°’∂ ‘±÷Ä’ø’°’∞’°’µ’ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä',
                exploreLesson3Desc: '’ç’∏’æ’∏÷Ä’•’¨ ’∞’°’µ’•÷Ä’•’∂’´ ’∞’´’¥’∂’°’Ø’°’∂ ’°÷Ä’ø’°’∞’°’µ’ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’® ’°’¥’•’∂÷Ö÷Ä’µ’° ’≠’∏’Ω’°’Ø÷Å’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä÷â',
                exploreLesson4Title: '’Ä’°’∂÷Ä’°’∞’°’∑’´’æ II: ’î’°’º’°’Ø’∏÷Ç’Ω’´ ’Ä’°’æ’°’Ω’°÷Ä’∏÷Ç’¥’∂’•÷Ä',
                exploreLesson4Desc: '‘Ω’∏÷Ä’°’∂’°’¨ ÷Ñ’°’º’°’Ø’∏÷Ç’Ω’´ ’∞’°’æ’°’Ω’°÷Ä’∏÷Ç’¥’∂’•÷Ä’´ ’¨’∏÷Ç’Æ’¥’°’∂ ’ø’°÷Ä’¢’•÷Ä ’¥’•’©’∏’§’∂’•÷Ä’´ ’¥’•’ª÷â',
                watchBtn: '‘¥’´’ø’•’¨',
                tryBtn: '’ì’∏÷Ä’±’•’¨',
                // logoutBtn: '‘µ’¨÷Ñ' // Removed
                settingsBtn: '‘ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä'
            }
        };

        let currentLang = 'en'; // Default language

        function applyLang(lang) {
            document.documentElement.lang = lang;
            const t = strings[lang] || strings.en;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.dataset.i18n;
                if (t[k]) {
                    el.innerHTML = t[k]; // Use innerHTML to allow for embedded spans
                }
            });
            // Specific updates for dynamically inserted span values
            studentPointsSpan.textContent = studentPointsSpan.textContent;
            lessonsCompletedCountSpan.textContent = lessonsCompletedCountSpan.textContent;
            overallCompletionSpan.textContent = overallCompletionSpan.textContent;
            hoursStudiedSpan.textContent = hoursStudiedSpan.textContent;
            averageAccuracySpan.textContent = averageAccuracySpan.textContent;

            // Update placeholder text for search input
            const searchInput = document.querySelector('input[placeholder="Search lessons..."]');
            if (searchInput) {
                searchInput.placeholder = t.searchPlaceholder || searchInput.placeholder;
            }

            langToggle.textContent = (lang === 'hy') ? 'EN' : '’Ä’°’µ';
            settingsButton.title = t.settingsBtn; // Set title attribute for tooltip
        }

        // Fetch user data and update dashboard
        async function updateDashboard(user) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }

            userIdDisplay.textContent = user.uid; // Display user ID

            const userProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'user_profile', 'profile');
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    studentNameSpan.textContent = userData.name || 'Student'; // Set student name

                    // Simulate progress data (replace with actual data from Firestore/backend)
                    const simulatedPoints = Math.floor(Math.random() * 1000) + 100;
                    const simulatedLessons = Math.floor(Math.random() * 30) + 5;
                    const simulatedOverallProgress = Math.floor(Math.random() * 100); 
                    const simulatedHours = (Math.random() * 20 + 5).toFixed(1);
                    const simulatedAccuracy = Math.floor(Math.random() * 20) + 70; // 70-90%

                    studentPointsSpan.textContent = simulatedPoints;
                    lessonsCompletedCountSpan.textContent = simulatedLessons;
                    overallCompletionSpan.textContent = `${simulatedOverallProgress}%`;
                    overallProgressBar.style.width = `${simulatedOverallProgress}%`;
                    hoursStudiedSpan.textContent = simulatedHours;
                    averageAccuracySpan.textContent = `${simulatedAccuracy}%`;

                } else {
                    console.warn("No user profile found for UID:", user.uid);
                    studentNameSpan.textContent = 'New Student'; // Fallback for new user
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                studentNameSpan.textContent = 'Student'; // Fallback on error
            }
        }

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is authenticated:", user.uid);
                // If it's a Canvas custom token, try to sign in with it if not already signed in.
                // Otherwise, if already authenticated (e.g., via email/password), proceed.
                if (typeof __initial_auth_token !== 'undefined' && !isAuthReady) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with initial custom token.");
                        await updateDashboard(user); // Call updateDashboard after potential sign-in
                    } catch (error) {
                        console.error("Error signing in with initial custom token:", error);
                        await signInAnonymously(auth); // Fallback to anonymous if custom token fails
                        console.log("Signed in anonymously after custom token failure.");
                        await updateDashboard(auth.currentUser); // Update dashboard for anonymous user
                    }
                } else if (!isAuthReady) {
                    // For users authenticated via email/password (not Canvas token initially)
                    await updateDashboard(user);
                } else if (user.isAnonymous && !isAuthReady) {
                    // If already anonymous and not ready, proceed to update (this state might happen
                    // if anonymous sign-in happened on a previous page load or in a race condition)
                    console.log("User already anonymous. Proceeding to update dashboard.");
                    await updateDashboard(user);
                }

            } else {
                console.log("No user authenticated. Redirecting to login.");
                // Redirect only if Firebase auth state has been fully checked and no user found
                if (isAuthReady) { // Only redirect if initial auth check is complete
                     window.location.href = 'index.html'; // Redirect to your main login page
                }
            }
            isAuthReady = true; // Mark auth state as ready after initial check
        });

        // Settings button functionality
        settingsButton.addEventListener('click', () => {
            window.location.href = 'student-settings.html'; // Redirect to the new settings page
        });

        // Initial language application
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            currentLang = params.get('lang') || 'en';
            applyLang(currentLang);

            langToggle.addEventListener('click', () => {
                currentLang = (currentLang === 'en') ? 'hy' : 'en';
                const url = new URL(window.location);
                url.searchParams.set('lang', currentLang);
                window.history.replaceState({}, '', url); // Update URL without reloading
                applyLang(currentLang);
            });
        });

        // Placeholder button actions
        openThelobookBtn.addEventListener('click', () => {
            alert('Opening Thelobook!'); // Replace with actual Thelobook app integration
        });

        // manageAccountBtn.addEventListener('click', () => { // Removed
        //     alert('Managing account settings!'); 
        // });

        // reportProblemBtn.addEventListener('click', () => { // Removed
        //     alert('Reporting a problem!'); 
        // });
    </script>
</body>
</html>
