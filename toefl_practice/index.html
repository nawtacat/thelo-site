<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TOEFL Speaking Practice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    
    <style>
        :root {
            --thelo-blue: #2563eb;
            --thelo-blue-dark: #1d4ed8;
            --thelo-bg: #f9fafb;
            --thelo-text: #111827;
            --thelo-text-light: #6b7280;
            --thelo-border: #e5e7eb;
            --success-green: #22c55e;
            --error-red: #ef4444;
            --accent-yellow: #f59e0b;
            --bg-white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        body {
            font-family: 'Manrope', system-ui, -apple-system, sans-serif;
            background-color: var(--thelo-bg);
            color: var(--thelo-text);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        #app-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--bg-white);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h1 { text-align: center; margin: 0 0 0.5rem 0; color: var(--thelo-blue); }
        .control-btn {
            font-family: inherit; padding: 0.75rem 1.5rem; font-size: 1rem;
            font-weight: 500; border: none; border-radius: 0.5rem; color: var(--bg-white);
            cursor: pointer; transition: background-color 0.2s, transform 0.15s, box-shadow 0.2s;
            box-shadow: var(--shadow-md); background-color: var(--thelo-blue);
        }
        .control-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-lg); background-color: var(--thelo-blue-dark); }
        .control-btn:disabled { background-color: #9ca3af !important; cursor: not-allowed; opacity: 0.7; }
        #question-btn { background-color: var(--accent-yellow); }
        #question-display {
            background-color: var(--thelo-bg); border: 1px dashed var(--thelo-border);
            border-radius: 0.75rem; padding: 1.5rem; min-height: 80px; display: flex;
            justify-content: center; align-items: center; text-align: center;
            font-size: 1.1rem; line-height: 1.6; color: var(--thelo-text);
        }
        #timer-display { text-align: center; font-size: 2.5rem; font-weight: 700; color: var(--thelo-blue); height: 50px; }
        #status-display { text-align: center; color: var(--thelo-text-light); font-style: italic; min-height: 24px; }
        #feedback-container { margin-top: 1rem; border-top: 1px solid var(--thelo-border); padding-top: 1.5rem; }
        #feedback-container h2 { margin: 0 0 1rem 0; }
        .feedback-section { margin-bottom: 1.25rem; }
        .feedback-section h3 { margin: 0 0 0.5rem 0; color: var(--thelo-blue); border-bottom: 2px solid var(--thelo-border); padding-bottom: 0.25rem; }
        .feedback-section p { margin: 0; line-height: 1.7; }
        .loader {
            border: 4px solid var(--thelo-bg); border-top: 4px solid var(--thelo-blue);
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>TOEFL Speaking Practice</h1>

        <button id="question-btn" class="control-btn">Get New Question</button>

        <div id="question-display">Your question will appear here...</div>
        
        <div id="timer-display"></div>

        <div id="status-display">Please sign in to start.</div>

        <div id="feedback-container"></div>
    </div>

    <script>
        // Firebase Configuration (Should be the same as your thelo app)
        const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", databaseURL: "https://physmathacademy-722b3-default-rtdb.firebaseio.com", projectId: "physmathacademy-722b3", storageBucket: "physmathacademy-722b3.appspot.com", messagingSenderId: "1093640992262", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const functions = firebase.functions();

        // DOM Elements
        const getQuestionBtn = document.getElementById('question-btn');
        const questionDisplay = document.getElementById('question-display');
        const timerDisplay = document.getElementById('timer-display');
        const statusDisplay = document.getElementById('status-display');
        const feedbackContainer = document.getElementById('feedback-container');

        // App State
        let mediaRecorder;
        let audioChunks = [];
        let currentQuestion = '';

        // Event Listeners
        getQuestionBtn.addEventListener('click', generateQuestion);

        // Firebase Auth Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                statusDisplay.textContent = 'Ready to start.';
                getQuestionBtn.disabled = false;
            } else {
                statusDisplay.innerHTML = 'Please sign in to use the app. If you are signed in on another tab, please refresh.';
                getQuestionBtn.disabled = true;
            }
        });

        // Helper to convert Blob to Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        async function generateQuestion() {
            getQuestionBtn.disabled = true;
            statusDisplay.textContent = 'Generating a new question...';
            feedbackContainer.innerHTML = '';
            questionDisplay.innerHTML = '<div class="loader"></div>';

            try {
                const getTOEFLQuestion = functions.httpsCallable('getTOEFLQuestion');
                const result = await getTOEFLQuestion();
                
                currentQuestion = result.data.question;
                questionDisplay.textContent = currentQuestion;
                statusDisplay.textContent = 'Get ready to prepare your answer.';
                startPreparationTimer();
            } catch (error) {
                console.error("Firebase function error:", error);
                statusDisplay.textContent = 'Failed to generate a question. Please try again.';
                questionDisplay.textContent = 'Could not load question.';
                getQuestionBtn.disabled = false;
            }
        }
        
        function startPreparationTimer() {
            let timeLeft = 15;
            timerDisplay.textContent = `Prepare: ${timeLeft}s`;
            const prepTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Prepare: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(prepTimer);
                    startSpeakingTimerAndRecord();
                }
            }, 1000);
        }

        async function startSpeakingTimerAndRecord() {
            statusDisplay.textContent = 'Recording... Speak now!';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // FIX #1: REMOVED the specific mimeType to let the browser choose the most stable format.
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = getFeedback;

            } catch (error) {
                statusDisplay.textContent = 'Could not access microphone. Please grant permission.';
                console.error("Microphone access error:", error);
                getQuestionBtn.disabled = false;
                return;
            }
            
            let timeLeft = 45;
            timerDisplay.textContent = `Speak: ${timeLeft}s`;
            const speakTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Speak: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(speakTimer);
                    timerDisplay.textContent = '';
                    statusDisplay.textContent = 'Time\'s up! Processing your response...';
                    if (mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                }
            }, 1000);
        }
        
        async function getFeedback() {
            feedbackContainer.innerHTML = '<div class="loader"></div>';
            statusDisplay.textContent = 'Sending audio for analysis...';
            
            const audioBlob = new Blob(audioChunks, { type: audioChunks[0]?.type || 'audio/webm' });
            audioChunks = [];
            
            // FIX #2: ADDED a check to prevent sending an empty audio file.
            if (audioBlob.size === 0) {
                statusDisplay.textContent = 'Recording was empty. Please try speaking again.';
                feedbackContainer.innerHTML = '<p>Could not get feedback because no audio was recorded.</p>';
                getQuestionBtn.disabled = false;
                return; // Stop the function here
            }
            
            const audioBase64 = await blobToBase64(audioBlob);

            try {
                const getTOEFLFeedback = functions.httpsCallable('getTOEFLFeedback');
                const result = await getTOEFLFeedback({ 
                    audioBase64: audioBase64,
                    currentQuestion: currentQuestion 
                });
                
                displayFeedback(result.data);
                statusDisplay.textContent = 'Feedback complete. Ready for the next question.';

            } catch (error) {
                console.error("Firebase feedback function error:", error);
                statusDisplay.textContent = `Error: ${error.message}`;
                feedbackContainer.innerHTML = `<p>There was an issue getting feedback.</p>`;
            }
            
            getQuestionBtn.disabled = false;
        }

        function displayFeedback(feedback) {
            feedbackContainer.innerHTML = `
                <h2>Feedback (Score: ${feedback.overall_score || 'N/A'} / 4.0)</h2>
                <div class="feedback-section">
                    <h3>Transcript</h3>
                    <p><em>"${feedback.transcript || 'No transcript available.'}"</em></p>
                </div>
                <div class="feedback-section">
                    <h3>Delivery</h3>
                    <p>${feedback.delivery || 'No feedback available.'}</p>
                </div>
                <div class="feedback-section">
                    <h3>Language Use</h3>
                    <p>${feedback.language_use || 'No feedback available.'}</p>
                </div>
                <div class="feedback-section">
                    <h3>Topic Development</h3>
                    <p>${feedback.topic_development || 'No feedback available.'}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
