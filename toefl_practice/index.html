<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TOEFL Speaking Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
    .row { margin: 12px 0; }
    .timer { font-size: 18px; font-weight: 600; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    code, pre { background: #f7f7f7; padding: 8px; border-radius: 6px; display: block; overflow-x: auto; }
    .muted { color: #666; }
    .ok { background: #111; color: #fff; }
    .warn { background: #f59e0b; color: #111; }
    .primary { background: #2563eb; color: #fff; }
    .ghost { background: #f3f4f6; }
    .pill { padding: 4px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 12px; }
  </style>
</head>
<body>
  <h1>TOEFL Speaking Practice</h1>

  <div class="card">
    <div class="row">
      <button id="signin" class="ok">Sign in (Anonymous)</button>
      <span id="authStatus" class="muted"></span>
    </div>
    <div class="row">
      <button id="getQ" class="primary" disabled>Get Question</button>
      <span id="qStatus" class="muted"></span>
    </div>
    <div class="row">
      <div class="pill">Prep: 15s</div>
      <div class="pill" style="margin-left:8px;">Speak: 45s</div>
    </div>
    <div id="question" class="row" style="font-size:18px;"></div>

    <div class="row">
      <div class="timer">Prep Time: <span id="prepTimer">--</span></div>
      <div class="timer">Speak Time: <span id="speakTimer">--</span></div>
    </div>

    <div class="row">
      <button id="startPrep" class="ghost" disabled>Start Prep → Speak</button>
      <button id="cancel" class="warn" disabled>Cancel</button>
    </div>

    <div class="row">
      <audio id="playback" controls style="width:100%; display:none;"></audio>
    </div>
  </div>

  <div class="card">
    <h3>Feedback</h3>
    <div id="feedbackText" class="row"></div>
    <pre id="feedbackJson" style="display:none;"></pre>
  </div>

  <div class="card">
    <h3>Transcript</h3>
    <pre id="transcriptBox"></pre>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFunctions, httpsCallable, connectFunctionsEmulator
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

    // TODO: replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
      // storageBucket, messagingSenderId optional for this demo
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);
    // If using emulator locally:
    // connectFunctionsEmulator(functions, "localhost", 5001);

    const $ = (id) => document.getElementById(id);
    const btnSignIn = $("signin");
    const authStatus = $("authStatus");
    const btnGetQ = $("getQ");
    const qStatus = $("qStatus");
    const questionBox = $("question");
    const btnStartPrep = $("startPrep");
    const prepTimerEl = $("prepTimer");
    const speakTimerEl = $("speakTimer");
    const btnCancel = $("cancel");
    const playback = $("playback");
    const feedbackText = $("feedbackText");
    const feedbackJson = $("feedbackJson");
    const transcriptBox = $("transcriptBox");

    let mediaRecorder;
    let chunks = [];
    let currentQuestion = "";
    let cancelled = false;

    // Auth
    btnSignIn.onclick = async () => {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        authStatus.textContent = "Sign-in failed.";
        console.error(e);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authStatus.textContent = `Signed in (uid: ${user.uid})`;
        btnGetQ.disabled = false;
      } else {
        authStatus.textContent = "Not signed in.";
        btnGetQ.disabled = true;
      }
    });

    // Callable functions
    const getTOEFLQuestion = httpsCallable(functions, "getTOEFLQuestion");
    const getTOEFLFeedback = httpsCallable(functions, "getTOEFLFeedback");

    btnGetQ.onclick = async () => {
      qStatus.textContent = "Loading question…";
      questionBox.textContent = "";
      feedbackText.textContent = "";
      feedbackJson.style.display = "none";
      transcriptBox.textContent = "";
      playback.style.display = "none";
      cancelled = false;

      try {
        const res = await getTOEFLQuestion({});
        currentQuestion = res.data?.question || "";
        questionBox.textContent = currentQuestion;
        qStatus.textContent = "Ready.";
        btnStartPrep.disabled = false;
      } catch (e) {
        qStatus.textContent = "Failed to load question.";
        console.error(e);
      }
    };

    btnCancel.onclick = () => {
      cancelled = true;
      stopRecordingIfAny();
      btnStartPrep.disabled = false;
      speakTimerEl.textContent = "--";
      prepTimerEl.textContent = "--";
    };

    btnStartPrep.onclick = async () => {
      if (!currentQuestion) {
        alert("Get a question first.");
        return;
      }
      btnStartPrep.disabled = true;
      btnCancel.disabled = false;
      cancelled = false;

      // 1) 15s Prep timer
      await runCountdown(prepTimerEl, 15);
      if (cancelled) return;

      // 2) Record 45s answer
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: pickMimeType() });
      } catch (e) {
        alert("Microphone permission denied or unsupported.");
        btnStartPrep.disabled = false;
        btnCancel.disabled = true;
        return;
      }

      chunks = [];
      mediaRecorder.ondataavailable = (evt) => { if (evt.data.size > 0) chunks.push(evt.data); };
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
        const base64 = await blobToBase64(blob);
        const audioUrl = URL.createObjectURL(blob);
        playback.src = audioUrl;
        playback.style.display = "block";

        // 3) Send to backend for feedback
        feedbackText.textContent = "Scoring your response…";
        try {
          const res = await getTOEFLFeedback({
            audioBase64: base64,
            audioType: mediaRecorder.mimeType,
            currentQuestion
          });
          const fb = res.data || {};
          // Show compact summary
          feedbackText.innerHTML = `
            <div><strong>Overall Score:</strong> ${fb.overall_score}</div>
            <div><strong>Delivery:</strong> ${escapeHtml(fb.delivery)}</div>
            <div><strong>Language Use:</strong> ${escapeHtml(fb.language_use)}</div>
            <div><strong>Topic Development:</strong> ${escapeHtml(fb.topic_development)}</div>
            <hr/>
            <div class="muted">WPM: ${fb?.delivery_stats?.words_per_minute ?? "—"}, Pauses: ${fb?.delivery_stats?.pause_count ?? "—"}, Max pause: ${fb?.delivery_stats?.max_pause_seconds ?? "—"}s, Fillers: ${fb?.delivery_stats?.total_fillers ?? "—"}</div>
          `;
          transcriptBox.textContent = fb.transcript || "";
          // Expandable raw JSON if you want
          feedbackJson.textContent = JSON.stringify(fb, null, 2);
          feedbackJson.style.display = "block";
        } catch (e) {
          console.error(e);
          feedbackText.textContent = "Failed to score. Try again.";
        } finally {
          btnCancel.disabled = true;
          btnStartPrep.disabled = false;
        }
      };

      mediaRecorder.start();
      await runCountdown(speakTimerEl, 45);
      if (!cancelled) mediaRecorder.stop();
      stopStream(mediaRecorder?.stream);
      btnCancel.disabled = true;
      btnStartPrep.disabled = false;
    };

    function stopRecordingIfAny() {
      try {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      } catch {}
      stopStream(mediaRecorder?.stream);
    }

    function stopStream(stream) {
      if (stream) stream.getTracks().forEach((t) => t.stop());
    }

    async function runCountdown(el, seconds) {
      return new Promise((resolve) => {
        let t = seconds;
        el.textContent = `${t}s`;
        const id = setInterval(() => {
          if (cancelled) { clearInterval(id); el.textContent = "--"; resolve(); return; }
          t -= 1;
          el.textContent = `${t}s`;
          if (t <= 0) { clearInterval(id); resolve(); }
        }, 1000);
      });
    }

    function pickMimeType() {
      const canWebm = MediaRecorder.isTypeSupported("audio/webm");
      const canOgg = MediaRecorder.isTypeSupported("audio/ogg");
      const canMp4 = MediaRecorder.isTypeSupported("audio/mp4");
      if (canWebm) return "audio/webm";
      if (canOgg) return "audio/ogg";
      if (canMp4) return "audio/mp4";
      return "audio/webm"; // fallback
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result); // includes data:...;base64,
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }
  </script>
</body>
</html>
