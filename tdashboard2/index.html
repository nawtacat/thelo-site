<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title">Tutor Dashboard | thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <style>
    /*
     * ============================================
     * Custom Font Definitions for Armenian (Montserrat Arm) - RESTORED
     * ============================================
     */
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype');
      font-weight: 400; /* Regular */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-SemiBold.otf') format('opentype');
      font-weight: 600; /* SemiBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }
    @font-face {
      font-family: 'Montserrat Arm';
      src: url('https://thelo.space/fonts/Montserratarm-ExtraBold.otf') format('opentype');
      font-weight: 800; /* ExtraBold */
      font-style: normal;
      font-display: swap;
      unicode-range: U+0530-058F, U+FB13-FB17;
    }

    /*
     * ============================================
     * Main Site Styles
     * ============================================
     */
    :root {
        --thelo-blue: #2563EB;
        --thelo-bg: #F8F9FA;
        --thelo-text: #111827;
        --grid-color: #E5E7EB;
    }
    html { scroll-behavior: smooth; }
    body {
        /* Updated font stack to prioritize Montserrat Arm */
        font-family: 'Montserrat Arm', 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--thelo-bg);
        color: var(--thelo-text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-image:
            linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
            linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        background-size: 40px 40px;
        min-height: 100vh;
    }
    /* Removed language-specific body font rules */

    /* Heading Weights */
    h1, h2, h3, h4, h5, h6 { font-weight: 800; }
    /* Removed Armenian-specific heading weights, rely on font stack */

    .nav-link { 
        @apply font-semibold text-[var(--thelo-text)] transition-colors duration-200;
    }
    .nav-link:hover { 
        color: var(--thelo-blue); 
    }

    .window-container {
        position: relative;
        background-color: white;
        border: 1px solid var(--grid-color);
        border-radius: 0.75rem; 
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
        padding: 2.5rem; 
    }
    .window-container::before {
        content: ' ';
        position: absolute;
        top: 1.5rem; 
        left: 1.5rem; 
        width: 52px;
        height: 12px;
        background-image: url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E%0A");
        background-repeat: no-repeat;
        z-index: 1;
    }

    /* Button Styles */
    .thelo-btn, .thelo-btn-secondary, .thelo-btn-destructive {
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        cursor: pointer; 
    }
    .thelo-btn {
        background-color: var(--thelo-blue);
        color: white;
    }
    .thelo-btn:hover {
        background-color: #1a56d2; 
        transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); 
    }
    .thelo-btn-secondary {
        background-color: transparent;
        color: var(--thelo-blue);
        border-color: var(--thelo-blue);
    }
    .thelo-btn-secondary:hover {
        background-color: var(--thelo-blue);
        color: white;
    }
    .thelo-btn-secondary-sm {
        font-weight: 600; 
        padding: 0.375rem 0.75rem; 
        font-size: 0.875rem; 
        border-radius: 0.375rem; 
        transition: all 0.2s ease-in-out;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--thelo-blue);
        background-color: transparent;
        color: var(--thelo-blue);
        cursor: pointer;
    }
     .thelo-btn-secondary-sm:hover {
         background-color: var(--thelo-blue);
         color: white;
     }

    .thelo-btn:disabled, .thelo-btn-secondary:disabled, .thelo-btn-secondary-sm:disabled {
        @apply bg-slate-300 border-slate-300 text-slate-500 cursor-not-allowed transform-none shadow-none;
    }

    .input-field {
        @apply w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition-all duration-200 focus:bg-white;
    }
 
    .lang-btn {
        @apply cursor-pointer font-bold text-slate-400;
    }
    .lang-btn.active {
        @apply text-[var(--thelo-blue)];
    }

    /* Notification Toast Styles */
    #notification-toast { @apply fixed bottom-5 right-5 bg-green-600 text-white p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-y-10 opacity-0 z-50; }
    #notification-toast.show { @apply transform-none opacity-100; }
    #notification-toast.error { @apply bg-red-600; }

    /* Tab Styles */
    .tab-btn { @apply border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm cursor-pointer; }
    .tab-btn.active { @apply border-[var(--thelo-blue)] text-[var(--thelo-blue)]; }
    .tab-panel { @apply py-6; }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000; backdrop-filter: blur(4px); 
        opacity: 0; transition: opacity 0.3s ease-out; padding: 1rem;
    }
    .modal-overlay.hidden { display: none; }
    .modal-overlay:not(.hidden) { display: flex; }
    .modal-overlay.show { opacity: 1; }
    .modal-content {
        background: white; padding: 2rem; border-radius: 0.75rem; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%;
        position: relative; opacity: 0; transform: scale(0.95);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    .modal-overlay.show .modal-content { opacity: 1; transform: scale(1); }
    .modal-label { font-weight: 600; font-size: 0.875rem; @apply block text-slate-700; }
    .modal-content .input-field { margin-top: 0.25rem; }
    .modal-close-btn { @apply absolute top-4 right-4 text-3xl font-light text-slate-400 hover:text-slate-700 cursor-pointer; }
    #result-modal-content { max-width: 56rem; }
    #create-group-modal-content { max-width: 28rem; }

    /* Question Detail Styles */
    .question-item { @apply border border-slate-200 rounded-lg p-4; }
    .question-header { @apply flex justify-between items-center; }
    .question-title { @apply text-lg font-bold text-slate-800; }
    .question-status-correct { @apply text-sm font-bold bg-green-100 text-green-700 px-3 py-1 rounded-full; }
    .question-status-incorrect { @apply text-sm font-bold bg-red-100 text-red-700 px-3 py-1 rounded-full; }
    .question-status-other { @apply text-sm font-bold bg-slate-100 text-slate-700 px-3 py-1 rounded-full; }
    .question-body { @apply mt-4 grid grid-cols-1 md:grid-cols-2 gap-4; }
    .question-label { @apply block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2; }
    .student-solution-img { @apply w-full h-auto bg-white border border-slate-300 rounded-md object-contain; }
    .feedback-text { @apply p-3 bg-slate-50 rounded-md text-slate-700 text-sm prose max-w-none; }

    /* Custom Dropdown Styles - Simplified */
    .custom-dropdown { @apply relative inline-block w-full max-w-md; }
    .dropdown-button { @apply w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition-all duration-200 focus:bg-white text-left flex justify-between items-center cursor-pointer; }
    .dropdown-button span { @apply truncate pr-2; }
    .dropdown-button svg { @apply w-5 h-5 text-slate-400 transition-transform duration-200; }
     /* Removed open class styling for arrow */
    .dropdown-panel { @apply absolute left-0 right-0 mt-1 w-full bg-white border border-slate-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden; /* Hidden by default */ }
    .dropdown-panel.show { @apply block; /* Show */ } /* Simpler show/hide */
    .dropdown-item { @apply block w-full px-4 py-3 text-left cursor-pointer hover:bg-slate-50; }
    .dropdown-item.selected { @apply bg-blue-50 font-semibold text-[var(--thelo-blue)]; }
   
    /* Responsive Styles */
    @media (max-width: 767px) {
         main { padding-left: 1rem; padding-right: 1rem; }
         h1 { font-size: 2.5rem; } 
         h2 { font-size: 1.75rem; } 
         .window-container { padding: 2rem 1rem; border-radius: 1rem; }
         .window-container::before { top: 1rem; left: 1rem; transform: scale(0.8); transform-origin: top left; }
         .modal-content { margin: 1rem; }
         .nav-link { font-size: 0.875rem; } 
         /* Removed .thelo-btn-nav style */
         .thelo-btn-secondary { padding: 0.5rem 0.75rem; font-size: 0.875rem;} /* Adjust secondary button */
    }

   </style>
</head>

<body class="antialiased">

<nav id="mainNav" class="w-full z-40"> 
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-5 lg:px-8">
        <a href="/" class="flex items-center gap-2">
            <img src="https://thelo.space/img/bluethelo.svg" alt="thelo logo" class="h-10 w-auto" />
            <span class="text-lg font-bold text-slate-600 border-l pl-3 ml-1" data-i18n="navTutorPortal">Tutor Portal</span>
        </a>
       
        <div class="flex items-center gap-4">
            <button id="nav-create-group-btn" class="thelo-btn-secondary hidden md:flex" data-i18n="navCreateGroup"> 
                Create Group
            </button>
            <ul class="hidden gap-6 md:flex">
                <li><a href="#" id="logout-btn" class="nav-link" data-i18n="navLogout">Log Out</a></li>
            </ul>
            <div class="flex items-center gap-2 text-sm border-l pl-4 ml-2">
                <span id="lang-en" class="lang-btn">EN</span>
                <span class="text-slate-300">|</span>
                <span id="lang-hy" class="lang-btn">HY</span>
            </div>
        </div>
    </div>
</nav>

<main class="pt-12 pb-16 lg:pt-16 lg:pb-24"> <div class="mx-auto max-w-7xl px-6 lg:px-8">

        <div id="loading-state" class="text-center py-20">
            <h2 class="text-2xl font-bold text-slate-600" data-i18n="loading">Loading Dashboard...</h2>
        </div>

        <div id="error-state" class="hidden text-center py-20 window-container max-w-3xl mx-auto">
            <h2 class="text-3xl font-bold text-red-600" data-i18n="errorTitle">Access Denied</h2>
            <p class="text-lg text-slate-600 mt-4" data-i18n="errorSubtitle">You must be a registered tutor to access this page. Please contact support if you believe this is an error.</p>
            <a href="/" class="thelo-btn inline-block mt-8" data-i18n="errorButton">Back to Home</a>
        </div>

        <div id="dashboard-content" class="hidden">
            <div class="flex justify-between items-center mb-8"> 
                <div>
                    <h1 class="text-4xl font-extrabold tracking-tighter text-[var(--thelo-text)] sm:text-5xl" data-i18n="dashboardTitle">Tutor Dashboard</h1>
                    <p class="text-lg text-slate-600 mt-4" id="welcome-message" data-i18n="dashboardSubtitle">Welcome, tutor. Select a group to get started.</p>
                </div>
                <button id="nav-create-group-btn-mobile" class="thelo-btn-secondary md:hidden" data-i18n="navCreateGroupShort">
                    New
                </button>
            </div>

            <div class="mt-8"> 
                <section class="w-full window-container">
                    <div> <div class="mb-10"> 
                            <label class="block text-sm font-bold text-slate-700 mb-3" data-i18n="groupsTitle">My Groups</label> <div id="custom-group-dropdown" class="custom-dropdown">
                                <button id="dropdown-button" class="dropdown-button">
                                    <span id="selected-group-text" data-i18n="groupsSelectDefault">Select a group...</span>
                                    <svg class="w-5 h-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>                                       
                                </button>
                                <div id="dropdown-panel" class="dropdown-panel">
                                    </div>
                            </div>
                             <p id="no-groups-msg" class="text-slate-500 mt-2 hidden" data-i18n="groupsNone">You haven't created any groups yet.</p>
                        </div>
                                   
                        <h2 id="results-title" class="text-2xl font-bold mt-8" data-i18n="resultsTitleDefault">Select a group</h2>
                       
                        <div id="results-empty-state" class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 16.5h16.5M3.75 8.25h16.5M3.75 4.5h16.5" /> </svg>
                            <h3 class="mt-2 text-lg font-semibold text-slate-800" data-i18n="resultsTitleDefault">Select a group</h3>
                            <p id="results-placeholder" class="mt-1 text-sm text-slate-500" data-i18n="resultsSelectPrompt">Select a group from the list to view its details.</p>
                        </div>

                        <div id="results-content" class="hidden">
                            <div class="border-b border-slate-200">
                                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                    <button id="tab-btn-results" class="tab-btn active" data-i18n="tabResults">Results</button>
                                    <button id="tab-btn-roster" class="tab-btn" data-i18n="tabRoster">Student Roster</button>
                                </nav>
                            </div>

                            <div id="tab-panel-results" class="tab-panel">
                                <div id="results-container" class="overflow-x-auto">
                                    <p id="results-none-msg" class="text-lg text-slate-500 hidden" data-i18n="resultsNone"></p>
                                    <table id="results-table" class="hidden min-w-full divide-y divide-slate-200">
                                        <thead class="bg-slate-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableStudent">Student</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableTest">Test ID</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableScore">Score</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableTime">Time</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="tableDate">Date</th>
                                                <th scope="col" class="relative px-6 py-3"> <span class="sr-only" data-i18n="tableViewSr">View</span> </th>
                                            </tr>
                                        </thead>
                                        <tbody id="results-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="tab-panel-roster" class="tab-panel hidden">
                                <div id="roster-container">
                                    <h3 class="text-xl font-bold text-slate-700 sr-only" data-i18n="rosterTitle">Student Roster</h3>
                                    <div id="roster-list" class="mt-4 p-4 bg-slate-50 rounded-lg max-h-96 overflow-y-auto">
                                        <span id="roster-none-msg" class="text-slate-500 italic hidden" data-i18n="rosterNone"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</main>

<div id="notification-toast" class="hidden"> <span id="notification-message"></span> </div>

<div id="create-group-modal-overlay" class="modal-overlay hidden"> 
    <div id="create-group-modal-content" class="modal-content">
        <button id="create-group-modal-close-btn" class="modal-close-btn">&times;</button>
        <h2 class="text-2xl font-bold" data-i18n="groupsCreateTitle">Create New Group</h2>
        <form id="create-group-form" class="mt-6 space-y-4">
            <div>
                <label for="group-name-input" class="modal-label" data-i18n="groupsCreateLabel">Group Name</label>
                <input type="text" id="group-name-input" class="input-field mt-1" placeholder="e.g. Algebra 1 (Fall)" required>
            </div>
            <button type="submit" id="create-group-submit-btn" class="thelo-btn w-full"> <span data-i18n="groupsCreateButton">Create Group</span> </button>
        </form>
    </div>
</div>

<div id="result-modal-overlay" class="modal-overlay hidden">
    <div id="result-modal-content" class="modal-content">
        <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        <h2 class="text-2xl font-bold" id="modal-title" data-i18n="modalTestDetailsTitle">Test Result Details</h2>
        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div> <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="modalLabelStudent">Student</span> <span class="block font-medium text-slate-800" id="modal-student-email"></span> </div>
            <div> <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="modalLabelTestID">Test ID</span> <span class="block font-medium text-slate-800" id="modal-test-id"></span> </div>
            <div> <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="modalLabelScore">Score</span> <span class="block font-medium text-slate-800" id="modal-score"></span> </div>
            <div> <span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider" data-i18n="modalLabelTime">Time Taken</span> <span class="block font-medium text-slate-800" id="modal-time"></span> </div>
        </div>
        <div id="modal-results-container" class="mt-8 space-y-6 max-h-[60vh] overflow-y-auto pr-2"></div>
    </div>
</div>


<script type="module">
    // Firebase SDK imports...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Config...
    const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", projectId: "physmathacademy-722b3", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    try { setLogLevel('debug'); } catch (e) { console.warn("Could not set Firestore log level:", e); }

    // DOM Elements...
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const dashboardContent = document.getElementById('dashboard-content');
    const welcomeMessage = document.getElementById('welcome-message');
    const logoutBtn = document.getElementById('logout-btn');
    const langEnBtn = document.getElementById('lang-en');
    const langHyBtn = document.getElementById('lang-hy');
    // Custom Dropdown Elements
    const customDropdown = document.getElementById('custom-group-dropdown');
    const dropdownButton = document.getElementById('dropdown-button');
    const selectedGroupText = document.getElementById('selected-group-text');
    const dropdownPanel = document.getElementById('dropdown-panel');
    const noGroupsMsg = document.getElementById('no-groups-msg');
    // Content Panel
    const resultsTitle = document.getElementById('results-title');
    const resultsEmptyState = document.getElementById('results-empty-state');
    const resultsContent = document.getElementById('results-content');
    const tabBtnResults = document.getElementById('tab-btn-results');
    const tabBtnRoster = document.getElementById('tab-btn-roster');
    const tabPanelResults = document.getElementById('tab-panel-results');
    const tabPanelRoster = document.getElementById('tab-panel-roster');
    const resultsContainer = document.getElementById('results-container');
    const resultsNoneMsg = document.getElementById('results-none-msg');
    const resultsTable = document.getElementById('results-table');
    const resultsTableBody = document.getElementById('results-table-body');
    const rosterContainer = document.getElementById('roster-container');
    const rosterList = document.getElementById('roster-list');
    const rosterNoneMsg = document.getElementById('roster-none-msg');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    // Modals
    const navCreateGroupBtn = document.getElementById('nav-create-group-btn');
    const navCreateGroupBtnMobile = document.getElementById('nav-create-group-btn-mobile');
    const createGroupModalOverlay = document.getElementById('create-group-modal-overlay');
    const createGroupModalCloseBtn = document.getElementById('create-group-modal-close-btn');
    const createGroupForm = document.getElementById('create-group-form');
    const groupNameInput = document.getElementById('group-name-input');
    const createGroupSubmitBtn = document.getElementById('create-group-submit-btn');
    const resultModalOverlay = document.getElementById('result-modal-overlay');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalStudentEmail = document.getElementById('modal-student-email');
    const modalTestId = document.getElementById('modal-test-id');
    const modalScore = document.getElementById('modal-score');
    const modalTime = document.getElementById('modal-time');
    const modalResultsContainer = document.getElementById('modal-results-container');

    // App State...
    let currentUser = null;
    let currentTutor = null;
    let selectedGroupId = null;
    let currentLang = localStorage.getItem('thelo-lang') || 'en';
    let allGroups = []; 
    let isDropdownOpen = false; 

    // UI Strings (i18n)...
    const strings = {
        en: {
            title: 'Tutor Dashboard | thelo', navTutorPortal: 'Tutor Portal', navLogout: 'Log Out', navCreateGroup: 'Create Group', navCreateGroupShort: 'New', loading: 'Loading Dashboard...', loadingSubmit: 'Creating...', errorTitle: 'Access Denied', errorSubtitle: 'You must be a registered tutor to access this page. Please contact support if you believe this is an error.', errorButton: 'Back to Home', dashboardTitle: 'Tutor Dashboard', dashboardSubtitle: 'Welcome. Select a group to get started.', groupsTitle: 'My Groups', groupsSelectDefault: 'Select a group...', groupsNone: "You haven't created any groups yet.", groupsCreateTitle: 'Create New Group', groupsCreateLabel: 'Group Name', groupsCreateButton: 'Create Group', groupsCreateSuccess: 'Group "{groupName}" created! Join Code: {joinCode}', groupsCreateError: 'Error creating group. Please try again.', joinCode: 'Join Code', resultsTitleDefault: 'Select a group', resultsSelectPrompt: 'Select a group from the list to view its details.', resultsTitleLoading: 'Loading results for "{groupName}"...', resultsTitleLoaded: 'Showing results for "{groupName}"', resultsNone: 'No test results found for this group yet.', rosterTitle: 'Student Roster', rosterNone: 'No students have joined this group yet.', tabResults: 'Results', tabRoster: 'Student Roster', tableStudent: 'Student', tableTest: 'Test ID', tableScore: 'Score', tableTime: 'Time', tableDate: 'Date', tableTimeValue: '{time}s', tableView: 'View', tableViewSr: 'View Details', modalTestDetailsTitle: 'Test Result Details', modalLabelStudent: 'Student', modalLabelTestID: 'Test ID', modalLabelScore: 'Score', modalLabelTime: 'Time Taken', statusCorrect: 'Correct', statusIncorrect: 'Incorrect', modalQuestionTitle: 'Question {index}', modalLabelSolution: "Student's Solution", modalLabelFeedback: 'AI Feedback'
        },
        hy: {
            title: 'Ուսուցչի Վահանակ | Թելո', navTutorPortal: 'Ուսուցչի Վահանակ', navLogout: 'Դուրս գալ', navCreateGroup: 'Ստեղծել Խումբ', navCreateGroupShort: 'Նոր', loading: 'Բեռնվում է...', loadingSubmit: 'Ստեղծվում է...', errorTitle: 'Մուտքը մերժված է', errorSubtitle: 'Դուք պետք է լինեք գրանցված ուսուցիչ՝ այս էջը տեսնելու համար։', errorButton: 'Գլխավոր էջ', dashboardTitle: 'Ուսուցչի Վահանակ', dashboardSubtitle: 'Բարի գալուստ։ Ընտրեք խումբ՝ սկսելու համար։', groupsTitle: 'Իմ Խմբերը', groupsSelectDefault: 'Ընտրեք խումբ...', groupsNone: 'Դուք դեռ խմբեր չեք ստեղծել։', groupsCreateTitle: 'Ստեղծել Նոր Խումբ', groupsCreateLabel: 'Խմբի Անունը', groupsCreateButton: 'Ստեղծել Խումբ', groupsCreateSuccess: '«{groupName}» խումբը ստեղծված է։ Միանալու կոդը՝ {joinCode}', groupsCreateError: 'Սխալ՝ խումբ ստեղծելիս։ Խնդրում ենք փորձել նորից։', joinCode: 'Միանալու կոդ', resultsTitleDefault: 'Ընտրեք խումբ', resultsSelectPrompt: 'Ընտրեք խումբ ցանկից՝ մանրամասները տեսնելու համար։', resultsTitleLoading: 'Բեռնվում են «{groupName}» խմբի արդյունքները...', resultsTitleLoaded: '«{groupName}» խմբի արդյունքները', resultsNone: 'Այս խմբի համար թեստի արդյունքներ դեռ չկան։', rosterTitle: 'Աշակերտների Ցուցակ', rosterNone: 'Այս խմբին դեռ ոչ մի աշակերտ չի միացել։', tabResults: 'Արդյունքներ', tabRoster: 'Աշակերտների Ցուցակ', tableStudent: 'Աշակերտ', tableTest: 'Թեստի ID', tableScore: 'Միավոր', tableTime: 'Ժամանակ', tableDate: 'Ամսաթիվ', tableTimeValue: '{time}վ', tableView: 'Դիտել', tableViewSr: 'Դիտել Մանրամասները', modalTestDetailsTitle: 'Թեստի Արդյունքների Մանրամասներ', modalLabelStudent: 'Աշակերտ', modalLabelTestID: 'Թեստի ID', modalLabelScore: 'Միավոր', modalLabelTime: 'Ծախսած Ժամանակ', statusCorrect: 'Ճիշտ է', statusIncorrect: 'Սխալ է', modalQuestionTitle: 'Հարց {index}', modalLabelSolution: 'Աշակերտի Լուծումը', modalLabelFeedback: 'AI-ի Կարծիքը'
        }
    };

    /** Shows notification toast */
    function showNotification(message, isError = false) {
        const toast = document.getElementById('notification-toast');
        const msgEl = document.getElementById('notification-message');
        if (!toast || !msgEl) return;
        msgEl.textContent = message;
        toast.classList.toggle('error', isError);
        toast.classList.remove('hidden');
        requestAnimationFrame(() => { toast.classList.add('show'); });
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toast.classList.add('hidden'); toast.classList.remove('error'); }, 300); 
        }, 3000);
    }

    /** Applies UI text based on language */
    function applyContent(lang) {
        const T = strings[lang];
        if (!T) return;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (T[key]) { el.innerHTML = T[key]; }
        });
        document.documentElement.lang = lang;
        langEnBtn.classList.toggle('active', lang === 'en');
        langHyBtn.classList.toggle('active', lang === 'hy');
       
        groupNameInput.placeholder = (lang === 'hy') ? 'օր.՝ Հանրահաշիվ 1 (Աշուն)' : 'e.g. Algebra 1 (Fall)';
        resultsNoneMsg.textContent = T.resultsNone;
        rosterNoneMsg.textContent = T.rosterNone;
        if (resultsPlaceholder) resultsPlaceholder.textContent = T.resultsSelectPrompt;
       
        const defaultTitleEls = document.querySelectorAll('[data-i18n="resultsTitleDefault"]');
        defaultTitleEls.forEach(el => el.textContent = T.resultsTitleDefault);
        if (!selectedGroupId) resultsTitle.textContent = T.resultsTitleDefault;

        if (!selectedGroupId) {
            selectedGroupText.textContent = T.groupsSelectDefault;
        } else {
             const selectedGroup = allGroups.find(g => g.id === selectedGroupId);
             if(selectedGroup) selectedGroupText.textContent = `${selectedGroup.groupName} (Code: ${selectedGroup.joinCode})`;
             else selectedGroupText.textContent = T.groupsSelectDefault; 
        }

        const tableHeaders = resultsTable.querySelectorAll('thead th[data-i18n]');
        tableHeaders.forEach(th => {
            const key = th.dataset.i18n;
             if (T[key]) { th.textContent = T[key]; }
        });
        const srViewHeader = resultsTable.querySelector('thead th span[data-i18n="tableViewSr"]');
         if (srViewHeader && T.tableViewSr) { srViewHeader.textContent = T.tableViewSr; }
    }

    /** Formats string with values */
    function formatString(str, values) { return str.replace(/{(\w+)}/g, (match, key) => values[key] || match); }

    /** Auth state change handler */
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            try {
                const tutorDocRef = doc(db, "tutors", user.email);
                const tutorDoc = await getDoc(tutorDocRef);
                if (tutorDoc.exists()) {
                    currentTutor = { email: user.email, uid: user.uid, ...tutorDoc.data() };
                    await initDashboard();
                } else { console.warn("User is not listed:", user.email); showErrorState(); }
            } catch (err) { console.error("Error checking tutor:", err); showErrorState(); }
        } else { window.location.href = '/auth'; }
    });

    /** Shows error state */
    function showErrorState() { loadingState.classList.add('hidden'); errorState.classList.remove('hidden'); }

    /** Initializes dashboard */
    async function initDashboard() {
        loadingState.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
        const T = strings[currentLang];
        welcomeMessage.textContent = formatString(T.dashboardSubtitle, { tutorEmail: currentTutor.email });
        applyContent(currentLang);
        setupEventListeners();
        await loadGroups();
    }

    /** Sets up event listeners */
    function setupEventListeners() {
        logoutBtn.addEventListener('click', handleLogout);
        langEnBtn.addEventListener('click', () => switchLanguage('en'));
        langHyBtn.addEventListener('click', () => switchLanguage('hy'));
        navCreateGroupBtn.addEventListener('click', showCreateGroupModal);
        navCreateGroupBtnMobile.addEventListener('click', showCreateGroupModal);
        createGroupModalCloseBtn.addEventListener('click', hideCreateGroupModal);
        createGroupModalOverlay.addEventListener('click', (e) => { if (e.target === createGroupModalOverlay) hideCreateGroupModal(); });
        createGroupForm.addEventListener('submit', handleCreateGroup);
        tabBtnResults.addEventListener('click', () => switchTab('results'));
        tabBtnRoster.addEventListener('click', () => switchTab('roster'));
        resultModalOverlay.addEventListener('click', (e) => { if (e.target === resultModalOverlay) hideResultDetail(); });
        modalCloseBtn.addEventListener('click', hideResultDetail);
        dropdownButton.addEventListener('click', toggleDropdown);
        document.addEventListener('click', (event) => { if (!customDropdown.contains(event.target) && isDropdownOpen) closeDropdown(); });
    }
   
    /** Switches active language */
    function switchLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('thelo-lang', currentLang);
        applyContent(currentLang); // Apply text first
        loadGroups(selectedGroupId); // Reload groups dropdown content with new lang
       
        // If a group is selected, reload its data to update table dates/text
        if (selectedGroupId) {
            const selectedGroup = allGroups.find(g => g.id === selectedGroupId);
            if (selectedGroup) {
                // Ensure the dropdown button text is correct after potential async loadGroups
                selectedGroupText.textContent = `${selectedGroup.groupName} (Code: ${selectedGroup.joinCode})`; 
                loadGroupData(selectedGroup); // Reload table data etc.
            } else {
                 selectedGroupText.textContent = strings[currentLang].groupsSelectDefault; // Fallback if group not found (shouldn't happen)
                 showEmptyState();
            }
        } else {
             selectedGroupText.textContent = strings[currentLang].groupsSelectDefault; // Ensure default text if no group selected
        }
    }

    /** Switches active tab */
    function switchTab(tabId) {
        const isActive = tabId === 'results';
        tabBtnResults.classList.toggle('active', isActive);
        tabPanelResults.classList.toggle('hidden', !isActive);
        tabBtnRoster.classList.toggle('active', !isActive);
        tabPanelRoster.classList.toggle('hidden', isActive);
    }
   
     /** Toggles custom dropdown visibility */
     function toggleDropdown() {
         isDropdownOpen = !isDropdownOpen;
         dropdownPanel.classList.toggle('show', isDropdownOpen);
         // No arrow rotation needed now
     }

     /** Closes custom dropdown */
     function closeDropdown() {
         isDropdownOpen = false;
         dropdownPanel.classList.remove('show');
         // No arrow rotation needed now
     }

    /** Handles group selection from custom dropdown */
    function handleGroupSelect(groupId) {
        selectedGroupId = groupId;
        closeDropdown(); 

        if (!selectedGroupId) {
            showEmptyState();
            selectedGroupText.textContent = strings[currentLang].groupsSelectDefault; 
            document.querySelectorAll('.dropdown-item').forEach(item => { item.classList.toggle('selected', !item.dataset.groupId); });
            return;
        }
       
        const selectedGroup = allGroups.find(g => g.id === selectedGroupId);
        if (selectedGroup) {
            selectedGroupText.textContent = `${selectedGroup.groupName} (Code: ${selectedGroup.joinCode})`;
            document.querySelectorAll('.dropdown-item').forEach(item => { item.classList.toggle('selected', item.dataset.groupId === selectedGroupId); });
            loadGroupData(selectedGroup);
        }
    }

    /** Resets the main panel to empty state */
    function showEmptyState() {
        const T = strings[currentLang];
        resultsTitle.textContent = T.resultsTitleDefault;
        resultsEmptyState.classList.remove('hidden');
        resultsContent.classList.add('hidden');
    }

    /** Logs the user out */
    async function handleLogout(e) { e.preventDefault(); try { await signOut(auth); window.location.href = '/'; } catch (err) { console.error("Error logging out:", err); } }

    /** Loads groups into the custom dropdown */
    async function loadGroups(preserveSelected = null) {
        allGroups = []; 
        const T = strings[currentLang];
        dropdownPanel.innerHTML = ''; 
       
        const q = query(collection(db, "groups"), where("ownerId", "==", currentUser.uid));
        try {
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                noGroupsMsg.classList.remove('hidden'); customDropdown.classList.add('hidden'); 
                showEmptyState(); selectedGroupText.textContent = T.groupsSelectDefault; 
                return;
            }
           
            noGroupsMsg.classList.add('hidden'); customDropdown.classList.remove('hidden'); 
           
            const groups = [];
            querySnapshot.forEach(doc => groups.push({ id: doc.id, ...doc.data() }));
            groups.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

             const defaultItem = document.createElement('button');
             defaultItem.className = 'dropdown-item';
             defaultItem.textContent = T.groupsSelectDefault;
             let isPreservedSelected = preserveSelected && groups.some(g => g.id === preserveSelected); // Check if preserved ID exists
             defaultItem.classList.toggle('selected', !isPreservedSelected); // Select default if nothing preserved or preserved is invalid
             defaultItem.onclick = () => handleGroupSelect(null); 
             dropdownPanel.appendChild(defaultItem);

            groups.forEach(group => {
                allGroups.push(group); // Keep track of all groups
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.dataset.groupId = group.id; 
                item.textContent = `${group.groupName} (Code: ${group.joinCode})`;
                 item.classList.toggle('selected', preserveSelected === group.id);
                item.onclick = () => handleGroupSelect(group.id);
                dropdownPanel.appendChild(item);
            });

            if (isPreservedSelected) {
                 selectedGroupId = preserveSelected; 
                 const selectedGroup = allGroups.find(g => g.id === preserveSelected);
                 selectedGroupText.textContent = `${selectedGroup.groupName} (Code: ${selectedGroup.joinCode})`;
            } else {
                 selectedGroupId = null; 
                 selectedGroupText.textContent = T.groupsSelectDefault; 
                 if (!preserveSelected) showEmptyState(); 
            }

        } catch (err) { console.error("Error loading groups:", err); noGroupsMsg.textContent = "Error loading groups."; noGroupsMsg.classList.remove('hidden'); }
    }

    /** Generates join code */
    function generateJoinCode() { const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789'; let r = ''; for (let i = 0; i < 6; i++) r += chars.charAt(Math.floor(Math.random() * chars.length)); return r; }
    /** Shows create group modal */
    function showCreateGroupModal() { createGroupModalOverlay.classList.remove('hidden'); setTimeout(() => createGroupModalOverlay.classList.add('show'), 10); }
    /** Hides create group modal */
    function hideCreateGroupModal() { createGroupModalOverlay.classList.remove('show'); setTimeout(() => createGroupModalOverlay.classList.add('hidden'), 300); }

    /** Handles create group form submission */
    async function handleCreateGroup(e) {
        e.preventDefault();
        const groupName = groupNameInput.value.trim();
        if (!groupName) return;
       
        createGroupSubmitBtn.disabled = true;
        const T = strings[currentLang];
        createGroupSubmitBtn.querySelector('span').textContent = T.loadingSubmit; 
       
        const newGroup = { groupName, ownerId: currentUser.uid, ownerEmail: currentUser.email, joinCode: generateJoinCode(), createdAt: serverTimestamp(), memberIds: [] };
        try {
            const docRef = await addDoc(collection(db, "groups"), newGroup);
            showNotification(formatString(T.groupsCreateSuccess, { groupName: newGroup.groupName, joinCode: newGroup.joinCode }));
            groupNameInput.value = '';
            hideCreateGroupModal();
            await loadGroups(docRef.id); 
            handleGroupSelect(docRef.id); 

        } catch (err) { console.error("Error creating group:", err); showNotification(T.groupsCreateError, true);
        } finally { createGroupSubmitBtn.disabled = false; createGroupSubmitBtn.querySelector('span').textContent = T.groupsCreateButton; }
    }

   /** Shows result detail modal */
   async function showResultDetail(result) {
        const T = strings[currentLang];
        modalStudentEmail.textContent = result.email; modalTestId.textContent = result.testId; modalScore.textContent = `${result.score} / ${result.totalQuestions}`; modalTime.textContent = formatString(T.tableTimeValue, { time: result.timeTakenSeconds }); modalResultsContainer.innerHTML = '<p>Loading details...</p>'; 
        try {
            const detailQuery = query(collection(db, "thelo-test-results", result.id, "results"));
            const detailSnapshot = await getDocs(detailQuery);
            if (detailSnapshot.empty) { modalResultsContainer.innerHTML = '<p>No detailed breakdown available.</p>'; } else {
                modalResultsContainer.innerHTML = ''; const questions = [];
                detailSnapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));
                questions.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                questions.forEach((q, index) => {
                    let statusClass = 'question-status-other', statusText = q.status || 'N/A';
                    if (q.status === 'correct') { statusClass = 'question-status-correct'; statusText = T.statusCorrect; } 
                    else if (q.status === 'incorrect') { statusClass = 'question-status-incorrect'; statusText = T.statusIncorrect; }
                    const questionEl = document.createElement('div'); questionEl.className = 'question-item';
                    questionEl.innerHTML = `<div class="question-header"><span class="question-title">${formatString(T.modalQuestionTitle, { index: index + 1 })}</span><span class="${statusClass}">${statusText}</span></div><div class="question-body"><div><span class="question-label">${T.modalLabelSolution}</span><img src="${q.solutionImage}" alt="Student solution for question ${index + 1}" class="student-solution-img"></div><div><span class="question-label">${T.modalLabelFeedback}</span><div class="feedback-text"><p>${q.feedback || 'No feedback provided.'}</p><p class="mt-2 text-xs"><strong>Question:</strong> ${q.question || 'N/A'}</p><p class="mt-2 text-xs"><strong>Correct Answer:</strong> ${q.correctAnswer || 'N/A'}</p></div></div></div>`;
                    modalResultsContainer.appendChild(questionEl);
                });
            }
        } catch (err) { console.error("Error loading result details:", err); modalResultsContainer.innerHTML = '<p class="text-red-500">Error loading details.</p>'; }
        resultModalOverlay.classList.remove('hidden'); setTimeout(() => resultModalOverlay.classList.add('show'), 10);
    }

    /** Hides result detail modal */
    function hideResultDetail() { resultModalOverlay.classList.remove('show'); setTimeout(() => { resultModalOverlay.classList.add('hidden'); }, 300); }

    /** Loads data for the selected group */
    async function loadGroupData(group) {
        const T = strings[currentLang]; // Get current language strings
        resultsTitle.textContent = formatString(T.resultsTitleLoading, { groupName: group.groupName });
        resultsEmptyState.classList.add('hidden'); resultsContent.classList.remove('hidden'); switchTab('results'); 
        resultsTable.classList.add('hidden'); resultsNoneMsg.classList.add('hidden'); resultsTableBody.innerHTML = ''; rosterList.innerHTML = ''; rosterNoneMsg.classList.add('hidden');
        try {
            const studentsQuery = query(collection(db, "thelo-students"), where("groupId", "==", group.id));
            const studentSnapshot = await getDocs(studentsQuery);
            rosterList.innerHTML = ''; 
            if (studentSnapshot.empty) { rosterList.appendChild(rosterNoneMsg); rosterNoneMsg.classList.remove('hidden'); } else {
                studentSnapshot.forEach(doc => { const el = document.createElement('span'); el.className = 'block text-sm text-slate-700'; el.textContent = doc.data().email; rosterList.appendChild(el); });
            }
            const resultsQuery = query(collection(db, "thelo-test-results"), where("groupId", "==", group.id));
            const resultsSnapshot = await getDocs(resultsQuery);
            resultsTableBody.innerHTML = ''; 
            if (resultsSnapshot.empty) { resultsNoneMsg.classList.remove('hidden'); resultsTable.classList.add('hidden'); } else {
                resultsNoneMsg.classList.add('hidden'); const results = [];
                resultsSnapshot.forEach(doc => results.push({ id: doc.id, ...doc.data() }));
                results.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));
                results.forEach(result => renderResultRow(result)); // Pass result to render function
                resultsTable.classList.remove('hidden');
            }
            resultsTitle.textContent = formatString(T.resultsTitleLoaded, { groupName: group.groupName });
        } catch (err) { console.error("Error loading group data:", err); resultsTitle.textContent = "Error loading data"; resultsNoneMsg.textContent = "Error loading results."; resultsNoneMsg.classList.remove('hidden'); }
    }

    /** Renders a single result row */
    function renderResultRow(result) {
        const T = strings[currentLang]; // **Ensure T uses currentLang**
        const row = document.createElement('tr'); row.className = 'hover:bg-slate-50';
        const scoreText = `${result.score} / ${result.totalQuestions}`;
        const timeText = formatString(T.tableTimeValue, { time: result.timeTakenSeconds });
        const dateText = result.submittedAt ? result.submittedAt.toDate().toLocaleString(currentLang.startsWith('hy') ? 'hy-AM' : 'en-US') : 'N/A';
        // **Use T.tableView directly here**
        row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${result.email}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${result.testId}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${scoreText}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${timeText}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${dateText}</td> <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"> <button class="thelo-btn-secondary-sm view-details-btn">${T.tableView}</button> </td>`;
        row.querySelector('.view-details-btn').addEventListener('click', async (e) => { e.preventDefault(); await showResultDetail(result); });
        resultsTableBody.appendChild(row);
    }

    // Initial language setup
    applyContent(currentLang);

</script>

</body>
</html>
