<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Group: SAT Warriors - thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --thelo-blue: #2563EB;
            --thelo-blue-light: #EFF6FF;
            --thelo-green: #10B981;
            --thelo-amber: #F59E0B;
            --thelo-bg: #F8F9FA;
            --thelo-text: #111827;
            --thelo-text-light: #6B7280;
            --grid-color: #E5E7EB;
        }
        /* Using the exact body styling from your dashboard */
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--thelo-bg);
            color: var(--thelo-text);
            background-image:
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        /* Using the exact blurred header styling */
        .main-header {
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--grid-color);
            padding: 1rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        main { padding: 2rem 2.5rem; max-width: 1400px; margin: auto; }

        /* A base card style derived from your topic-card */
        .module-card {
            background-color: #fff;
            border: 1px solid var(--grid-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 1.5rem;
        }
        
        /* Interactive button styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .tab-btn.active {
            background-color: var(--thelo-blue);
            color: #fff;
        }
        .tab-btn:not(.active) {
            background-color: var(--thelo-blue-light);
            color: var(--thelo-blue);
        }
        .tab-btn:not(.active):hover {
             background-color: #DBEAFE; /* Slightly darker blue-light */
        }
        
        .avatar-stack > * {
            border: 3px solid #fff;
            border-radius: 9999px;
            margin-left: -1rem;
        }
        .avatar-stack > *:first-child { margin-left: 0; }
        
        .progress-bar-bg {
            background-color: var(--grid-color);
            border-radius: 9999px;
            height: 12px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: var(--thelo-green);
            border-radius: 9999px;
            height: 100%;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="antialiased">

    <header id="main-header" class="main-header">
        </header>

    <main>
        <section id="group-header" class="text-center mb-10">
            </section>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 flex flex-col gap-8">
                <section id="group-quest" class="module-card">
                    </section>

                <section id="stuck-zone" class="module-card">
                    </section>
            </div>

            <div class="lg:col-span-2 flex flex-col gap-8">
                <section id="leaderboard" class="module-card">
                     </section>
                
                <section id="activity-feed" class="module-card">
                     </section>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
            authDomain: "physmathacademy-722b3.firebaseapp.com",
            projectId: "physmathacademy-722b3",
            storageBucket: "physmathacademy-722b3.appspot.com",
            appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- MOCK DATA (In a real app, this would come from the user's profile) ---
        const MOCK_GROUP_ID = 'sat-warriors-2025';

        /**
         * Main entry point, fires when user authentication is confirmed.
         * @param {object} user - The authenticated Firebase user object.
         */
        async function initializeGroupPage(user) {
            if (!user) {
                console.log("No user found, redirecting to login.");
                window.location.href = 'https://thelo.space/auth';
                return;
            }
            
            // Show loading state
            document.getElementById('group-header').innerHTML = `<p class="text-gray-500">Loading group data...</p>`;

            try {
                // Fetch all data in parallel for performance
                const [groupDoc, membersData, activityItems, stuckTopics] = await Promise.all([
                    getDoc(doc(db, 'study_groups', MOCK_GROUP_ID)),
                    fetchGroupMembers(MOCK_GROUP_ID),
                    fetchGroupActivity(MOCK_GROUP_ID),
                    fetchStuckTopics(MOCK_GROUP_ID)
                ]);

                if (!groupDoc.exists()) {
                     document.getElementById('group-header').innerHTML = `<p class="text-red-500">Error: Study group not found.</p>`;
                     return;
                }
                
                const groupData = groupDoc.data();
                const currentUserData = membersData.find(m => m.id === user.uid);

                // Render all modules with the fetched data
                renderHeader(currentUserData);
                renderGroupHeader(groupData, membersData);
                renderGroupQuest(groupData.weeklyQuest);
                renderLeaderboard(membersData, user.uid);
                renderActivityFeed(activityItems);
                renderStuckZone(stuckTopics);

            } catch (error) {
                console.error("Failed to initialize group page:", error);
                document.getElementById('group-header').innerHTML = `<p class="text-red-500">Could not load group page. Please try again later.</p>`;
            }
        }

        /**
         * Fetches all member documents for a given group.
         * @param {string} groupId The ID of the study group.
         * @returns {Promise<Array<object>>} A list of member data objects.
         */
        async function fetchGroupMembers(groupId) {
            const groupRef = doc(db, 'study_groups', groupId);
            const groupSnap = await getDoc(groupRef);
            if (!groupSnap.exists() || !groupSnap.data().members) return [];

            const memberIds = groupSnap.data().members;
            const memberPromises = memberIds.map(id => getDoc(doc(db, 'thelo-students', id)));
            const memberDocs = await Promise.all(memberPromises);
            
            return memberDocs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        
        /**
         * Fetches recent activity items for the group.
         * @param {string} groupId The ID of the study group.
         * @returns {Promise<Array<object>>} A list of activity items.
         */
        async function fetchGroupActivity(groupId) {
             const activityQuery = query(collection(db, `study_groups/${groupId}/activity`), orderBy('timestamp', 'desc'), limit(10));
             const snapshot = await getDocs(activityQuery);
             return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        /**
         * Fetches topics members are stuck on.
         * @param {string} groupId The ID of the study group.
         * @returns {Promise<Array<object>>} A list of stuck topic items.
         */
        async function fetchStuckTopics(groupId) {
            const stuckQuery = query(collection(db, `study_groups/${groupId}/stuck_topics`), orderBy('timestamp', 'desc'), limit(5));
            const snapshot = await getDocs(stuckQuery);
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // --- RENDER FUNCTIONS --- //
        
        function renderHeader(user) {
            const headerEl = document.getElementById('main-header');
            if (!user) {
                headerEl.innerHTML = `<div class="font-bold">thelo</div>`;
                return;
            }
            headerEl.innerHTML = `
                <div class="flex items-center gap-4">
                    <a href="/dashboard"><img src="https://thelo.space/img/thelo-Photoroom.png" alt="Thelo logo" class="h-8 w-auto" /></a>
                </div>
                <div class="hidden md:flex items-center gap-8">
                     <a href="/dashboard" class="font-bold text-gray-600 hover:text-blue-600 transition-colors"><i class="fas fa-home mr-2"></i>My Dashboard</a>
                     <span class="font-bold text-blue-600"><i class="fas fa-users mr-2"></i>Study Group</span>
                </div>
                <a href="/settings" aria-label="Go to settings">
                    <img src="${user.profilePicture || `https://via.placeholder.com/150/E5E7EB/FFFFFF?text=${user.name.charAt(0)}`}" alt="Profile" class="h-10 w-10 rounded-full cursor-pointer border-2 border-transparent hover:border-blue-500 object-cover">
                </a>`;
        }
        
        function renderGroupHeader(group, members) {
            const container = document.getElementById('group-header');
            const avatarsHTML = members.slice(0, 5).map(member => 
                `<img src="${member.profilePicture || `https://via.placeholder.com/150/E5E7EB/FFFFFF?text=${member.name.charAt(0)}`}" class="h-12 w-12 object-cover" alt="${member.name}">`
            ).join('');
            const moreCount = members.length > 5 ? `<span class="flex items-center justify-center h-12 w-12 bg-gray-200 text-gray-600 font-bold text-sm">+${members.length - 5}</span>` : '';

            container.innerHTML = `
                <div class="inline-block p-4 bg-blue-100 text-blue-600 rounded-full mb-4">
                    <i class="fas fa-users text-3xl"></i>
                </div>
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">${group.groupName}</h1>
                <div class="mt-4 flex justify-center items-center avatar-stack">
                    ${avatarsHTML}${moreCount}
                </div>
            `;
        }

        function renderGroupQuest(quest) {
            const container = document.getElementById('group-quest');
            const progress = Math.min(100, (quest.currentCompletions / quest.goalCompletions) * 100);
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-2 flex items-center gap-2"><i class="fas fa-crosshairs text-green-600"></i> Weekly Group Quest</h2>
                <p class="text-gray-600 mb-4">Complete <strong class="text-blue-600">${quest.topicName}</strong> together!</p>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                </div>
                <div class="flex justify-between items-center mt-2 text-sm font-bold">
                    <span class="text-green-600">${Math.round(progress)}% Complete</span>
                    <span class="text-gray-500">${quest.currentCompletions} / ${quest.goalCompletions} Members</span>
                </div>
            `;
        }

        function renderStuckZone(topics) {
             const container = document.getElementById('stuck-zone');
             let contentHTML = `<h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-life-ring text-red-500"></i> The Stuck Zone</h2>`;
             
             if (topics.length === 0) {
                 contentHTML += `<p class="text-sm text-gray-500">Nobody is stuck. Great job, team!</p>`;
             } else {
                 contentHTML += `<p class="text-sm text-gray-500 mb-4">Members looking for help on these topics.</p>
                 <div class="space-y-3">
                    ${topics.map(topic => `
                        <div class="bg-red-50 border border-red-200 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-bold text-sm">${topic.topicName}</p>
                                <p class="text-xs text-gray-500">Flagged by ${topic.userName}</p>
                            </div>
                            <button class="text-xs bg-white border border-gray-300 rounded-full px-3 py-1 font-bold hover:bg-gray-50">Offer Help</button>
                        </div>
                    `).join('')}
                 </div>`;
             }
             container.innerHTML = contentHTML;
        }

        function renderLeaderboard(members, currentUserId) {
            const container = document.getElementById('leaderboard');
            // Initial render state
            let currentSort = 'points';
            
            const sortAndRender = () => {
                let sortedMembers;
                switch(currentSort) {
                    case 'streak':
                        sortedMembers = [...members].sort((a, b) => (b.streakData?.currentStreak || 0) - (a.streakData?.currentStreak || 0));
                        break;
                    case 'lessons':
                        sortedMembers = [...members].sort((a, b) => (b.lessonsCompleted || 0) - (a.lessonsCompleted || 0));
                        break;
                    case 'points':
                    default:
                        sortedMembers = [...members].sort((a, b) => (b.points || 0) - (a.points || 0));
                        break;
                }
                
                const listHTML = sortedMembers.map((member, index) => {
                    const isUser = member.id === currentUserId;
                    let value;
                    switch(currentSort) {
                        case 'streak': value = `<i class="fas fa-fire text-red-500"></i> ${member.streakData?.currentStreak || 0}`; break;
                        case 'lessons': value = `<i class="fas fa-check-circle text-green-500"></i> ${member.lessonsCompleted || 0}`; break;
                        default: value = `<i class="fas fa-star text-amber-500"></i> ${member.points || 0}`; break;
                    }

                    return `
                        <div class="flex items-center p-2 rounded-md ${isUser ? 'bg-blue-50' : ''}">
                            <span class="font-bold text-lg text-gray-400 w-8">${index + 1}</span>
                            <img src="${member.profilePicture || `https://via.placeholder.com/150/E5E7EB/FFFFFF?text=${member.name.charAt(0)}`}" class="h-10 w-10 rounded-full mr-3 object-cover" alt="">
                            <span class="flex-grow font-bold">${isUser ? 'You' : member.name}</span>
                            <span class="font-bold text-blue-600 text-sm">${value}</span>
                        </div>
                    `;
                }).join('');
                
                container.querySelector('#leaderboard-list').innerHTML = listHTML;
                container.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.sort === currentSort);
                });
            };
            
            // Initial HTML structure
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold"><i class="fas fa-trophy text-amber-500 mr-2"></i>Leaderboard</h2>
                    <div id="leaderboard-tabs" class="flex items-center gap-1 bg-blue-50 p-1 rounded-lg">
                        <button data-sort="points" class="tab-btn text-xs active">Points</button>
                        <button data-sort="lessons" class="tab-btn text-xs">Lessons</button>
                        <button data-sort="streak" class="tab-btn text-xs">Streak</button>
                    </div>
                </div>
                <div id="leaderboard-list" class="space-y-1"></div>
            `;
            
            // Add event listeners and initial render
            container.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentSort = btn.dataset.sort;
                    sortAndRender();
                });
            });
            sortAndRender();
        }

        function renderActivityFeed(activities) {
            const container = document.getElementById('activity-feed');
            const feedHTML = activities.map(activity => {
                // In a real app, reactions would be interactive.
                const reactionsHTML = (activity.reactions || []).map(r => `<div class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">${r.emoji} ${r.count}</div>`).join('');
                return `
                    <div class="py-4 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-start gap-3">
                            <img src="${activity.userAvatar || `https://via.placeholder.com/150/E5E7EB/FFFFFF?text=${activity.userName.charAt(0)}`}" class="h-10 w-10 rounded-full object-cover" alt="">
                            <div class="flex-grow">
                                <p class="text-sm text-gray-800">${activity.actionText.replace(activity.userName, `<strong class="font-bold">${activity.userName}</strong>`)}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(activity.timestamp.toDate())}</p>
                            </div>
                        </div>
                        <div class="pl-12 pt-2 flex items-center gap-2">
                           ${reactionsHTML}
                           <button class="text-gray-400 hover:text-blue-500 text-lg w-8 h-8 rounded-full hover:bg-gray-100">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-2"><i class="fas fa-bolt text-blue-500 mr-2"></i>Live Activity</h2>
                <div>${feedHTML || '<p class="text-sm text-gray-500">No group activity yet. Be the first!</p>'}</div>
            `;
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        }


        // --- Authentication Listener ---
        onAuthStateChanged(auth, (user) => {
           initializeGroupPage(user);
        });

    </script>
</body>
</html>
