<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png" />
  <title>thelo | Test Mode</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>

  <!-- Fonts + KaTeX -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" />

  <!-- PWA bits -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --thelo-blue:#2563eb;--thelo-blue-dark:#1d4ed8;--thelo-bg:#fff;--thelo-text:#111827;--thelo-text-light:#6b7280;--thelo-border:#e5e7eb;--success:#22c55e;--error:#ef4444;--warn:#f59e0b;
      --chip:#f3f4f6;--shadow-md:0 4px 6px -1px rgb(0 0 0/0.1),0 2px 4px -2px rgb(0 0 0/0.1);
      --fade:0.3s
    }
    @font-face{
      font-family:'Montserrat Arm';src:url('https://thelo.space/fonts/Montserratarm-Regular.otf') format('opentype');font-weight:400;font-style:normal;font-display:swap
    }
    @font-face{
      font-family:'Montserrat Arm';src:url('https://thelo.space/fonts/Montserratarm-SemiBold.otf') format('opentype');font-weight:600;font-style:normal;font-display:swap
    }
    @font-face{
      font-family:'Montserrat Arm';src:url('https://thelo.space/fonts/Montserratarm-ExtraBold.otf') format('opentype');font-weight:800;font-style:normal;font-display:swap
    }
    body.lang-hy{font-family:'Montserrat Arm','Manrope',system-ui,-apple-system,sans-serif}
    html,body{height:100%}
    body{margin:0;background:var(--thelo-bg);color:var(--thelo-text);font-family:'Manrope',system-ui,-apple-system,sans-serif;overflow:hidden;-webkit-user-select:none;user-select:none}
    #loading-overlay{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;opacity:1;transition:opacity .5s ease-out}
    #loading-overlay.hidden{opacity:0;pointer-events:none}
    #loading-svg{width:150px;animation:pulse 1.5s infinite ease-in-out}
    @keyframes pulse{0%{transform:scale(1);opacity:.8}50%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:.8}}

    /* App layout */
    #app{display:flex;flex-direction:column;height:100vh}
    #topBar{display:flex;align-items:center;justify-content:space-between;padding:.5rem 1rem;border-bottom:1px solid var(--thelo-border);gap:.5rem}
    .left-actions,.right-actions{display:flex;align-items:center;gap:.5rem}
    .chip{background:var(--chip);border:1px solid var(--thelo-border);padding:.35rem .6rem;border-radius:.5rem;font-size:.85rem}
    .btn{border:none;border-radius:.5rem;padding:.5rem .8rem;background:var(--thelo-blue);color:#fff;box-shadow:var(--shadow-md);font-weight:600;cursor:pointer;transition:.15s}
    .btn.secondary{background:#111827;color:#fff}
    .btn.ghost{background:#fff;color:#111827;border:1px solid var(--thelo-border)}
    .btn.warn{background:var(--warn);color:#111}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .icon-btn{border:1px solid var(--thelo-border);background:#fff;border-radius:.5rem;padding:.45rem .55rem;cursor:pointer}
    .icon-dot{display:inline-block;width:10px;height:10px;border-radius:50%}
    .dot-empty{background:#d1d5db}
    .dot-answered{background:#6ee7b7}
    .dot-unsure{background:var(--warn)}

    #lessonArea{position:relative;flex:1;display:flex;overflow:hidden}
    #boardWrap{position:relative;flex:1;background:#fff;background-image:linear-gradient(to right,var(--thelo-border) 1px,transparent 1px),linear-gradient(to bottom,var(--thelo-border) 1px,transparent 1px);background-size:40px 40px}
    #backgroundCanvas,#board{position:absolute;inset:0;width:100%;height:100%;display:block;background:transparent}
    #backgroundCanvas{z-index:1;pointer-events:none;transition:opacity var(--fade)}
    #backgroundCanvas.fade-out{opacity:0}
    #board{z-index:3;touch-action:none;cursor:crosshair}

    #bottomBar{position:absolute;left:0;right:0;bottom:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.6rem 1rem;background:linear-gradient(180deg,rgba(255,255,255,.0),rgba(255,255,255,.85) 40%,#fff 100%)}
    #button-group{display:flex;gap:.35rem;flex-wrap:wrap}
    .control-btn{padding:.55rem .8rem;border-radius:.5rem;border:1px solid var(--thelo-border);background:#fff;cursor:pointer}
    .control-btn.primary{background:var(--thelo-blue);color:#fff;border:none}
    .control-btn.danger{background:var(--error);color:#fff;border:none}
    .control-btn.warn{background:var(--warn);color:#111;border:none}
    #timerDisplay{font-weight:700}

    /* Notes panel */
    #notesPanel{position:absolute;top:0;right:0;height:100%;width:min(38vw,460px);max-width:95%;transform:translateX(102%);transition:transform var(--fade);background:#fff;border-left:1px solid var(--thelo-border);z-index:8;display:flex;flex-direction:column}
    #notesPanel.open{transform:translateX(0)}
    #notesHeader{display:flex;align-items:center;justify-content:space-between;padding:.7rem .9rem;border-bottom:1px solid var(--thelo-border)}
    #notesArea{flex:1;width:100%;border:none;outline:none;padding:.9rem;font-size:1rem;resize:none}

    /* Nav panel */
    #navPanel{position:absolute;top:0;left:0;height:100%;width:min(45vw,520px);transform:translateX(-102%);transition:transform var(--fade);background:#fff;border-right:1px solid var(--thelo-border);z-index:8;display:flex;flex-direction:column}
    #navPanel.open{transform:translateX(0)}
    #navHeader{display:flex;align-items:center;justify-content:space-between;padding:.7rem .9rem;border-bottom:1px solid var(--thelo-border)}
    #navGrid{padding:1rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(56px,1fr));gap:.6rem;overflow:auto}
    .navItem{border:1px solid var(--thelo-border);border-radius:.6rem;padding:.5rem .4rem;display:flex;flex-direction:column;align-items:center;gap:.35rem;cursor:pointer;background:#fff;transition:.1s}
    .navItem.active{border-color:var(--thelo-blue)}
    .navItem .num{font-weight:700}
    .legend{display:flex;gap:.6rem;align-items:center}
    .legend .item{display:flex;align-items:center;gap:.35rem}

    /* Review overlay */
    #reviewOverlay{position:absolute;inset:0;background:#fff;z-index:20;display:none;flex-direction:column}
    #reviewHeader{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid var(--thelo-border)}
    #overview{display:none;flex:1;overflow:auto;padding:1rem}
    #detail{display:none;flex:1;overflow:auto;padding:1rem;max-width:1200px;margin:0 auto}
    .summaryStats{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .summaryCard{border:1px solid var(--thelo-border);border-radius:.6rem;padding:.8rem 1rem;background:#fff}
    .gridOverview{display:grid;grid-template-columns:repeat(auto-fill,minmax(64px,1fr));gap:.6rem}
    .gridOverview .cell{border:1px solid var(--thelo-border);border-radius:.5rem;padding:.6rem .4rem;text-align:center;background:#fff}
    .badge{display:inline-flex;align-items:center;gap:.3rem;border-radius:999px;padding:.15rem .5rem;border:1px solid var(--thelo-border);background:#fff;font-size:.85rem}
    .answerRow{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .canvasThumb{border:1px dashed var(--thelo-border);border-radius:.5rem;max-width:100%;background:#fafafa}
    .kicker{font-size:.85rem;color:var(--thelo-text-light);margin-bottom:.25rem}
    .section{border:1px solid var(--thelo-border);border-radius:.6rem;padding:1rem;background:#fff}
    .detailNav{display:flex;justify-content:space-between;gap:.5rem;margin-top:1rem}

    @media (max-width: 900px){
      .answerRow{grid-template-columns:1fr}
      #notesPanel{width:100%}
      #navPanel{width:92%}
    }
  </style>
</head>
<body>
  <!-- Loading -->
  <div id="loading-overlay"><img id="loading-svg" src="https://thelo.space/img/bluethelo.svg" alt="Loading..." /></div>

  <!-- App -->
  <div id="app">
    <div id="topBar">
      <div class="left-actions">
        <button id="openNavBtn" class="icon-btn" title="Open problem list">☰</button>
        <span class="chip" id="testTitleChip">Test</span>
      </div>
      <div class="right-actions">
        <span class="chip" id="timerDisplay">00:00</span>
        <button id="toggleNotesBtn" class="btn ghost" title="A">Notes</button>
        <button id="finishBtn" class="btn warn">Finish Test</button>
      </div>
    </div>

    <div id="lessonArea">
      <!-- Left navigation panel -->
      <div id="navPanel">
        <div id="navHeader">
          <strong>Review</strong>
          <div class="legend">
            <div class="item"><span class="icon-dot dot-empty"></span><span>Empty</span></div>
            <div class="item"><span class="icon-dot dot-answered"></span><span>Answered</span></div>
            <div class="item"><span class="icon-dot dot-unsure"></span><span>Unsure</span></div>
          </div>
          <button id="closeNavBtn" class="icon-btn">✕</button>
        </div>
        <div id="navGrid"></div>
      </div>

      <!-- Notes panel -->
      <div id="notesPanel">
        <div id="notesHeader">
          <strong>Notes (Problem <span id="notesProblemNum">1</span>)</strong>
          <button id="closeNotesBtn" class="icon-btn">✕</button>
        </div>
        <textarea id="notesArea" placeholder="Write your notes here. (Not sent to AI)"></textarea>
      </div>

      <!-- Board -->
      <div id="boardWrap">
        <canvas id="backgroundCanvas"></canvas>
        <canvas id="board"></canvas>

        <!-- Bottom controls -->
        <div id="bottomBar">
          <div id="leftControls" class="legend">
            <button id="prevBtn" class="control-btn">← Prev</button>
            <button id="nextBtn" class="control-btn">Next →</button>
            <button id="undoBtn" class="control-btn">Undo</button>
            <button id="redoBtn" class="control-btn">Redo</button>
            <button id="clearBtn" class="control-btn danger">Clear</button>
          </div>
          <div id="button-group">
            <button id="unsureBtn" class="control-btn warn" title="U">I’m Unsure</button>
            <button id="submitBtn" class="control-btn primary">Save & Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Review overlay -->
    <div id="reviewOverlay">
      <div id="reviewHeader">
        <div class="left-actions">
          <button id="backToLessonBtn" class="btn ghost">← Back</button>
        </div>
        <div class="right-actions">
          <button id="toOverviewBtn" class="btn ghost">Overview</button>
          <button id="toDetailBtn" class="btn">Detail</button>
        </div>
      </div>

      <!-- Overview -->
      <div id="overview">
        <div class="summaryStats">
          <div class="summaryCard"><div class="kicker">Score</div><div id="sumScore" style="font-weight:800;font-size:1.6rem">–</div></div>
          <div class="summaryCard"><div class="kicker">Time Taken</div><div id="sumTime" style="font-weight:800;font-size:1.2rem">–</div></div>
          <div class="summaryCard"><div class="kicker">Answered</div><div id="sumAnswered" style="font-weight:800">–</div></div>
          <div class="summaryCard"><div class="kicker">Unsure</div><div id="sumUnsure" style="font-weight:800">–</div></div>
        </div>
        <div class="section">
          <div class="kicker" style="margin-bottom:.6rem">Problems</div>
          <div id="overviewGrid" class="gridOverview"></div>
        </div>
      </div>

      <!-- Detail -->
      <div id="detail">
        <div class="section" id="detailProblem">
          <div class="kicker">Problem</div>
          <div id="detailHeadline" style="font-weight:700;margin-bottom:.6rem"></div>
          <div class="answerRow">
            <div>
              <div class="kicker">Your Drawing</div>
              <img id="detailImg" class="canvasThumb" alt="Your drawing"/>
            </div>
            <div>
              <div class="kicker">Correct Answer</div>
              <div id="detailCorrect" class="badge">–</div>
              <div style="margin-top:.8rem">
                <div class="kicker">AI Feedback</div>
                <div id="detailFeedback">–</div>
              </div>
              <div style="margin-top:.8rem">
                <div class="kicker">Your Notes</div>
                <div id="detailNotes" style="white-space:pre-wrap;border:1px solid var(--thelo-border);border-radius:.5rem;padding:.6rem;background:#fafafa">–</div>
              </div>
            </div>
          </div>
          <div class="detailNav">
            <button id="detailPrev" class="btn ghost">← Prev</button>
            <button id="detailNext" class="btn">Next →</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Logo -->
  <div id="bottom-logo-container" style="position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);z-index:9;pointer-events:none">
    <img src="https://thelo.space/img/bluethelo.svg" alt="Thelo Logo" style="height:32px;opacity:.85"/>
  </div>

  <script>
    /* ---------------- Firebase Init ---------------- */
    const firebaseConfig = { apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8", authDomain: "physmathacademy-722b3.firebaseapp.com", projectId: "physmathacademy-722b3", messagingSenderId: "1093640992262", appId: "1:1093640992262:web:35b1bf4d2364bcf745f587" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const fns = firebase.functions();

    /* ---------------- Elements ---------------- */
    const loadingOverlay = document.getElementById('loading-overlay');
    const bgCanvas = document.getElementById('backgroundCanvas');
    const drawCanvas = document.getElementById('board');
    const bgCtx = bgCanvas.getContext('2d');
    const ctx = drawCanvas.getContext('2d');

    const openNavBtn = document.getElementById('openNavBtn');
    const closeNavBtn = document.getElementById('closeNavBtn');
    const navPanel = document.getElementById('navPanel');
    const navGrid = document.getElementById('navGrid');

    const toggleNotesBtn = document.getElementById('toggleNotesBtn');
    const closeNotesBtn = document.getElementById('closeNotesBtn');
    const notesPanel = document.getElementById('notesPanel');
    const notesArea = document.getElementById('notesArea');
    const notesProblemNum = document.getElementById('notesProblemNum');

    const testTitleChip = document.getElementById('testTitleChip');
    const timerDisplay = document.getElementById('timerDisplay');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const clearBtn = document.getElementById('clearBtn');
    const unsureBtn = document.getElementById('unsureBtn');
    const submitBtn = document.getElementById('submitBtn');
    const finishBtn = document.getElementById('finishBtn');

    const reviewOverlay = document.getElementById('reviewOverlay');
    const backToLessonBtn = document.getElementById('backToLessonBtn');
    const toOverviewBtn = document.getElementById('toOverviewBtn');
    const toDetailBtn = document.getElementById('toDetailBtn');
    const overview = document.getElementById('overview');
    const detail = document.getElementById('detail');

    const sumScore = document.getElementById('sumScore');
    const sumTime = document.getElementById('sumTime');
    const sumAnswered = document.getElementById('sumAnswered');
    const sumUnsure = document.getElementById('sumUnsure');
    const overviewGrid = document.getElementById('overviewGrid');

    const detailHeadline = document.getElementById('detailHeadline');
    const detailImg = document.getElementById('detailImg');
    const detailCorrect = document.getElementById('detailCorrect');
    const detailFeedback = document.getElementById('detailFeedback');
    const detailNotes = document.getElementById('detailNotes');
    const detailPrev = document.getElementById('detailPrev');
    const detailNext = document.getElementById('detailNext');

    /* ---------------- State ---------------- */
    let devicePixelRatioVal = window.devicePixelRatio || 1;
    let testData = null, currentStageIndex = -1, currentStageData = null;
    let drawing = false, lastPos = {x:0,y:0}, isTransitioning = false;
    let currentLang = 'en';
    let testStartTime = null, timerInterval = null;

    // Per-problem persistent state
    let answers = []; // [{strokes:[[{x,y}],...], redo:[], unsure:false, notes:"", hasAnswer:false}]
    let reviewedResults = []; // after analysis: [{status, feedback, correctAnswer, question, img}]
    let reviewIndex = 0;

    // Storage key per test
    let LS_KEY = null;

    /* ---------------- Utilities ---------------- */
    function pad(n){return n.toString().padStart(2,'0')}
    function elapsedStr(ms){
      const s = Math.floor(ms/1000); const m = Math.floor(s/60); const r = s%60;
      return `${pad(m)}:${pad(r)}`
    }

    function getUrlParam(name){
      return new URLSearchParams(window.location.search).get(name);
    }

    function saveLocal(){
      if(!LS_KEY) return;
      const toSave = {
        currentStageIndex, currentLang, testStartTime, answers,
        started: !!testStartTime
      };
      localStorage.setItem(LS_KEY, JSON.stringify(toSave));
    }
    function loadLocal(){
      if(!LS_KEY) return null;
      try{ return JSON.parse(localStorage.getItem(LS_KEY)||'null'); }catch{return null}
    }
    function clearLocal(){ if(LS_KEY) localStorage.removeItem(LS_KEY); }

    function statusOf(index){
      const a = answers[index];
      if(!a) return 'empty';
      if(a.unsure) return 'unsure';
      if(a.hasAnswer) return 'answered';
      return 'empty';
    }

    function buildNav(){
      navGrid.innerHTML = '';
      testData.stages.forEach((_,i)=>{
        const div = document.createElement('div');
        div.className = 'navItem' + (i===currentStageIndex ? ' active':'');
        const dot = document.createElement('span'); dot.className = 'icon-dot ' +
          (statusOf(i)==='unsure' ? 'dot-unsure' : statusOf(i)==='answered' ? 'dot-answered' : 'dot-empty');
        const num = document.createElement('div'); num.className='num'; num.textContent = i+1;
        div.appendChild(num); div.appendChild(dot);
        div.onclick = ()=>jumpTo(i);
        navGrid.appendChild(div);
      });
    }

    /* ---------------- KaTeX text rendering (unchanged-ish) ---------------- */
    let katexCSSInlined = null;
    function abToBase64(ab){
      const CHUNK=0x8000, bytes=new Uint8Array(ab); let binary='';
      for(let i=0;i<bytes.length;i+=CHUNK){binary+=String.fromCharCode(...bytes.subarray(i,i+CHUNK))}
      return btoa(binary)
    }
    async function getKatexCSSWithEmbeddedFonts(){
      if(katexCSSInlined) return katexCSSInlined;
      const base='https://cdn.jsdelivr.net/npm/katex@0.16.10/dist';
      let css = await (await fetch(`${base}/katex.min.css`)).text();
      const fonts=['KaTeX_Main-Regular.woff2','KaTeX_Main-Italic.woff2','KaTeX_Main-Bold.woff2','KaTeX_Math-Italic.woff2','KaTeX_AMS-Regular.woff2','KaTeX_Size1-Regular.woff2','KaTeX_Size2-Regular.woff2'];
      for(const name of fonts){
        const res = await fetch(`${base}/fonts/${name}`);
        const b64 = abToBase64(await res.arrayBuffer());
        css = css.replace(new RegExp(`url\\([^)]*${name}[^)]*\\)\\s*format\\("woff2"\\)`,'g'), `url(data:font/woff2;base64,${b64}) format("woff2")`);
      }
      katexCSSInlined = css; return css;
    }
    async function ensureHeadlineFontsLoaded(){
      try{
        if(document.fonts&&document.fonts.load){
          await Promise.race([
            (async()=>{
              await document.fonts.load(`24px "Manrope"`);
              if(currentLang==='hy') await document.fonts.load(`24px "Montserrat Arm"`);
              await document.fonts.ready;
            })(),
            new Promise(res=>setTimeout(res,800))
          ])
        }
      }catch(_){}
    }
    async function renderComplexHeadline(ctx,headline,y){
      if(!headline||!ctx) return;
      const widthFraction=.9, yNudge=-10, fontSize=22, mathFontSize=24;
      const fontColor='#111827';
      const katexCSS = await getKatexCSSWithEmbeddedFonts();
      const extraRules = `.katex,.katex .mathnormal{font-family:"KaTeX_Main",serif!important}`;
      const segs = (headline.split(/(\/K[\s\S]*?K\/)/g)||[]).filter(Boolean).map(p=>p.startsWith('/K')&&p.endsWith('K/')?{type:'math',content:p.replace(/^\/K\s*/,'').replace(/\s*K\/$/,'')}:{type:'text',content:p});
      const host = document.createElement('div'); host.style.cssText='position:absolute;visibility:hidden;left:-9999px;top:-9999px'; document.body.appendChild(host);
      const tokens=[];
      for(const seg of segs){
        if(seg.type==='text'){
          const parts = seg.content.match(/(\s+|[^\s]+)/g)||[];
          for(const p of parts){ tokens.push({type:'text',content:p,width:bgCtx.measureText(p).width,height:fontSize,isSpace:/^\s+$/.test(p)}) }
          continue;
        }
        try{
          const html = katex.renderToString(seg.content,{throwOnError:false,output:'html'});
          const style=document.createElement('style'); style.textContent=katexCSS; host.appendChild(style);
          const tmp=document.createElement('div'); tmp.style.color=fontColor; tmp.style.fontSize=`${mathFontSize}px`; tmp.innerHTML=html; host.appendChild(tmp);
          const rect=(tmp.querySelector('.katex')||tmp).getBoundingClientRect(); tmp.remove();
          const PAD=2, w=Math.ceil(rect.width)+PAD, h=Math.ceil(rect.height)+PAD;
          const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><style>${katexCSS}\n${extraRules}</style><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="color:${fontColor};font-size:${mathFontSize}px;display:inline-block;padding-right:${PAD/2}px;">${html}</div></foreignObject></svg>`;
          const dataUrl='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svg)));
          const image=new Image(); image.src=dataUrl; await image.decode();
          tokens.push({type:'math',image,width:w,height:h,drawW:w,drawH:h});
        }catch{ tokens.push({type:'text',content:seg.content,width:bgCtx.measureText(seg.content).width,height:fontSize,isSpace:false}) }
      }
      host.remove();
      const canvasW=bgCtx.canvas.width/devicePixelRatioVal; const maxW=canvasW*widthFraction;
      const lines=[]; let line={tokens:[],width:0,height:fontSize};
      for(const t of tokens){
        let width=t.width,height=t.height,drawW=t.drawW??t.width,drawH=t.drawH??t.height;
        if(t.type==='math' && width>maxW){ const s=maxW/width; width=Math.floor(width*s); height=Math.floor(height*s); drawW*=s; drawH*=s; }
        const tok={...t,width,height,drawW,drawH};
        if(line.tokens.length && line.width+width>maxW){ lines.push(line); line={tokens:[],width:0,height:fontSize}; }
        if(!(line.tokens.length===0 && tok.isSpace)){ line.tokens.push(tok); line.width+=width; if(height>line.height) line.height=height; }
      }
      if(line.tokens.length) lines.push(line);
      const prevAlign=bgCtx.textAlign, prevBase=bgCtx.textBaseline, prevFill=bgCtx.fillStyle;
      bgCtx.fillStyle=fontColor; bgCtx.textAlign='left'; bgCtx.textBaseline='top';
      let curY=y+yNudge;
      for(const L of lines){
        let x=(canvasW-L.width)/2;
        for(const t of L.tokens){
          const topY=curY+(L.height-t.height)/2;
          if(t.type==='text') bgCtx.fillText(t.content,x,topY); else bgCtx.drawImage(t.image,x,topY,t.drawW,t.drawH);
          x+=t.width;
        }
        curY+=L.height+8;
      }
      bgCtx.textAlign=prevAlign; bgCtx.textBaseline=prevBase; bgCtx.fillStyle=prevFill;
    }

    /* ---------------- Canvas sizing & drawing ---------------- */
    function resizeCanvases(){
      const rect = document.getElementById('boardWrap').getBoundingClientRect();
      devicePixelRatioVal = window.devicePixelRatio || 1;
      const w=Math.floor(rect.width), h=Math.floor(rect.height);
      [bgCanvas, drawCanvas].forEach(c=>{ c.width=w*devicePixelRatioVal; c.height=h*devicePixelRatioVal; c.style.width=w+'px'; c.style.height=h+'px'; });
      [bgCtx, ctx].forEach(c=>{ c.resetTransform(); c.scale(devicePixelRatioVal,devicePixelRatioVal); });
      ctx.lineWidth=3; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000';
      if(currentStageIndex>=0) repaintStage();
    }

    function repaintStage(){
      const a = answers[currentStageIndex];
      bgCtx.clearRect(0,0,bgCanvas.width/devicePixelRatioVal,bgCanvas.height/devicePixelRatioVal);
      const headline = `Question ${currentStageIndex+1}: ${testData.stages[currentStageIndex].headline || ''}`;
      const baseFont = currentLang==='hy' ? 'Montserrat Arm' : 'Manrope';
      bgCtx.font=`22px '${baseFont}', system-ui, sans-serif`;
      ensureHeadlineFontsLoaded().then(()=>renderComplexHeadline(bgCtx,headline,62));
      // draw strokes
      ctx.clearRect(0,0,drawCanvas.width/devicePixelRatioVal,drawCanvas.height/devicePixelRatioVal);
      if(a && a.strokes){
        ctx.beginPath();
        a.strokes.forEach(st=>{
          if(st.length){
            ctx.moveTo(st[0].x, st[0].y);
            for(let i=1;i<st.length;i++){
              const prev = st[i-1], p = st[i];
              const mid = {x:(prev.x+p.x)/2,y:(prev.y+p.y)/2};
              ctx.quadraticCurveTo(prev.x,prev.y,mid.x,mid.y); ctx.stroke(); ctx.moveTo(mid.x,mid.y);
            }
          }
        });
        ctx.closePath();
      }
      buildNav();
      notesProblemNum.textContent = (currentStageIndex+1);
      notesArea.value = a?.notes || '';
      unsureBtn.classList.toggle('ghost', !!a?.unsure);
    }

    function getPos(e, canvasEl){
      const rect = canvasEl.getBoundingClientRect();
      let clientX, clientY;
      if(e.touches && e.touches.length>0){ clientX=e.touches[0].clientX; clientY=e.touches[0].clientY; }
      else if(e.changedTouches && e.changedTouches.length>0){ clientX=e.changedTouches[0].clientX; clientY=e.changedTouches[0].clientY; }
      else { clientX=e.clientX; clientY=e.clientY; }
      return {x: clientX-rect.left, y: clientY-rect.top}
    }

    function startStroke(e){
      const pos = getPos(e, drawCanvas); if(!pos) return;
      if(e.touches) e.preventDefault();
      drawing=true; lastPos=pos;
      const a = answers[currentStageIndex];
      a.strokes.push([pos]); a.redo=[]; a.hasAnswer=true;
    }

    function moveStroke(e){
      if(!drawing) return;
      const pos = getPos(e, drawCanvas); if(!pos) return;
      if(e.touches) e.preventDefault();
      const a = answers[currentStageIndex]; const st = a.strokes[a.strokes.length-1];
      const mid={x:(lastPos.x+pos.x)/2,y:(lastPos.y+pos.y)/2};
      ctx.quadraticCurveTo(lastPos.x,lastPos.y,mid.x,mid.y); ctx.stroke(); ctx.moveTo(mid.x,mid.y);
      st.push(pos); lastPos=pos;
    }

    function endStroke(){
      if(!drawing) return;
      drawing=false;
      saveLocal();
    }

    function undo(){
      const a = answers[currentStageIndex];
      if(a.strokes.length){ a.redo.push(a.strokes.pop()); repaintStage(); saveLocal(); }
    }
    function redo(){
      const a = answers[currentStageIndex];
      if(a.redo.length){ a.strokes.push(a.redo.pop()); repaintStage(); saveLocal(); }
    }
    function clearBoard(){
      const a = answers[currentStageIndex];
      a.strokes=[]; a.redo=[]; a.hasAnswer=false;
      ctx.clearRect(0,0,drawCanvas.width/devicePixelRatioVal,drawCanvas.height/devicePixelRatioVal);
      saveLocal(); repaintStage();
    }

    /* ---------------- Problem flow ---------------- */
    function updateTimer(){
      if(!testStartTime) return;
      const ms = Date.now()-testStartTime;
      timerDisplay.textContent = elapsedStr(ms);
    }

    function jumpTo(index){
      if(isTransitioning || index<0 || index>=testData.stages.length) return;
      isTransitioning=true;
      bgCanvas.classList.add('fade-out');
      setTimeout(()=>{
        currentStageIndex = index;
        repaintStage();
        bgCanvas.classList.remove('fade-out');
        isTransitioning=false;
        saveLocal();
      }, 250);
    }

    function next(){ if(currentStageIndex<testData.stages.length-1) jumpTo(currentStageIndex+1); }
    function prev(){ if(currentStageIndex>0) jumpTo(currentStageIndex-1); }

    function saveAndNext(){
      // Already autosaving; this button is semantic. Just move on.
      next();
    }

    function toggleUnsure(){
      const a = answers[currentStageIndex]; a.unsure = !a.unsure; saveLocal(); repaintStage();
    }

    function toggleNotes(open){
      if(typeof open==='boolean'){ notesPanel.classList.toggle('open', open); return; }
      notesPanel.classList.toggle('open');
      if(notesPanel.classList.contains('open')) notesArea.focus();
    }

    notesArea.addEventListener('input', ()=>{
      const a = answers[currentStageIndex]; a.notes = notesArea.value; saveLocal();
    });

    /* ---------------- End of Test → Batch Analyze ---------------- */
    function getBoundingBox(ctx){
      const c=ctx.canvas, w=c.width, h=c.height;
      const data = ctx.getImageData(0,0,w,h).data;
      let minX=w,minY=h,maxX=-1,maxY=-1;
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          if(data[(y*w+x)*4+3]>0){ minX=Math.min(minX,x); minY=Math.min(minY,y); maxX=Math.max(maxX,x); maxY=Math.max(maxY,y); }
        }
      }
      if(maxX===-1) return null;
      const pad = 20*devicePixelRatioVal;
      minX=Math.max(0,minX-pad); minY=Math.max(0,minY-pad);
      maxX=Math.min(w,maxX+pad); maxY=Math.min(h,maxY+pad);
      return {x:minX,y:minY,w:maxX-minX,h:maxY-minY};
    }

    function renderStrokesToImage(index){
      const a = answers[index]; if(!a || !a.strokes.length) return null;
      const cssW = drawCanvas.clientWidth, cssH = drawCanvas.clientHeight;
      const tmp = document.createElement('canvas');
      tmp.width = cssW*devicePixelRatioVal; tmp.height = cssH*devicePixelRatioVal;
      const tctx = tmp.getContext('2d'); tctx.scale(devicePixelRatioVal, devicePixelRatioVal);
      tctx.lineWidth=3; tctx.lineCap='round'; tctx.lineJoin='round'; tctx.strokeStyle='#000';
      tctx.beginPath();
      a.strokes.forEach(st=>{
        if(st.length){
          tctx.moveTo(st[0].x,st[0].y);
          for(let i=1;i<st.length;i++){
            const prev=st[i-1], p=st[i];
            const mid={x:(prev.x+p.x)/2,y:(prev.y+p.y)/2};
            tctx.quadraticCurveTo(prev.x,prev.y,mid.x,mid.y); tctx.stroke(); tctx.moveTo(mid.x,mid.y);
          }
        }
      });
      tctx.closePath();
      // crop
      const box = getBoundingBox(tctx); if(!box) return null;
      const crop = document.createElement('canvas'); crop.width=box.w; crop.height=box.h;
      crop.getContext('2d').drawImage(tmp, box.x, box.y, box.w, box.h, 0, 0, box.w, box.h);
      return crop.toDataURL('image/png');
    }

    async function finishTest(){
      if(!testStartTime){ alert('Test has not started.'); return; }
      if(!auth.currentUser){ alert('You must be signed in.'); return; }
      if(!confirm('Finish and analyze all answers now?')) return;

      // Prepare items for batch analysis
      const items = testData.stages.map((st, i)=>{
        const img = renderStrokesToImage(i);
        if(!img) return { status:'unanswered', feedback: 'No answer provided.', question: st.headline||'', correctAnswer: String(st.correctAnswer||'') };
        return {
          imageBase64: img,
          problemText: st.headline || '',
          correctAnswer: String(st.correctAnswer),
          question: st.headline || ''
        }
      });

      // Call batchAnalyze
      submitBtn.disabled = true; finishBtn.disabled = true;
      const batchAnalyze = fns.httpsCallable('batchAnalyzeTest');
      let resultArray = [];
      try{
        const res = await batchAnalyze({ items, language: currentLang });
        resultArray = res.data?.results || [];
      }catch(err){
        console.error('Batch analyze failed', err);
        // Fallback: mark any answered as "unchecked"
        resultArray = items.map(it=> it.imageBase64 ? {status:'unknown', feedback:'Could not analyze now. Try again later.', correctAnswer:it.correctAnswer, question: it.question, img: it.imageBase64} : {status:'unanswered', feedback:'No answer provided.', correctAnswer:it.correctAnswer, question: it.question});
      }finally{
        submitBtn.disabled = false; finishBtn.disabled = false;
      }

      // Attach images + notes + unsure flags; compute score
      reviewedResults = resultArray.map((r,i)=>{
        const img = items[i]?.imageBase64 || null;
        const q = items[i]?.question || testData.stages[i]?.headline || '';
        const ca = items[i]?.correctAnswer || String(testData.stages[i]?.correctAnswer||'');
        return { ...r, img, question:q, correctAnswer: ca, notes: answers[i]?.notes||'', unsure: !!answers[i]?.unsure }
      });

      const correctCount = reviewedResults.filter(r=>r.status==='correct').length;
      const total = testData.stages.length;
      const timeTaken = Date.now() - testStartTime;

      // Show review overlay (overview first)
      showReview('overview');
      renderOverview(correctCount, total, timeTaken);
      reviewIndex = 0;
      renderDetail(reviewIndex);

      // Optional: persist summary (no images) to Firestore
      try{
        const saveSummary = fns.httpsCallable('saveTestSummary');
        await saveSummary({
          testId: (getUrlParam('testFile')||'').replace('.json','') || 'ad-hoc',
          timeTakenSeconds: Math.floor(timeTaken/1000),
          results: reviewedResults.map(r=>({question:r.question, correctAnswer:r.correctAnswer, status:r.status, feedback:r.feedback, unsure:r.unsure, hasAnswer: !!r.img})),
          score: correctCount,
          totalQuestions: total,
          language: currentLang
        });
      }catch(e){ console.warn('saveTestSummary failed (non-blocking):', e); }

      // Clean local cache after finish to avoid mixing with next attempts
      clearLocal();
    }

    function showReview(which){
      reviewOverlay.style.display = 'flex';
      overview.style.display = which==='overview' ? 'block':'none';
      detail.style.display = which==='detail' ? 'block':'none';
      toOverviewBtn.classList.toggle('secondary', which==='overview');
      toDetailBtn.classList.toggle('secondary', which==='detail');
    }
    function hideReview(){ reviewOverlay.style.display='none'; }

    function renderOverview(correctCount, total, timeTaken){
      sumScore.textContent = `${correctCount} / ${total} (${Math.round((correctCount/total)*100)}%)`;
      sumTime.textContent = elapsedStr(timeTaken);
      sumAnswered.textContent = answers.filter(a=>a?.hasAnswer).length;
      sumUnsure.textContent = answers.filter(a=>a?.unsure).length;

      overviewGrid.innerHTML = '';
      reviewedResults.forEach((r,i)=>{
        const cell = document.createElement('div'); cell.className='cell';
        const line1 = document.createElement('div'); line1.style.fontWeight='800'; line1.textContent = i+1;
        const line2 = document.createElement('div'); line2.style.fontSize='.85rem';
        const badge = document.createElement('span'); badge.className='badge';
        badge.style.borderColor = r.status==='correct'? '#10b981' : r.status==='incorrect' ? '#ef4444' : '#d1d5db';
        badge.textContent = r.status;
        line2.appendChild(badge);
        cell.appendChild(line1); cell.appendChild(line2);
        cell.onclick = ()=>{ reviewIndex=i; showReview('detail'); renderDetail(reviewIndex); }
        overviewGrid.appendChild(cell);
      });
    }

    function renderDetail(i){
      const r = reviewedResults[i] || {};
      detailHeadline.textContent = r.question || `Question ${i+1}`;
      detailImg.src = r.img || '';
      detailCorrect.textContent = (r.correctAnswer ?? '–');
      detailFeedback.textContent = (r.feedback ?? '–');
      detailNotes.textContent = (r.notes ?? '');
      detailPrev.disabled = (i<=0); detailNext.disabled = (i>=reviewedResults.length-1);
    }

    /* ---------------- Init / Load test ---------------- */
    async function loadTest(testJsonPath){
      isTransitioning=true;
      try{
        const res = await fetch(testJsonPath);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        testData = await res.json();
        if(!testData || !Array.isArray(testData.stages)) throw new Error('Invalid test format.');
        currentLang = testData.lang==='hy' ? 'hy':'en';
        document.body.className = currentLang==='hy' ? 'lang-hy' : '';
        document.title = testData.testTitle || 'thelo | Test Mode';
        testTitleChip.textContent = testData.testTitle || 'Test';

        // Prepare local state
        answers = testData.stages.map(()=>({strokes:[], redo:[], unsure:false, notes:'', hasAnswer:false}));
        const cached = loadLocal();
        if(cached && cached.answers && Array.isArray(cached.answers)){
          answers = cached.answers;
          currentStageIndex = typeof cached.currentStageIndex==='number' ? cached.currentStageIndex : -1;
          currentLang = cached.currentLang || currentLang;
          if(cached.started && cached.testStartTime){ testStartTime = cached.testStartTime; }
        }

        if(currentStageIndex===-1){ currentStageIndex=0; testStartTime = testStartTime || Date.now(); }
        timerInterval = setInterval(updateTimer, 1000);
        resizeCanvases(); repaintStage();
      }catch(e){
        console.error('loadTest error', e); alert('Failed to load the test file.');
      }finally{
        isTransitioning=false; loadingOverlay.classList.add('hidden');
      }
    }

    function initApp(){
      resizeCanvases();
      // drawing
      drawCanvas.addEventListener('mousedown', startStroke);
      drawCanvas.addEventListener('mousemove', moveStroke);
      window.addEventListener('mouseup', endStroke);
      drawCanvas.addEventListener('touchstart', startStroke, {passive:false});
      drawCanvas.addEventListener('touchmove', moveStroke, {passive:false});
      window.addEventListener('touchend', endStroke);

      // controls
      prevBtn.onclick=prev; nextBtn.onclick=next;
      undoBtn.onclick=undo; redoBtn.onclick=redo;
      clearBtn.onclick=clearBoard; unsureBtn.onclick=toggleUnsure;
      submitBtn.onclick=saveAndNext;
      openNavBtn.onclick=()=>navPanel.classList.add('open');
      closeNavBtn.onclick=()=>navPanel.classList.remove('open');
      toggleNotesBtn.onclick=()=>toggleNotes();
      closeNotesBtn.onclick=()=>toggleNotes(false);
      finishBtn.onclick=finishTest;

      // review overlay
      backToLessonBtn.onclick=()=>hideReview();
      toOverviewBtn.onclick=()=>showReview('overview');
      toDetailBtn.onclick=()=>showReview('detail');
      detailPrev.onclick=()=>{ if(reviewIndex>0){ reviewIndex--; renderDetail(reviewIndex); } };
      detailNext.onclick=()=>{ if(reviewIndex<reviewedResults.length-1){ reviewIndex++; renderDetail(reviewIndex); } };

      // keys
      window.addEventListener('keydown', (e)=>{
        if(reviewOverlay.style.display==='flex') return; // no nav while reviewing
        if(e.key==='ArrowRight') next();
        if(e.key==='ArrowLeft') prev();
        if(e.key.toLowerCase()==='a') toggleNotes();
        if(e.key.toLowerCase()==='u') toggleUnsure();
      });

      window.addEventListener('resize', resizeCanvases);

      // Load test by URL
      const testFileName = getUrlParam('testFile');
      if(!testFileName){
        alert("Add ?testFile=your-test.json to the URL.");
        loadingOverlay.classList.add('hidden'); return;
      }
      LS_KEY = `thelo-test-${testFileName}`;
      loadTest(`https://thelo.space/tests/${testFileName}`);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      auth.onAuthStateChanged(user=>{
        initApp();
      });
    });
  </script>
</body>
</html>
