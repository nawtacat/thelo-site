<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dashboardTitle">Thelo Orbital</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --thelo-blue: #2563EB;
            --thelo-green: #10B981;
            --thelo-bg: #111827; /* Darker background for space theme */
            --thelo-text: #F9FAFB;
            --thelo-text-light: #9CA3AF;
            --grid-color: #374151;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--thelo-bg);
            color: var(--thelo-text);
            background-image: radial-gradient(circle at 1px 1px, var(--grid-color) 1px, transparent 0);
            background-size: 40px 40px;
            overflow: hidden;
        }
        .main-header {
            background-color: rgba(17, 24, 39, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--grid-color);
            padding: 1rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }
        .header-stats { display: flex; align-items: center; gap: 2rem; }
        .stat-item { display: flex; align-items: center; gap: 0.5rem; }
        .stat-item i { color: var(--thelo-blue); }
        .stat-item .value { font-weight: 800; font-size: 1.1rem; }
        .stat-item .label { font-size: 0.9rem; color: var(--thelo-text-light); }
        main {
            height: calc(100vh - 80px); /* Adjust based on header height */
            width: 100%;
            perspective: 1000px; /* This enables 3D space */
            position: relative;
            overflow: hidden;
        }

        /* --- NEW ORBITAL SYSTEM STYLES --- */
        .orbital-system {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .unit-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 3px dashed var(--grid-color);
            transform-style: preserve-3d;
            transition: all 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .unit-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--thelo-text-light);
            font-size: 2rem;
            font-weight: 800;
            opacity: 0.5;
        }

        /* Ring States */
        .unit-ring.is-focus {
            width: 500px;
            height: 500px;
            border-color: var(--thelo-blue);
            opacity: 1;
            transform: translate(-50%, -50%) rotateX(60deg) scale(1);
        }
        .unit-ring.is-past {
            width: 500px;
            height: 500px;
            opacity: 0.1;
            transform: translate(-50%, -50%) rotateX(60deg) scale(0.2) translateZ(-1000px);
        }
        .unit-ring.is-future {
            width: 50px;
            height: 50px;
            background-color: rgba(37, 99, 235, 0.3);
            border: none;
            box-shadow: 0 0 20px 5px rgba(37, 99, 235, 0.5);
            opacity: 0.5;
            transform: translate(-50%, -50%) rotateX(60deg) scale(1) translateZ(2000px);
        }
        .unit-ring.is-future .topic-node { display: none; }
        .unit-ring.is-future .unit-title { display: none; }

        /* Topic Nodes (Satellites) */
        .topic-node {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            margin: -50px 0 0 -50px;
            background-color: rgba(255,255,255,0.1);
            border: 1px solid var(--grid-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.4s ease, background-color 0.4s ease;
            text-decoration: none;
            color: var(--thelo-text);
        }

        .topic-node:hover {
            background-color: rgba(37, 99, 235, 0.5);
            border-color: var(--thelo-blue);
            transform: var(--base-transform) scale(1.1) rotateX(-60deg) !important;
        }
        
        .topic-node.completed {
            background-color: rgba(16, 185, 129, 0.3);
            border-color: var(--thelo-green);
        }
        
        .topic-node.next-up {
            background-color: rgba(37, 99, 235, 0.4);
            border-color: var(--thelo-blue);
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px 3px rgba(37, 99, 235, 0.3); }
            50% { box-shadow: 0 0 25px 8px rgba(37, 99, 235, 0.7); }
        }

        .page-footer {
            display: none; /* Footer doesn't fit this design */
        }
        
        @media (max-width: 768px) {
             .unit-ring.is-focus {
                width: 320px;
                height: 320px;
             }
             .topic-node {
                width: 80px;
                height: 80px;
                margin: -40px 0 0 -40px;
                font-size: 0.75rem;
             }
        }

    </style>
</head>
<body>

    <header class="main-header">
        <div class="flex items-center gap-4">
            <img src="https://thelo.space/img/thelo-Photoroom.png" alt="Thelo logo" class="h-8 w-auto" />
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <i class="fas fa-star"></i>
                <div>
                    <div id="student-points" class="value">...</div>
                    <div class="label" data-i18n="pointsTitle">Points</div>
                </div>
            </div>
            <div class="stat-item">
                <i class="fas fa-fire"></i>
                <div>
                    <div id="streak-count" class="value">...</div>
                    <div class="label" data-i18n="streakTitle">Streak</div>
                </div>
            </div>
            <div class="stat-item">
                <i class="fas fa-check-circle"></i>
                <div>
                    <div id="lessons-completed-count" class="value">...</div>
                    <div class="label" data-i18n="lessonsCompletedTitle">Lessons</div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button id="open-thelobook-btn" class="text-gray-400 hover:text-blue-400">
                <i class="fas fa-book-open text-xl"></i>
            </button>
            <img id="profile-photo-nav" src="https://via.placeholder.com/150/E5E7EB/FFFFFF?text=L" alt="Profile" class="h-10 w-10 rounded-full cursor-pointer border-2 border-transparent hover:border-blue-500">
        </div>
    </header>

    <main id="main-container">
        </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
            authDomain: "physmathacademy-722b3.firebaseapp.com",
            projectId: "physmathacademy-722b3",
            storageBucket: "physmathacademy-722b3.appspot.com",
            appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const mainContainer = document.getElementById('main-container');

        async function renderFullCourse(courseId, userId) {
            if (!mainContainer) return;
            mainContainer.innerHTML = `<p class="text-center text-slate-400">Calibrating orbital path...</p>`;

            try {
                // Step 1: Fetch all data
                const progressQuery = query(collection(db, 'thelo-students', userId, 'progress'));
                const unitsQuery = query(collection(db, 'courses', courseId, 'units'), orderBy('order'));
                const [progressSnapshot, unitsSnapshot] = await Promise.all([getDocs(progressQuery), getDocs(unitsQuery)]);
                const progressMap = new Map(progressSnapshot.docs.map(doc => [doc.id, doc.data()]));

                const unitsWithTopics = await Promise.all(unitsSnapshot.docs.map(async (unitDoc) => {
                    const topicsQuery = query(collection(unitDoc.ref, 'topics'), orderBy('order'));
                    const topicsSnapshot = await getDocs(topicsQuery);
                    const topics = topicsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    return { id: unitDoc.id, ...unitDoc.data(), topics };
                }));

                // Step 2: Determine focus, past, and future units
                let focusIndex = unitsWithTopics.findIndex(unit => {
                    const completedTopics = unit.topics.filter(t => progressMap.has(t.id)).length;
                    return completedTopics < unit.topics.length;
                });
                if (focusIndex === -1) focusIndex = unitsWithTopics.length - 1; // All completed, focus on last

                // Step 3: Build the HTML
                let orbitalSystemHTML = `<div class="orbital-system">`;
                const nextUpTopicId = unitsWithTopics.flatMap(u => u.topics).find(t => !progressMap.has(t.id))?.id;

                unitsWithTopics.forEach((unit, index) => {
                    let ringClass = '';
                    if (index < focusIndex) ringClass = 'is-past';
                    else if (index === focusIndex) ringClass = 'is-focus';
                    else ringClass = 'is-future';

                    orbitalSystemHTML += `
                        <div class="unit-ring ${ringClass}" id="unit-${unit.id}">
                            <div class="unit-title">${unit.unitTitle}</div>
                    `;

                    // Position topics around the ring
                    const numTopics = unit.topics.length;
                    const radius = (window.innerWidth < 768) ? 160 : 250; // Ring radius
                    unit.topics.forEach((topic, topicIndex) => {
                        const angle = (2 * Math.PI / numTopics) * topicIndex;
                        const x = radius * Math.cos(angle);
                        const y = radius * Math.sin(angle);

                        const isCompleted = progressMap.has(topic.id);
                        const isNextUp = topic.id === nextUpTopicId;
                        const transformStyle = `transform: var(--base-transform, rotate(${angle}rad) translate(${radius}px) rotate(${-angle}rad)) rotateX(-60deg);`;
                        
                        orbitalSystemHTML += `
                            <a href="${!ringClass.includes('future') ? `https://thelo.space/1.5/?lessonFile=${topic.lessonFileUrl}` : '#'}" 
                                class="topic-node ${isCompleted ? 'completed' : ''} ${isNextUp ? 'next-up' : ''}" 
                                style="--base-transform: rotate(${angle}rad) translate(${radius}px) rotate(${-angle}rad); transform: var(--base-transform) rotateX(-60deg);">
                                ${topic.topicName}
                            </a>
                        `;
                    });

                    orbitalSystemHTML += `</div>`; // Close unit-ring
                });

                orbitalSystemHTML += `</div>`; // Close orbital-system
                mainContainer.innerHTML = orbitalSystemHTML;

            } catch (error) {
                console.error("Error rendering course:", error);
                mainContainer.innerHTML = `<p class="text-center text-red-400">Orbital path calculation failed. Please refresh.</p>`;
            }
        }
        
        async function updateDashboardHeader(user) {
            // This function remains identical to your original code
            const studentDocRef = doc(db, 'thelo-students', user.uid);
            const profilePhotoNav = document.getElementById('profile-photo-nav');
            const studentPointsSpan = document.getElementById('student-points');
            const lessonsCompletedCountSpan = document.getElementById('lessons-completed-count');
            const streakCountSpan = document.getElementById('streak-count');

            try {
                const docSnap = await getDoc(studentDocRef);
                if (docSnap.exists()) {
                    const studentData = docSnap.data();

                    if (profilePhotoNav && studentData.profilePicture) {
                        profilePhotoNav.src = studentData.profilePicture;
                    }
                    if (studentPointsSpan) studentPointsSpan.textContent = studentData.points || 0;
                    if (streakCountSpan) streakCountSpan.textContent = studentData.streakData?.currentStreak || 0;
                    if (lessonsCompletedCountSpan) lessonsCompletedCountSpan.textContent = studentData.lessonsCompleted || 0;
                
                } else {
                    if (studentPointsSpan) studentPointsSpan.textContent = 0;
                    if (streakCountSpan) streakCountSpan.textContent = 0;
                    if (lessonsCompletedCountSpan) lessonsCompletedCountSpan.textContent = 0;
                }
            } catch (error) {
                console.error("Error fetching student profile:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await Promise.all([
                    updateDashboardHeader(user),
                    renderFullCourse('sat-math-prep', user.uid)
                ]);
            } else {
                mainContainer.innerHTML = '<p class="text-center text-slate-400">Awaiting authentication to enter orbit...</p>';
            }
        });
    </script>
</body>
</html>
