<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="dashboardTitle">thelo</title>

  <!-- Icons -->
  <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png" />

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --thelo-blue: #2563eb;
      --thelo-blue-light: #eff6ff;
      --thelo-green: #10b981;
      --thelo-amber: #f59e0b;
      --thelo-bg: #f8f9fa;
      --thelo-text: #111827;
      --thelo-text-light: #6b7280;
      --grid-color: #e5e7eb;
    }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    body {
      font-family: "Manrope", sans-serif;
      background: var(--thelo-bg);
      color: var(--thelo-text);
    }
    html[lang="hy"] body { font-family: "Noto Serif Armenian", serif; }
    html[lang="hy"] h1, html[lang="hy"] h2, html[lang="hy"] h3 { font-weight: 700; }

    /* ── header ── */
    .main-header{
      background:rgba(255,255,255,0.5);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--grid-color);
      padding:1rem 2.5rem;
      display:flex;justify-content:space-between;align-items:center;
      position:sticky;top:0;z-index:20;
    }

    /* ── collapsible units ── */
    .unit-card{
      background:#fff;border:1px solid var(--grid-color);
      border-radius:0.75rem;margin-bottom:1.5rem;
      box-shadow:0 4px 15px rgba(0,0,0,.05);
    }
    .unit-header{
      display:flex;align-items:center;gap:1rem;
      padding:1rem 1.25rem;cursor:pointer;
    }
    .unit-header:hover{background:var(--thelo-blue-light);}
    .unit-header i{
      font-size:1.35rem;color:var(--thelo-blue);
      background:var(--thelo-blue-light);padding:0.8rem;border-radius:50%;
    }
    .unit-title{font-size:1.25rem;font-weight:800;}
    .unit-meta{font-size:.875rem;color:var(--thelo-text-light);}
    .chevron{margin-left:auto;transition:transform .2s ease;}
    .unit-card.open .chevron{transform:rotate(180deg);}

    /* ── topics grid ── */
    .topics-grid{display:none;padding:0 1.25rem 1.25rem;flex-wrap:wrap;gap:1rem;}
    .unit-card.open .topics-grid{display:flex;}

    .topic-card{
      flex:1 1 calc(50% - .5rem);min-width:260px;
      background:#fff;border:1px solid var(--grid-color);
      border-left:5px solid transparent;
      border-radius:0.75rem;padding:1rem 1.25rem;
      display:flex;justify-content:space-between;align-items:center;
      text-decoration:none;transition:all .25s ease;
    }
    .topic-card:hover{transform:translateY(-4px) scale(1.015);box-shadow:0 6px 18px rgba(0,0,0,.08);}
    .topic-card.completed{background:#f8f9fa;border-left-color:var(--thelo-green);}
    .topic-card.in-progress{border-left-color:var(--thelo-amber);}
    .topic-card.next-up{border:2px solid var(--thelo-blue);border-left-width:5px;box-shadow:0 8px 22px rgba(37,99,235,.2);}

    .topic-info{display:flex;flex-direction:column;}
    .topic-name{font-weight:700;color:var(--thelo-text);}
    .topic-status{font-size:.8rem;font-weight:600;color:var(--thelo-text-light);}
    .topic-status.completed{color:var(--thelo-green);}
    .topic-status.in-progress{color:var(--thelo-amber);}

    .topic-action-btn{
      background:var(--grid-color);color:var(--thelo-text);
      font-weight:700;padding:.4rem .9rem;border-radius:.5rem;
      transition:all .2s ease;
    }
    .topic-card.next-up .topic-action-btn{background:var(--thelo-blue);color:#fff;}
    .topic-action-btn:hover{background:var(--thelo-blue);color:#fff;}

    @media(max-width:640px){ .topic-card{flex:1 1 100%;} }
  </style>
</head>

<body class="antialiased">
  <!-- ────────── HEADER ────────── -->
  <header class="main-header">
    <div class="flex items-center gap-4">
      <img src="https://thelo.space/img/thelo-Photoroom.png" alt="Thelo logo" class="h-8 w-auto" />
    </div>

    <div class="flex items-center gap-8 text-center">
      <div>
        <div id="student-points" class="text-lg font-extrabold">0</div>
        <div class="text-xs text-slate-500" data-i18n="pointsTitle">Points</div>
      </div>
      <div>
        <div id="streak-count" class="text-lg font-extrabold">0</div>
        <div class="text-xs text-slate-500" data-i18n="streakTitle">Streak</div>
      </div>
      <div>
        <div id="lessons-completed-count" class="text-lg font-extrabold">0</div>
        <div class="text-xs text-slate-500" data-i18n="lessonsCompletedTitle">Lessons</div>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <button id="open-thelobook-btn" aria-label="Open thelobook" class="text-gray-600 hover:text-blue-600">
        <i class="fas fa-book-open text-xl"></i>
      </button>
      <img id="profile-photo-nav" src="https://thelo.space/img/avatar-default.png" alt="Profile"
           class="h-10 w-10 rounded-full cursor-pointer border-2 border-transparent hover:border-blue-500" />
    </div>
  </header>

  <!-- ────────── MAIN ────────── -->
  <main class="px-4 md:px-10 py-8 max-w-3xl mx-auto">
    <div id="learning-path-container"></div>
  </main>

  <!-- ────────── FIREBASE + DASHBOARD LOGIC ────────── -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc,
      collection, getDocs,
      query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ========= Firebase config ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
      authDomain: "physmathacademy-722b3.firebaseapp.com",
      projectId: "physmathacademy-722b3",
      storageBucket: "physmathacademy-722b3.appspot.com",
      appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const learnEl = document.getElementById("learning-path-container");

    /* ========= UI helpers ========= */
    async function updateHeader(user) {
      const snap = await getDoc(doc(db, "thelo-students", user.uid));
      if (!snap.exists()) return;
      const d = snap.data();
      document.getElementById("student-points").textContent       = d.points ?? 0;
      document.getElementById("streak-count").textContent         = d.streakData?.currentStreak ?? 0;
      document.getElementById("lessons-completed-count").textContent = d.lessonsCompleted ?? 0;
      if (d.profilePicture) document.getElementById("profile-photo-nav").src = d.profilePicture;
    }

    async function renderCourse(courseId, uid) {
      learnEl.textContent = "Loading…";
      try {
        const [unitsSnap, progressSnap] = await Promise.all([
          getDocs(query(collection(db, "courses", courseId, "units"), orderBy("order"))),
          getDocs(collection(db, "thelo-students", uid, "progress"))
        ]);

        const progressMap = new Map(progressSnap.docs.map(d => [d.id, d.data()]));
        let nextUp = null, html = "";

        for (const unitDoc of unitsSnap.docs) {
          const unit = { id: unitDoc.id, ...unitDoc.data() };
          const topicSnap = await getDocs(query(collection(unitDoc.ref, "topics"), orderBy("order")));
          const topics = topicSnap.docs.map(d => ({ id: d.id, unit, ...d.data() }));
          if (!nextUp) nextUp = topics.find(t => !progressMap.has(t.id));

          html += `<div class="unit-card" id="unit-${unit.id}">
                    <div class="unit-header">
                      <i class="fas ${unit.icon || 'fa-book'}"></i>
                      <div>
                        <div class="unit-title">${unit.unitTitle}</div>
                        <div class="unit-meta">${unit.unitMeta}</div>
                      </div>
                      <i class="fas fa-chevron-down chevron"></i>
                    </div>
                    <div class="topics-grid">
                      ${topics.map(topic => {
                        const p = progressMap.get(topic.id);
                        let status = "Not Started", cls="not-started", icon="fa-play-circle", action="Start";
                        if (p?.status === "completed") { status="Completed"; cls="completed"; icon="fa-check-circle"; action="Review"; }
                        else if (p?.status === "in-progress") { status="In Progress"; cls="in-progress"; icon="fa-hourglass-half"; action="Resume"; }
                        if (topic.id === nextUp?.id) cls += " next-up";
                        return `<a href="https://thelo.space/1.5/?lessonFile=${topic.lessonFileUrl}" class="topic-card ${cls}">
                                  <div class="topic-info">
                                    <span class="topic-name">${topic.topicName}</span>
                                    <span class="topic-status ${cls}"><i class="fas ${icon}"></i> ${status}</span>
                                  </div>
                                  <span class="topic-action-btn">${action}</span>
                                </a>`;
                      }).join("")}
                    </div>
                  </div>`;
        }
        learnEl.innerHTML = html;

        /* accordion toggle */
        document.querySelectorAll(".unit-header").forEach(h => {
          h.addEventListener("click", () => h.parentElement.classList.toggle("open"));
        });
      } catch (err) {
        console.error(err);
        learnEl.textContent = "Could not load course.";
      }
    }

    /* ========= Auth flow ========= */
    onAuthStateChanged(auth, user => {
      if (!user) { learnEl.textContent = "Please log in."; return; }
      Promise.all([
        updateHeader(user),
        renderCourse("sat-math-prep", user.uid)
      ]);
    });
  </script>
</body>
</html>
111111111111111111111
