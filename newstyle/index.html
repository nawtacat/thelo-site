<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dashboardTitle">thelo</title>
    <link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://thelo.space/img/yarnicon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --thelo-blue: #2563EB;
            --thelo-blue-light: #EFF6FF;
            --thelo-green: #10B981;
            --thelo-amber: #F59E0B;
            --thelo-bg: #F8F9FA;
            /* ... (keep all original CSS styles) ... */
        }
        html { scroll-behavior: smooth; overflow-x: hidden; }
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--thelo-bg);
            color: var(--thelo-text);
            background-image:
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        /* ... (all other original styles from the <style> block) ... */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--thelo-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 5rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <header class="main-header">
        <div class="flex items-center gap-4">
            <img src="https://thelo.space/img/thelo-Photoroom.png" alt="Thelo logo" class="h-8 w-auto" />
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <i class="fas fa-star"></i>
                <div>
                    <div id="student-points" class="value">...</div>
                    <div class="label" data-i18n="pointsTitle">Points</div>
                </div>
            </div>
            <div class="stat-item">
                <i class="fas fa-fire"></i>
                <div>
                    <div id="streak-count" class="value">...</div>
                    <div class="label" data-i18n="streakTitle">Streak</div>
                </div>
            </div>
            <div class="stat-item">
                <i class="fas fa-check-circle"></i>
                <div>
                    <div id="lessons-completed-count" class="value">...</div>
                    <div class="label" data-i18n="lessonsCompletedTitle">Lessons</div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button id="open-thelobook-btn" class="text-gray-600 hover:text-blue-600">
                <i class="fas fa-book-open text-xl"></i>
            </button>
            <img id="profile-photo-nav" src="https://via.placeholder.com/150/E5E7EB/FFFFFF?text=L" alt="Profile" class="h-10 w-10 rounded-full cursor-pointer border-2 border-transparent hover:border-blue-500">
        </div>
    </header>

    <main>
        <div class="learning-path">
            <div id="loading-spinner" class="loader"></div>
            </div>
        
        <footer class="page-footer">
            <div id="join-class-card" class="max-w-xl mx-auto p-8 bg-white rounded-lg shadow-sm border border-gray-200">
                <div id="not-in-class-state">
                    <h3 class="text-xl font-bold mb-2" data-i18n="joinClassPrompt">Learning with a teacher?</h3>
                    <p class="text-base text-slate-600 mb-6" data-i18n="joinClassDesc">Join your class with a special code from your instructor.</p>
                    <div class="flex flex-col sm:flex-row gap-3 w-full max-w-sm mx-auto">
                        <input type="text" id="class-code-input" placeholder="Enter Code" class="flex-grow p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--thelo-blue)]/50">
                        <button id="join-class-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Join Class</button>
                    </div>
                </div>
            </div>
        </footer>
    </main>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyAbnPpcIt88B0jIAoLUdC71zmQDvR_fdu8",
    authDomain: "physmathacademy-722b3.firebaseapp.com",
    projectId: "physmathacademy-722b3",
    storageBucket: "physmathacademy-722b3.appspot.com",
    appId: "1:1093640992262:web:35b1bf4d2364bcf745f587"
};

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- DOM Elements ---
const studentPointsSpan = document.getElementById('student-points');
const lessonsCompletedCountSpan = document.getElementById('lessons-completed-count');
const streakCountSpan = document.getElementById('streak-count');
const profilePhotoNav = document.getElementById('profile-photo-nav');
const learningPathContainer = document.querySelector('.learning-path');
const loadingSpinner = document.getElementById('loading-spinner');

// --- Internationalization Strings (abbreviated for clarity) ---
// (You would include the full 'strings' object from your original file here)
const strings = {
    en: { btnReview: 'Review', btnContinue: 'Continue', btnStart: 'Start', statusCompleted: 'Completed', statusInProgress: 'In Progress', statusNotStarted: 'Not Started' /* ...other keys */ },
    hy: { btnReview: 'Վերանայել', btnContinue: 'Շարունակել', btnStart: 'Սկսել', statusCompleted: 'Ավարտված', statusInProgress: 'Ընթացքի մեջ', statusNotStarted: 'Չսկսված' /* ...other keys */ }
};
let currentLang = 'en'; // Default language

/**
 * Fetches the entire course structure (units and topics) from Firestore.
 * @param {string} courseId - The ID of the course to fetch (e.g., 'sat-math-prep').
 * @returns {Promise<Array>} A promise that resolves to an array of unit objects, each containing its topics.
 */
async function fetchCourseStructure(courseId) {
    const units = [];
    const unitsQuery = query(collection(db, 'courses', courseId, 'units'), orderBy('order'));
    const unitsSnapshot = await getDocs(unitsQuery);

    for (const unitDoc of unitsSnapshot.docs) {
        const unitData = { id: unitDoc.id, ...unitDoc.data(), topics: [] };
        const topicsQuery = query(collection(unitDoc.ref, 'topics'), orderBy('order'));
        const topicsSnapshot = await getDocs(topicsQuery);
        
        unitData.topics = topicsSnapshot.docs.map(topicDoc => ({
            id: topicDoc.id,
            ...topicDoc.data()
        }));
        units.push(unitData);
    }
    return units;
}

/**
 * Fetches the progress data for a specific student.
 * @param {string} studentId - The UID of the student.
 * @returns {Promise<Map>} A promise that resolves to a map of topicId -> progress data.
 */
async function fetchStudentProgress(studentId) {
    const progressMap = new Map();
    const progressSnapshot = await getDocs(collection(db, 'thelo-students', studentId, 'progress'));
    progressSnapshot.forEach(doc => {
        progressMap.set(doc.id, doc.data());
    });
    return progressMap;
}

/**
 * Renders the entire learning path timeline into the DOM.
 * @param {Array} units - The array of unit data with nested topics.
 * @param {Map} progressMap - The map of the student's progress.
 */
function renderLearningPath(units, progressMap) {
    learningPathContainer.innerHTML = ''; // Clear spinner and any old content
    let nextTopicId = null;

    units.forEach((unit, index) => {
        // Create Unit Header
        const unitElement = document.createElement('div');
        unitElement.className = 'path-unit';
        unitElement.innerHTML = `
            <div class="path-unit-header">
                <i class="fas ${unit.icon || 'fa-book'} unit-icon"></i>
                <div>
                    <h2 class="unit-title">${unit.unitTitle}</h2>
                    <p class="unit-meta">${unit.unitMeta}</p>
                </div>
            </div>
        `;

        // Create Topic Cards for the Unit
        unit.topics.forEach(topic => {
            const progress = progressMap.get(topic.id);
            let status = 'not-started';
            let statusText = strings[currentLang].statusNotStarted;
            let btnText = strings[currentLang].btnStart;
            let actionClass = '';

            if (progress) {
                status = progress.status; // "in-progress" or "completed"
                if (status === 'completed') {
                    statusText = `<i class="fas fa-check"></i> ${strings[currentLang].statusCompleted}`;
                    btnText = strings[currentLang].btnReview;
                    actionClass = 'completed';
                } else { // "in-progress"
                    statusText = `<i class="fas fa-clock"></i> ${progress.progressPercentage || 0}% Complete`;
                    btnText = strings[currentLang].btnContinue;
                    actionClass = 'in-progress';
                }
            } else {
                 if (!nextTopicId) {
                    nextTopicId = topic.id; // This is the first un-started topic
                }
            }

            // Construct the lesson URL
            const lessonUrl = `https://thelo.space/lesson/?lessonFile=${topic.lessonFileUrl}`;

            const topicCard = document.createElement('a');
            topicCard.href = lessonUrl;
            topicCard.id = `topic-${topic.id}`;
            topicCard.className = `topic-card ${actionClass}`;
            topicCard.innerHTML = `
                <div class="topic-info">
                    <div class="topic-name">${topic.topicName}</div>
                    <div class="topic-status ${actionClass}">${statusText}</div>
                </div>
                <span class="topic-action-btn">${btnText}</span>
            `;
            unitElement.appendChild(topicCard);
        });

        learningPathContainer.appendChild(unitElement);
    });
    
    // Highlight the very next topic to be done
    if (nextTopicId) {
        const nextCard = document.getElementById(`topic-${nextTopicId}`);
        if(nextCard) {
            nextCard.classList.add('next-up');
            // Update its button to include the arrow
            const button = nextCard.querySelector('.topic-action-btn');
            if (button) {
                button.innerHTML = `${strings[currentLang].btnContinue} <i class="fas fa-arrow-right ml-2"></i>`;
            }
        }
    }
}


/**
 * Main function to load all dashboard data and render the UI.
 * @param {Object} user - The authenticated Firebase user object.
 */
async function loadDashboard(user) {
    try {
        // Fetch student profile, course structure, and student progress concurrently
        const [studentSnap, courseStructure, studentProgress] = await Promise.all([
            getDoc(doc(db, 'thelo-students', user.uid)),
            fetchCourseStructure('sat-math-prep'), // Assuming a single course for now
            fetchStudentProgress(user.uid)
        ]);

        if (studentSnap.exists()) {
            const studentData = studentSnap.data();

            // Update header stats
            studentPointsSpan.textContent = studentData.points || 0;
            lessonsCompletedCountSpan.textContent = studentData.lessonsCompleted || 0;
            streakCountSpan.textContent = studentData.streakData?.currentStreak || 0;
            profilePhotoNav.src = studentData.profilePicture || `https://via.placeholder.com/150/2563EB/FFFFFF?text=${studentData.name?.charAt(0) || 'U'}`;
            currentLang = studentData.language || 'en'; // Set language from profile
        }

        // Render the dynamic learning path
        renderLearningPath(courseStructure, studentProgress);

    } catch (error) {
        console.error("Error loading dashboard:", error);
        learningPathContainer.innerHTML = `<p class="text-center text-red-500">Could not load learning path.</p>`;
    }
}

// --- Firebase Auth State Listener ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        console.log("User is authenticated:", user.uid);
        loadDashboard(user);
    } else {
        console.log("No user authenticated. Redirecting to login.");
        window.location.href = 'index.html'; // Or your login page
    }
});

// Add event listener for profile photo click
if (profilePhotoNav) {
    profilePhotoNav.addEventListener('click', () => {
        window.location.href = 'https://thelo.space/settings';
    });
}
    </script>
</body>
</html>
