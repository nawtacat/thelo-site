<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>thelo – Sign In / Sign Up</title>
<link rel="icon" href="https://thelo.space/img/thelofavicon.png" type="image/png"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Noto+Serif+Armenian:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com?plugins=typography"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
:root{--thelo-blue:#2563EB;--thelo-bg:#F8F9FA;--thelo-text:#111827;--grid-color:#E5E7EB}
body{
    font-family:'Manrope',system-ui,-apple-system,'Segoe UI','Helvetica Neue',Arial,sans-serif;
    background:var(--thelo-bg);
    color:var(--thelo-text);
    background-image:
        linear-gradient(to right,var(--grid-color) 1px,transparent 1px),
        linear-gradient(to bottom,var(--grid-color) 1px,transparent 1px);
    background-size:40px 40px;
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem}
html[lang="hy"] body{font-family:'Noto Serif Armenian',serif}

.window-container{
    background:#fff;border:1px solid var(--grid-color);border-radius:.75rem;
    padding:2.5rem;box-shadow:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);
    position:relative;
    max-width:480px;
    width:100%}
.window-container::before{
    content:"";position:absolute;top:1rem;left:1rem;width:52px;height:12px;
    background-image:url("data:image/svg+xml,%3Csvg width='52' height='12' viewBox='0 0 52' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='6' cy='6' r='6' fill='%23FF5F56'/%3E%3Ccircle cx='26' cy='6' r='6' fill='%23FFBD2E'/%3E%3Ccircle cx='46' cy='6' r='6' fill='%2327C93F'/%3E%3C/svg%3E")}
.form-input{width:100%;border-radius:.5rem;border:1px solid #D1D5DB;background:#fff;
    padding:.75rem 1rem;box-shadow:0 1px 2px rgba(0,0,0,.05);
    transition:border-color .2s,box-shadow .2s}
.form-input:focus{border-color:var(--thelo-blue);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.2)}
#submitBtn{grid-column:1/-1}
.loading-spinner{border:4px solid #f3f3f3;border-top:4px solid var(--thelo-blue);
    border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;margin-left:.5rem}
@keyframes spin{to{transform:rotate(360deg)}}
.form-button:disabled{opacity:.7;cursor:not-allowed}
@media(max-width:640px){
    .fixed.top-4.left-4,.fixed.top-4.right-4{top:.5rem;font-size:.75rem;padding:.25rem .5rem}
    .fixed.top-4.left-4{left:.5rem}.fixed.top-4.right-4{right:.5rem}}

.char-option {
    cursor: pointer;
    border-radius: 9999px; /* pill shape */
    border: 3px solid transparent;
    transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out;
    background-color: #f0f0f0;
}
.char-option:hover { transform: scale(1.08); }
.char-option.selected {
    border-color: var(--thelo-blue);
    transform: scale(1.08);
    box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
}
#verificationMessageDiv { text-align: center; }

</style>
</head>

<body>
<a href="/" class="fixed top-4 left-4 text-sm font-semibold text-slate-500 hover:text-[var(--thelo-blue)]">
    <span id="homeArrow">←</span> <span id="homeLink">Home</span></a>
<button id="langToggle" class="fixed top-4 right-4 rounded-md border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-100">Հայ</button>

<div id="authWindowContainer" class="window-container">
    <div id="verificationMessageDiv" class="hidden">
        <h3 id="verificationTitle" class="text-2xl font-extrabold mb-3 text-center text-green-600"></h3>
        <p id="verificationMessage" class="text-slate-600"></p>
    </div>

    <div id="authFormContainer">
        <h2 id="formTitle" class="text-2xl font-extrabold mb-3 text-center">Sign In</h2>
        <p id="welcomeMessage" class="text-center text-sm text-slate-600 mb-6"></p>

        <form id="authForm" class="grid grid-cols-1 gap-y-4">
            <div id="fullNameDiv" class="hidden">
                <label id="labelFullName" class="block text-sm font-bold mb-1" for="fullName">Full Name</label>
                <input id="fullName" type="text" class="form-input">
            </div>

            <div id="avatarDiv" class="hidden">
                <label id="labelAvatar" class="block text-sm font-bold mb-2">Choose Your Character</label>
                <div id="avatarGrid" class="grid grid-cols-3 sm:grid-cols-6 gap-3 justify-items-center"></div>
            </div>

            <div id="emailDiv">
                <label id="labelEmail" class="block text-sm font-bold mb-1" for="email">Email</label>
                <input id="email" type="email" class="form-input" required>
            </div>

            <div id="passwordDiv">
                <label id="labelPassword" class="block text-sm font-bold mb-1" for="password">Password</label>
                <input id="password" type="password" class="form-input" required>
            </div>

            <button id="submitBtn" type="submit" class="mt-2 rounded-lg bg-[var(--thelo-blue)] px-8 py-3 font-bold text-white shadow hover:scale-105 transition-transform">
                Sign In
            </button>
        </form>

        <div class="text-center text-sm mt-6">
            <a href="#" id="toggleAuthModeLink" class="font-semibold text-[var(--thelo-blue)] hover:underline"></a>
        </div>
    </div>

    <p id="toast" class="mt-6 text-center text-sm text-red-600 hidden"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = { /* ... your config ... */ };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const TXT = {
    en: {
        home: "Home",
        signInTitle: "Sign In to thelo",
        signUpTitle: "Create Your Account",
        signInBtn: "Sign In",
        signUpBtn: "Create Account",
        welcomeMessageSignIn: "Welcome back! Please enter your details.",
        welcomeMessageSignUp: "Join thelo to start your learning journey.",
        email: "Email",
        password: "Password",
        fullName: "Full Name",
        avatar: "Choose Your Character",
        toggleToSignUp: "Don't have an account? Sign Up",
        toggleToSignIn: "Already have an account? Sign In",
        verifyTitle: "One Last Step!",
        verifyMessage: "We've sent a verification link to your email. Please check your inbox and click the link to activate your account.",
        verifyError: "Please verify your email to sign in.",
        resendLink: "Resend Email",
        resendSuccess: "A new verification email has been sent.",
        genericError: "An unexpected error occurred. Please try again.",
        emailInUse: "This email is already in use. Please sign in or use a different email.",
        weakPassword: "Password is too weak. It should be at least 6 characters.",
        invalidCredentials: "Invalid email or password. Please try again."
    },
    hy: { /* ... Armenian translations ... */ }
};

let lang = 'en';
let isSignUpMode = false;
let selectedAvatarUrl = '';

// --- DOM Element selectors ---
const langBtn = document.getElementById('langToggle');
const homeLink = document.getElementById('homeLink');
const form = document.getElementById('authForm');
const formTitle = document.getElementById('formTitle');
const welcomeMessage = document.getElementById('welcomeMessage');
const submitBtn = document.getElementById('submitBtn');
const toast = document.getElementById('toast');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const fullNameInput = document.getElementById('fullName');
const fullNameDiv = document.getElementById('fullNameDiv');
const labelEmail = document.getElementById('labelEmail');
const labelPassword = document.getElementById('labelPassword');
const labelFullName = document.getElementById('labelFullName');
const toggleAuthModeLink = document.getElementById('toggleAuthModeLink');
const avatarDiv = document.getElementById('avatarDiv');
const avatarGrid = document.getElementById('avatarGrid');
const labelAvatar = document.getElementById('labelAvatar');
const verificationMessageDiv = document.getElementById('verificationMessageDiv');
const verificationTitle = document.getElementById('verificationTitle');
const verificationMessage = document.getElementById('verificationMessage');
const authFormContainer = document.getElementById('authFormContainer');

// --- UI Functions ---
function updateFormUI() {
    const s = TXT[lang];
    formTitle.textContent = isSignUpMode ? s.signUpTitle : s.signInTitle;
    welcomeMessage.textContent = isSignUpMode ? s.welcomeMessageSignUp : s.welcomeMessageSignIn;
    submitBtn.innerHTML = isSignUpMode ? s.signUpBtn : s.signInBtn;
    toggleAuthModeLink.textContent = isSignUpMode ? s.toggleToSignIn : s.toggleToSignUp;
    fullNameDiv.classList.toggle('hidden', !isSignUpMode);
    avatarDiv.classList.toggle('hidden', !isSignUpMode);
    fullNameInput.required = isSignUpMode;
    authFormContainer.classList.remove('hidden');
    verificationMessageDiv.classList.add('hidden');
}
function applyLang() { /* ... unchanged ... */ }
function showToast(message, isError = true) {
    toast.innerHTML = message; // Use innerHTML to render the link
    toast.className = `mt-6 text-center text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
}
function hideToast() { toast.className = 'hidden'; }
function setLoading(isLoading) { /* ... unchanged ... */ }
function handleAvatarSelection(e) { /* ... unchanged ... */ }
function populateAvatars() { /* ... unchanged ... */ }

// --- UPDATED: Email sending logic with Action Code Settings ---
async function sendVerificationEmail(user) {
    // This object tells Firebase where to redirect the user after verification.
    const actionCodeSettings = {
        url: `${window.location.origin}`, // Redirects to your main page
        handleCodeInApp: true
    };
    try {
        console.log("Sending verification email...");
        await sendEmailVerification(user, actionCodeSettings);
        console.log("Verification email sent.");
    } catch (error) {
        console.error("Error sending verification email:", error);
        // Show an error to the user if sending fails.
        showToast(TXT[lang].genericError);
    }
}

// --- CORE AUTH LOGIC ---
async function handleNewUserSignUp(email, password, fullName, avatarUrl) {
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Send the verification email right after user creation
        await sendVerificationEmail(user);

        // Create Firestore document
        const nameParts = fullName.split(' ');
        await setDoc(doc(db, "thelo-students", user.uid), {
            name: nameParts[0] || '',
            surname: nameParts.slice(1).join(' ') || '',
            email: user.email,
            language: "en",
            profilePicture: avatarUrl,
            // ... other fields
        });
        
        // Show success message and hide the form
        setLoading(false);
        authFormContainer.classList.add('hidden');
        verificationMessageDiv.classList.remove('hidden');
        verificationTitle.textContent = TXT[lang].verifyTitle;
        verificationMessage.textContent = TXT[lang].verifyMessage;

    } catch (error) {
        console.error("Sign up error:", error);
        let errorMessage = TXT[lang].genericError;
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = TXT[lang].emailInUse;
        } else if (error.code === 'auth/weak-password') {
            errorMessage = TXT[lang].weakPassword;
        }
        showToast(errorMessage, true);
        setLoading(false);
    }
}

// --- Event Listeners ---
langBtn.addEventListener('click', () => { /* ... unchanged ... */ });
toggleAuthModeLink.addEventListener('click', (e) => {
    e.preventDefault();
    isSignUpMode = !isSignUpMode;
    form.reset();
    hideToast();
    selectedAvatarUrl = '';
    avatarGrid.querySelectorAll('.char-option').forEach(img => img.classList.remove('selected'));
    updateFormUI();
});

toast.addEventListener('click', async (e) => {
    if (e.target.id === 'resendVerificationLink' && auth.currentUser) {
        e.preventDefault();
        setLoading(true);
        await sendVerificationEmail(auth.currentUser);
        showToast(TXT[lang].resendSuccess, false);
        setLoading(false);
    }
});

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideToast();
    setLoading(true);
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (isSignUpMode) {
        const fullName = fullNameInput.value.trim();
        if (!fullName || !selectedAvatarUrl) {
            // ... validation ...
            setLoading(false);
            return;
        }
        await handleNewUserSignUp(email, password, fullName, selectedAvatarUrl);
    } else { // Sign In Logic
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            
            if (userCredential.user.emailVerified) {
                console.log("User signed in:", userCredential.user.uid);
                showToast("Signed in successfully! Redirecting...", false);
                setTimeout(() => { window.location.href = 'https://thelo.space/sdashboard'; }, 1500);
            } else {
                const t = TXT[lang];
                const resendLinkHTML = `<a href="#" id="resendVerificationLink" class="font-bold underline">${t.resendLink}</a>`;
                showToast(`${t.verifyError} ${resendLinkHTML}`);
                await signOut(auth);
                setLoading(false);
            }
        } catch (error) {
            console.error("Sign in error:", error);
            showToast(TXT[lang].invalidCredentials, true);
            setLoading(false);
        }
    }
});

// --- Initial Setup ---
populateAvatars();
applyLang();
</script>
</body>
</html>
